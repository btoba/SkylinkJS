/*! skylinkjs - v0.5.7 - 2015-02-13 */
function DataChannel(channel,listener){"use strict";var com=this;if(com.id=channel.label||Date.UTC(),com.type="message",com.RTCDataChannel=null,com.onopen=function(){},com.onclose=function(){},com.onerror=function(){},com.handler=function(event,data){DataChannelHandler(com,event,data,listener)},com.bind=function(bindChannel){bindChannel.onopen=function(){com.handler("datachannel:connect",{})},bindChannel.onerror=function(error){com.handler("datachannel:error",{error:error}),"function"==typeof com.onerror&&com.onerror(error)},bindChannel.onclose=function(){com.handler("datachannel:disconnect",{}),"function"==typeof com.onclose&&com.onclose()},bindChannel.onmessage=function(event){com.handler("datachannel:message",{data:event.data})},com.RTCDataChannel=bindChannel,fn.runSync(function(){com.handler("datachannel:start",{})})},com.send=function(data){var sendingData=data;"object"==typeof data&&(sendingData=JSON.stringify(data)),fn.isSafe(function(){com.RTCDataChannel.send(sendingData)})},fn.isEmpty(channel))throw new Error("Provided parameter channel is invalid.");com.bind(channel)}function DataTransfer(channel,peerId,listener){"use strict";var com=this;com.peerId=peerId,com.channel=channel,com._DC_PROTOCOL_TYPE={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},com.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},com.DATA_TRANSFER_STATE={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted"},com.DATA_TRANSFER_DATA_TYPE={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob"},com._uploadDataTransfers=[],com._uploadDataSessions=[],com._downloadDataTransfers=[],com._downloadDataSessions=[],com._dataTransfersTimeout=[],com.bind=function(bindChannel){bindChannel.RTCDataChannel.onmessage=function(event){com.onMessage(bindChannel,event.data)}},com.onMessage=function(bindChannel,data){com._dataChannelProtocolHandler(data)},com.bind(com.channel),com._dataChannelProtocolHandler=function(dataString){if("string"==typeof dataString){var data={};try{data=JSON.parse(dataString)}catch(error){return void com._DATAProtocolHandler(dataString,com.DATA_TRANSFER_DATA_TYPE.BINARY_STRING)}switch(data.type){case com._DC_PROTOCOL_TYPE.WRQ:com.WRQProtocolHandler(data);break;case com._DC_PROTOCOL_TYPE.ACK:com.ACKProtocolHandler(data);break;case com._DC_PROTOCOL_TYPE.ERROR:com.ERRORProtocolHandler(data);break;case com._DC_PROTOCOL_TYPE.CANCEL:com.CANCELProtocolHandler(data);break;case com._DC_PROTOCOL_TYPE.MESSAGE:com.MESSAGEProtocolHandler(data)}}},com._setDataChannelTimeout=function(timeout,isSender){com._dataTransfersTimeout[com.peerId]||(com._dataTransfersTimeout[com.peerId]=[]);var type=isSender?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD;com._dataTransfersTimeout[com.peerId][type]=setTimeout(function(){var name;com._dataTransfersTimeout[com.peerId][type]&&(isSender?(name=com._uploadDataSessions[com.peerId].name,delete com._uploadDataTransfers[com.peerId],delete com._uploadDataSessions[com.peerId]):(name=com._downloadDataSessions[com.peerId].name,delete com._downloadDataTransfers[com.peerId],delete com._downloadDataSessions[com.peerId]),com.channel.send({type:com._DC_PROTOCOL_TYPE.ERROR,name:name,content:"Connection Timeout. Longer than "+timeout+" seconds. Connection is abolished.",isUploadError:isSender}),com._clearDataChannelTimeout(isSender))},1e3*timeout)},com._clearDataChannelTimeout=function(isSender){if(com._dataTransfersTimeout[com.peerId]){var type=isSender?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD;clearTimeout(com._dataTransfersTimeout[com.peerId][type]),delete com._dataTransfersTimeout[com.peerId][type]}},com.WRQProtocolHandler=function(data){var transferId=com.peerId+com.DATA_TRANSFER_TYPE.DOWNLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),name=data.name,binarySize=data.size,expectedSize=data.chunkSize,timeout=data.timeout;com._downloadDataSessions[com.peerId]={transferId:transferId,name:name,size:binarySize,ackN:0,receivedSize:0,chunkSize:expectedSize,timeout:timeout},listener("datatransfer:uploadrequest",{peerId:com.peerId,transferId:transferId,name:name,size:binarySize,expectedSize:expectedSize,timeout:timeout,dataTransfer:com})},com.ACKProtocolHandler=function(data){var ackN=data.ackN;com.peerId="MCU"===com.peerId?data.sender:com.peerId;var chunksLength=com._uploadDataTransfers[com.peerId].length,uploadedDetails=com._uploadDataSessions[com.peerId],transferId=uploadedDetails.transferId,timeout=uploadedDetails.timeout;if(com._clearDataChannelTimeout(!0),ackN>-1)if(chunksLength>ackN){var fileReader=new FileReader;fileReader.onload=function(){var base64BinaryString=fileReader.result.split(",")[1];com.channel.send(base64BinaryString),com._setDataChannelTimeout(timeout,!0),listener("datatransfer:uploading",{peerId:com.peerId,transferId:transferId,percentage:((ackN+1)/chunksLength*100).toFixed()})},fileReader.readAsDataURL(com._uploadDataTransfers[com.peerId][ackN])}else ackN===chunksLength&&(listener("datatransfer:uploadcompleted",{peerId:com.peerId,transferId:transferId,name:uploadedDetails.name}),delete com._uploadDataTransfers[com.peerId],delete com._uploadDataSessions[com.peerId]);else listener("datatransfer:rejected",{peerId:com.peerId,transferId:transferId,name:com._uploadDataSessions[com.peerId].name,size:com._uploadDataSessions[com.peerId].size}),delete com._uploadDataTransfers[com.peerId],delete com._uploadDataSessions[com.peerId]},com.MESSAGEProtocolHandler=function(data){listener("datatransfer:message",{peerId:com.peerId,data:data})},com.ERRORProtocolHandler=function(data){{var isUploader=data.isUploadError;isUploader?com._uploadDataSessions[com.peerId].transferId:com._downloadDataSessions[com.peerId].transferId}listener("datatransfer:error",{peerId:com.peerId,data:data,transferType:isUploader?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD})},com._CANCELProtocolHandler=function(data){var isUpload=!!com._uploadDataSessions[com.peerId],transferId=(!!com._downloadDataSessions[com.peerId],isUpload?com._uploadDataSessions[com.peerId].transferId:com._downloadDataSessions[com.peerId].transferId);com._clearDataChannelTimeout(isUploader),listener("datatransfer:cancel",{peerId:com.peerId,transferId:transferId,name:data.name,content:data.content,senderPeerId:data.sender,transferType:isUpload?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD});try{isUpload?(delete com._uploadDataSessions[com.peerId],delete com._uploadDataTransfers[com.peerId]):(delete com._downloadDataSessions[peerId],delete com._downloadDataTransfers[peerId]),listener("datatransfer:cancel",{peerId:com.peerId,transferId:transferId,name:data.name,content:data.content,senderPeerId:data.sender,transferType:isUpload?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD})}catch(error){listener("datatransfer:error",{message:"Failed cancelling data request from peer",transferType:isUpload?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD})}},com._DATAProtocolHandler=function(dataString,dataType){var chunk,error="",transferStatus=com._downloadDataSessions[com.peerId],transferId=transferStatus.transferId;if(com._clearDataChannelTimeout(!1),dataType===com.DATA_TRANSFER_DATA_TYPE.BINARY_STRING)chunk=DataProcess.unchunk(dataString);else if(dataType===com.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER)chunk=new Blob(dataString);else{if(dataType!==com.DATA_TRANSFER_DATA_TYPE.BLOB)return error="Unhandled data exception: "+dataType,void listener("datatransfer:error",{peerId:com.peerId,transferId:transferId,message:error,transferType:com.DATA_TRANSFER_TYPE.DOWNLOAD});chunk=dataString}var receivedSize=chunk.size*(4/3);if(transferStatus.chunkSize>=receivedSize){com._downloadDataTransfers[com.peerId].push(chunk),transferStatus.ackN+=1,transferStatus.receivedSize+=receivedSize;var totalReceivedSize=transferStatus.receivedSize,percentage=(totalReceivedSize/transferStatus.size*100).toFixed();if(com.channel.send({type:com._DC_PROTOCOL_TYPE.ACK,sender:null,ackN:transferStatus.ackN}),transferStatus.chunkSize===receivedSize)listener("datatransfer:downloading",{peerId:com.peerId,transferId:transferId,percentage:percentage}),com._setDataChannelTimeout(transferStatus.timeout,!1),com._downloadDataTransfers[com.peerId].info=transferStatus;else{var blob=new Blob(com._downloadDataTransfers[com.peerId]);listener("datatransfer:downloadcompleted",{peerId:com.peerId,transferId:transferId,data:blob}),delete com._downloadDataTransfers[com.peerId],delete com._downloadDataSessions[com.peerId]}}else error="Packet not match - [Received]"+receivedSize+" / [Expected]"+transferStatus.chunkSize,listener("datatransfer:error",{peerId:com.peerId,transferId:transferId,message:error,transferType:com.DATA_TRANSFER_TYPE.DOWNLOAD})},com.sendBlobData=function(data,dataInfo){dataInfo.timeout=dataInfo.timeout||60,dataInfo.transferId=com.DATA_TRANSFER_TYPE.UPLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),com.sendBlobDataToPeer(data,dataInfo,!0),listener("datatransfer:uploadstarted",{peerId:com.peerId,transferId:dataInfo.transferId,name:dataInfo.name,size:dataInfo.size,timeout:dataInfo.timeout||60,data:data})},com.sendBlobDataToPeer=function(data,dataInfo,isPrivate){var ongoingTransfer=null,binarySize=parseInt((dataInfo.size*(4/3)).toFixed(),10),chunkSize=parseInt((DataProcess.chunkSize*(4/3)).toFixed(),10);return"firefox"===window.webrtcDetectedBrowser&&window.webrtcDetectedVersion<30&&(chunkSize=DataProcess.mozChunkSize),com._uploadDataSessions[com.peerId]?ongoingTransfer=com.DATA_TRANSFER_TYPE.UPLOAD:com._downloadDataSessions[com.peerId]&&(ongoingTransfer=com.DATA_TRANSFER_TYPE.DOWNLOAD),ongoingTransfer?void listener("datatransfer:error",{peerId:peerId,transferId:dataInfo.transferId,name:dataInfo.name,message:dataInfo.content,transferType:ongoingTransfer}):(com._uploadDataTransfers[com.peerId]=DataProcess.chunk(data,dataInfo.size),com._uploadDataSessions[com.peerId]={name:dataInfo.name,size:binarySize,transferId:dataInfo.transferId,timeout:dataInfo.timeout},com.channel.send({type:com._DC_PROTOCOL_TYPE.WRQ,agent:window.webrtcDetectedBrowser,name:dataInfo.name,size:binarySize,chunkSize:chunkSize,timeout:dataInfo.timeout,target:com.peerId,isPrivate:!!isPrivate}),void com._setDataChannelTimeout(dataInfo.timeout,!0))},com.respondBlobRequest=function(accept){if(accept){com._downloadDataTransfers[com.peerId]=[];var data=com._downloadDataSessions[com.peerId];com.channel.send({type:com._DC_PROTOCOL_TYPE.ACK,ackN:0,agent:window.webrtcDetectedBrowser}),listener("datatransfer:downloadstarted",{peerId:com.peerId,name:data.name,size:data.size,transferId:data.transferId})}else com.channel.send({type:this._DC_PROTOCOL_TYPE.ACK,ackN:-1}),delete com._downloadDataSessions[com.peerId]},com.cancelBlobTransfer=function(transferType){var data;if(transferType===com.DATA_TRANSFER_TYPE.UPLOAD&&!transferType)if(data=com._uploadDataSessions[com.peerId])delete com._uploadDataSessions[com.peerId],delete com._uploadDataTransfers[com.peerId],com.channel.send({type:com._DC_PROTOCOL_TYPE.CANCEL,name:data.name,content:"Peer cancelled upload transfer"});else if(listener("datatransfer:error",{peerId:com.peerId,transferId:dataInfo.transferId,name:dataInfo.name,message:"Unable to cancel upload transfer. There is not ongoing upload sessions with the peer",transferType:com.DATA_TRANSFER_TYPE.UPLOAD}),transferType)return;transferType===com.DATA_TRANSFER_TYPE.DOWNLOAD&&(data=com._downloadDataSessions[peerId],data?(delete com._downloadDataSessions[com.peerId],delete com._downloadDataTransfers[com.peerId],com.channel.send({type:com._DC_PROTOCOL_TYPE.CANCEL,name:data.name,content:"Peer cancelled download transfer"})):listener("datatransfer:error",{peerId:com.peerId,transferId:dataInfo.transferId,name:dataInfo.name,message:"Unable to cancel download transfer. There is not ongoing download sessions with the peer",transferType:com.DATA_TRANSFER_TYPE.DOWNLOAD}))}}function Peer(config,listener){"use strict";var com=this;if(com.id=config.id||fn.generateUID(),com.type="main"===config.id?"user":"stream",com.SDPType=null,com.constraints=null,com.localDescription=null,com.remoteDescription=null,com.datachannels={},com.iceTrickle=!0,com.healthTimer=null,com.stream=null,com.streamingConfig=config.streamingConfig||{bandwidth:{},audio:!1,video:!1,mediaStatus:{audioMuted:!0,videoMuted:!0}},com.sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},com.sdpConfig=null,com.config={optional:[{DtlsSrtpKeyAgreement:!0}]},com.RTCPeerConnection=null,com.weight=parseInt(fn.generateUID(),10),com.handler=function(event,data){return 0===event.indexOf("datatransfer")?void DataTransferHandler(com,event,data,listener):void PeerHandler(com,event,data,listener)},com.datatransfers={},com.onconnect=function(){},com.oniceconnectionstatechange=function(){},com.onicegatheringstatechange=function(){},com.onaddstream=function(){},com.onsignalingstatechange=function(){},com.onreconnect=function(){},com.onreconnect=function(){},com.ondisconnect=function(){},com.connect=function(stream){var peer=new window.RTCPeerConnection(com.constraints,com.config);(fn.isEmpty(stream)?!1:stream instanceof Stream)&&(com.stereo=fn.isSafe(function(){return stream.audio.stereo}),peer.addStream(stream.MediaStream),window.data=stream.MediaStream,com.handler("peer:stream",{sourceType:"local",stream:stream})),com.bind(peer)},com.reconnect=function(stream){var hasStream=!!stream;stream=stream||fn.isSafe(function(){return com.RTCPeerConnection.getLocalStreams()[0]}),com.RTCPeerConnection.close(),com.RTCPeerConnection=null;var peer=new window.RTCPeerConnection(com.constraints,com.config);(fn.isEmpty(stream)?!1:stream instanceof Stream)&&(com.stereo=fn.isSafe(function(){return stream.audio.stereo}),peer.addStream(stream.MediaStream),hasStream&&com.handler("peer:stream",{stream:stream}),com.handler("peer:reconnect",{})),com.bind(peer)},com.disconnect=function(){"closed"!==com.RTCPeerConnection.newSignalingState&&com.RTCPeerConnection.close(),com.handler("peer:disconnect",{})},com.bind=function(bindPeer){bindPeer.iceConnectionFiredStates=[],bindPeer.queueCandidate=[],bindPeer.newSignalingState="new",bindPeer.newIceConnectionState="new",bindPeer.datachannels={},bindPeer.ondatachannel=function(event){var eventChannel=event.channel||event,channel=new DataChannel(eventChannel,function(event,data){com.handler(event,data),"datachannel:start"===event&&com.handler("peer:datachannel",{channel:channel,sourceType:"remote"})});com.datachannels[channel.id]=channel,"main"===channel.id&&com.handler("datatransfer:start",{data:data,dataChannel:channel})},bindPeer.onaddstream=function(event){var eventStream=event.stream||event,stream=new Stream(eventStream,config.streamingConfig,function(event,data){com.handler(event,data),"stream:start"===event&&com.handler("peer:stream",{sourceType:"remote",stream:stream})})},bindPeer.onicecandidate=function(event){var eventCandidate=event.candidate||event;return fn.isEmpty(eventCandidate.candidate)?void com.handler("candidate:gathered",{candidate:eventCandidate}):void com.handler("peer:icecandidate",{sourceType:"local",candidate:eventCandidate})},bindPeer.oniceconnectionstatechange=function(){ICE.parseIceConnectionState(bindPeer)},bindPeer.oniceconnectionnewstatechange=function(){"connected"===com.RTCPeerConnection.newIceConnectionState&&(fn.isEmpty(com.healthTimer)||(log.debug("Peer",com.id,"Stopping health timer as connection is established."),clearInterval(com.healthTimer))),com.handler("peer:iceconnectionstate",{state:com.RTCPeerConnection.newIceConnectionState})},bindPeer.onsignalingstatechange=function(){com.handler("peer:signalingstate",{state:com.RTCPeerConnection.newSignalingState})},bindPeer.onicegatheringstatechange=function(){com.handler("peer:icegatheringstate",{state:com.RTCPeerConnection.iceGatheringState})},com.RTCPeerConnection=bindPeer,fn.runSync(function(){com.handler("peer:connect",{weight:com.weight,SDPType:com.SDPType,streamingConfig:com.streamingConfig})})},com.sendMessage=function(message){com.datachannels.main&&com.datachannels.main.send(message)},com.transferData=function(data){com.handler("datatransfer:start",{data:data,dataChannel:com.datachannels.main}),com.datatransfers.main.sendBlobData(data,{name:data.name,size:data.size})},com.createOffer=function(){if(globals.dataChannel&&"user"===com.type){var eventChannel=com.RTCPeerConnection.createDataChannel("main"),channel=new DataChannel(eventChannel,function(event,data){com.handler(event,data),com.handler("peer:datachannel",{sourceType:"local",channel:channel})});com.datachannels.main=channel}com.RTCPeerConnection.createOffer(function(offer){offer.sdp=SDP.configure(offer.sdp,com.sdpConfig),com.localDescription=offer,com.handler("peer:offer:success",{offer:offer})},function(error){com.handler("peer:offer:error",{error:error})},com.sdpConstraints)},com.createAnswer=function(){com.RTCPeerConnection.createAnswer(function(answer){answer.sdp=SDP.configure(answer.sdp,com.sdpConfig),com.localDescription=answer,com.handler("peer:answer:success",{answer:answer}),com.setLocalDescription()},function(error){com.handler("peer:answer:error",{error:error})},com.sdpConstraints)},com.setLocalDescription=function(){var localDescription=com.localDescription;com.RTCPeerConnection.setLocalDescription(localDescription,function(){com.handler("peer:localdescription:success",{localDescription:localDescription.sdp,type:localDescription.type}),"answer"===localDescription.type?(com.RTCPeerConnection.newSignalingState="have-local-answer",com.handler("peer:signalingstate",{state:com.RTCPeerConnection.newSignalingState})):com.setRemoteDescription()},function(error){com.handler("peer:localdescription:error",{localDescription:localDescription.sdp,type:localDescription.type,error:error})})},com.setRemoteDescription=function(){var remoteDescription=com.remoteDescription;com.RTCPeerConnection.setRemoteDescription(remoteDescription,function(){com.handler("peer:remotedescription:success",{remoteDescription:remoteDescription.sdp,type:remoteDescription.type}),"answer"===remoteDescription.type?(com.RTCPeerConnection.newSignalingState="have-remote-answer",com.handler("peer:signalingstate",{state:com.RTCPeerConnection.newSignalingState})):com.createAnswer(),ICE.popCandidate(com.RTCPeerConnection,com.handler)},function(error){com.handler("peer:remotedescription:error",{remoteDescription:remoteDescription.sdp,type:remoteDescription.type,error:error})})},!window.RTCPeerConnection)throw new Error("Required dependency adapterjs not found");com.streamingConfig.bandwidth=StreamParser.parseBandwidthConfig(com.streamingConfig.bandwidth),com.constraints=ICE.parseICEServers(config.constraints),com.sdpConfig={stereo:fn.isSafe(function(){return config.streamingConfig.audio.stereo}),bandwidth:com.bandwidth},fn.runSync(function(){com.handler("peer:start",{weight:com.weight,SDPType:com.SDPType,streamingConfig:com.streamingConfig})})}function Room(name,listener){"use strict";function Self(config){var subcom=this;subcom.id=null,subcom.data=config.data,subcom.username=config.username,subcom.timeStamp=config.timeStamp,subcom.token=config.token,subcom.streams={},subcom.agent={name:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,webRTCType:window.webrtcDetectedType},subcom.bandwidth={},subcom.handler=function(event,data){data.id=subcom.id,log.debug("SelfHandler:",event,data),RoomHandler(com,event,data,listener)},subcom.onupdate=function(){},subcom.onaddstreamconnection=function(){},subcom.onremovestreamconnection=function(){},subcom.ondisconnect=function(){},subcom.update=function(data){subcom.data=data,com.socket.send({type:"updateUserEvent",mid:subcom.id,rid:com.id,userData:subcom.data}),subcom.handler("self:update",{data:subcom.data})},subcom.addStreamConnection=function(stream,connectionId){stream.sourceType="local";var connection={id:connectionId,stream:stream};subcom.streams[connectionId]=connection,"function"==typeof subcom.onaddstreamconnection&&subcom.onaddstreamconnection(connection),subcom.handler("self:addstreamconnection",{stream:stream,connectionId:connectionId})},subcom.removeStreamConnection=function(connectionId){var stream=subcom.streams[connectionId];stream.stop(),"main"!==connectionId&&(fn.isEmpty(subcom.streams[connectionId].targetUsers)?fn.forEach(com.users,function(value){value.removeConnection(streamId)}):fn.forEach(subcom.streams[connectionId].targetUsers,function(value,key){fn.isEmpty(com.users[key])||com.users[key].removeConnection(streamId)})),"function"==typeof subcom.onremovestreamconnection&&subcom.onremovestreamconnection(stream,targetUsers),delete subcom.streams[streamId],delete subcom.streams[streamId],subcom.handler("self:removestreamconnection",{streamId:streamId})},subcom.getInfo=function(connectionId){var info={userData:subcom.data,agent:subcom.agent};if(!fn.isEmpty(connectionId)){var settings=subcom.streams[connectionId]||{},stream=settings.stream||{config:{audio:!1,video:!1,status:{audioMuted:!0,videoMuted:!0}}};return info.settings={audio:stream.config.audio,video:stream.config.video,bandwidth:subcom.bandwidth,mediaStatus:stream.config.status},info}var streaming={};fn.forEach(subcom.streams,function(connection,key){var settings=subcom.streams[connectionId]||{},stream=settings.stream||{config:{audio:!1,video:!1,status:{audioMuted:!0,videoMuted:!0}}};streaming[key]={audio:stream.config.audio,video:stream.config.video,bandwidth:subcom.bandwidth,mediaStatus:stream.config.status}},function(){return info.settings=streaming,info})},subcom.handler("self:start",config)}var com=this;com.name=name,com.id=null,com.token=null,com.key=null,com.startDateTime=null,com.duration=null,com.apiPath=null,com.owner=null,com.credentials=globals.credentials,com.self=null,com.selfData=null,com.streams={},com.users={},com.components={},com.socket=null,com.readyState=0,com.iceServers={},com.locked=!1,com.handler=function(event,data){RoomHandler(com,event,data,listener)},com.onreadystatechange=function(){},com.onjoin=function(){},com.onkick=function(){},com.onwarn=function(){},com.onlock=function(){},com.onunlock=function(){},com.onleave=function(){},com.join=function(stream,config){config=config||{},com.self.bandwidth=StreamParser.parseBandwidthConfig(config.bandwidth),com.self.data=config.userData,fn.isEmpty(stream)||com.self.addStreamConnection(stream,"main"),com.socket.connect()},com.leave=function(){com.socket.disconnect()},com.lock=function(){com.socket.send({type:"roomLockEvent",mid:com.self.id,rid:com.id,lock:!0}),com.handler("room:lock",{userId:com.self.id})},com.unlock=function(){com.socket.send({type:"roomLockEvent",mid:com.self.id,rid:com.id,lock:!1}),com.handler("room:unlock",{userId:com.self.id})},com.addStreamConnection=function(stream){var connectionId=fn.generateUID();com.self.addStreamConnection(stream,connectionId),stream.parentHandler=com.handler,fn.forEach(com.users,function(user){data.stream=stream,user.handler("message:enter",data)})};var path="/api/"+globals.apiKey+"/"+com.name;null!==com.credentials&&(path+=com.credentials.startDateTime+"/"+com.credentials.duration+"?&cred="+com.credentials.hash),globals.region&&(path+=(path.indexOf("?&")>-1?"&":"?&")+"rg="+globals.region),Request.load(path,function(status,content){com.apiPath=path,com.key=content.cid,com.id=content.room_key,com.token=content.roomCred,com.startDateTime=content.start,com.duration=content.len,com.owner=content.apiOwner,com.self=new Self({id:null,username:content.username,token:content.userCred,timeStamp:content.timeStamp,data:globals.userData}),com.socket=new Socket({server:content.ipSigserver,httpPortList:content.httpPortList,httpsPortList:content.httpsPortList},com.handler),MessageHandler(com,listener),listener("room:start",{id:com.id,name:com.name})},function(status,error){com.handler("trigger:error",{error:error,state:-1})})}function Socket(config,listener){"use strict";var com=this;if(com.server=config.server,com.protocol=globals.enforceSSL?"https:":window.location.protocol,com.port=null,com.timeout=globals.socketTimeout||0,com.messageInterval=1e3,com.messageQueue=[],com.readyState="new",com.ports={"https:":config.httpsPortList,"http:":config.httpPortList},com.config={},com.type=config.type||"WebSocket",com.Socket=null,com.responses={},com.handler=function(event,data){data.server=com.server,data.port=com.port,data.type=com.type,data.protocol=com.protocol,listener(event,data)},com.onconnect=function(){},com.ondisconnect=function(){},com.onconnecterror=function(){},com.onreconnect=function(){},com.onerror=function(){},com.connect=function(){com.port=com.ports[window.location.protocol][0],com.Socket="XHRPolling"===com.type?new com.XHRPolling:new com.WebSocket},com.disconnect=function(){com.Socket.disconnect(),com.Socket.responses={}},com.when=function(event,callback){com.responses[event]=com.responses[event]||[],com.responses[event].push(callback)},com.send=function(data){com.Socket.send(JSON.stringify(data)),com.handler("socket:send",{message:data})},com.bindOnConnect=function(){com.handler("socket:connect",{}),com.Socket.removeAllListeners(),com.Socket.on("disconnect",com.bindOnDisconnect),com.Socket.on("message",com.bindOnMessage),com.Socket.on("error",com.bindOnError),"function"==typeof com.onconnect&&com.onconnect()},com.bindOnDisonnect=function(){com.handler("socket:disconnect",{}),"function"==typeof com.onerror&&com.ondisconnect()},com.bindOnMessage=function(result){var data=JSON.parse(result);com.handler("socket:message",{message:data}),"group"===data.type?fn.forEach(function(message){com.respond(message.type,message)}):com.respond(data.type,data)},com.bindOnConnectError=function(error){com.handler("socket:connect_error",{error:error});for(var ports=com.ports[window.location.protocol],i=0;i<ports.length;i++)if(ports[i]===com.port){i+1<ports.length?(com.port=ports[i+1],com.reconnect()):"WebSocket"===com.type&&(com.type="XHRLongPolling",com.port=ports[0],com.reconnect());break}"function"==typeof com.onconnecterror&&com.onconnecterror(error)},com.bindOnError=function(error){com.handler("socket:error",{error:error}),"function"==typeof com.onerror&&com.onerror(error)},com.respond=function(type,data){com.responses[type]=com.responses[type]||[],fn.forEach(com.responses[type],function(response){response(data)})},com.reconnect=function(){switch(com.Socket.removeAllListeners(),com.type){case"WebSocket":com.Socket=com.WebSocket();break;default:com.Socket=com.XHRPolling()}"function"==typeof com.onreconnect&&com.onreconnect(com.type)},com.WebSocket=function(){var options={forceNew:!0,reconnection:!1,transports:["websocket"]};0!==com.timeout&&(options.timeout=com.timeout);var server=com.protocol+"//"+com.server+":"+com.port,socket=io.connect(server,options);return socket.on("connect",com.bindOnConnect),socket.on("connect_error",com.bindOnConnectError),socket},com.XHRPolling=function(){var ports=com.ports[window.location.protocol],options={forceNew:!0,reconnection:com.port===ports[ports.length-1],transports:["xhr-polling","jsonp-polling","polling"]};0!==com.timeout&&(options.timeout=com.timeout);var server=com.protocol+"//"+com.server+":"+com.port,socket=io.connect(server,options);return socket.on("connect",com.bindOnConnect),socket.on("reconnect",com.bindOnConnect),socket.on("connect_error",com.bindOnConnectError),socket.on("reconnect_failed",com.bindOnConnectError),socket},!window.io)throw new Error("Required dependency socket.io not found");fn.runSync(function(){com.handler("socket:start",config)})}function Stream(stream,config,listener){"use strict";var com=this;if(com.id=null,com.constraints=null,com.config=config,com.sourceType="local",com.MediaStream=null,com.parentHandler=function(){},com.handler=function(event,data){listener(event,data),"function"==typeof com.parentHandler&&com.parentHandler(event,data)},com.onstreamended=function(){},com.ontrackended=function(){},com.ontrackmute=function(){},com.ontrackunmute=function(){},com.start=function(){window.getUserMedia(com.constraints,com.bind,function(error){com.handler("stream:error",{id:com.id,error:error,sourceType:com.sourceType})})},com.bind=function(bindStream){com.id=bindStream.id||fn.generateUID(),bindStream.onended=com.bindOnStreamEnded(bindStream),bindStream.newId=com.id,com.bindTracks(bindStream.getAudioTracks()),com.bindTracks(bindStream.getVideoTracks()),com.MediaStream=bindStream,com.handler("stream:start",{id:com.id,label:bindStream.label,constraints:com.constraints,sourceType:com.sourceType})},com.bindTracks=function(bindTracks){fn.forEach(bindTracks,function(track){track.newId=track.id||fn.generateUID(),track.onended=function(){com.handler("stream:track:stop",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackended&&com.ontrackended(track)};var isEnabled=!0;isEnabled="audio"===track.kind?"object"==typeof com.config.audio?!com.config.status.audioMuted:!!com.config.audio:"object"==typeof com.config.video?!com.config.status.videoMuted:!!com.config.video,track.enabled=isEnabled,com.handler("stream:track:start",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType})})},com.attachElement=function(element){"firefox"===window.webrtcDetectedBrowser&&com.MediaStream instanceof LocalMediaStream==!1?window.reattachMediaStream(element,com.MediaStream.checkingVideo):window.attachMediaStream(element,com.MediaStream)},com.bindOnStreamEnded=function(bindStream){var fn=function(){com.handler("stream:stop",{id:com.id,label:stream.label,constraints:com.constraints,sourceType:com.sourceType}),"function"==typeof com.onended&&com.onended(bindStream)};return"firefox"===window.webrtcDetectedBrowser?bindStream.constructor===LocalMediaStream?setInterval(function(){bindStream.hasEnded&&(clearInterval(bindStream.onended),fn()),"undefined"==typeof bindStream.recordedTime&&(bindStream.recordedTime=0),bindStream.recordedTime===bindStream.currentTime?(clearInterval(bindStream.onended),fn()):bindStream.recordedTime=bindStream.currentTime},1e3):function(){var video=document.createElement("video");return video.onstreamended=setInterval(function(){bindStream.hasEnded&&(clearInterval(video.onstreamended),fn()),fn.isEmpty(video.mozSrcObject)||video.mozSrcObject.ended===!0&&(clearInterval(video.onstreamended),fn())},1e3),bindStream.checkingVideo=video,window.attachMediaStream(video,bindStream),video}():fn},com.muteAudio=function(){var tracks=com.MediaStream.getAudioTracks();fn.forEach(tracks,function(track){track.enabled=!1,com.handler("stream:track:mute",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackmute&&com.ontrackmute(track)})},com.unmuteAudio=function(){var tracks=com.MediaStream.getAudioTracks();fn.forEach(tracks,function(track){track.enabled=!0,com.handler("stream:track:unmute",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackunmute&&com.ontrackunmute(track)})},com.stopAudio=function(){var tracks=com.MediaStream.getAudioTracks();fn.forEach(tracks,function(track){track.stop(),"firefox"===window.webrtcDetectedBrowser&&track.hasEnded!==!0&&(track.onended(track),track.hasEnded=!0)},function(){"firefox"===window.webrtcDetectedBrowser&&(com.MediaStream.videoEnded===!0&&(com.MediaStream.hasEnded=!0),com.MediaStream.audioEnded=!0)})},com.muteVideo=function(){var tracks=com.MediaStream.getVideoTracks();fn.forEach(tracks,function(track){track.enabled=!1,com.handler("stream:track:mute",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackmute&&com.ontrackmute(track)})},com.unmuteVideo=function(){var tracks=com.MediaStream.getVideoTracks();
fn.forEach(tracks,function(track){track.enabled=!0,com.handler("stream:track:unmute",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackunmute&&com.ontrackunmute(track)})},com.stopVideo=function(){var tracks=com.MediaStream.getVideoTracks();fn.forEach(tracks,function(track,i){track.stop(),"firefox"===window.webrtcDetectedBrowser&&track.hasEnded!==!0&&(track.onended(tracks[i]),track.hasEnded=!0)},function(){"firefox"===window.webrtcDetectedBrowser&&(com.MediaStream.audioEnded===!0&&(com.MediaStream.hasEnded=!0),com.MediaStream.videoEnded=!0)})},com.stop=function(){com.stopVideo(),com.stopAudio(),com.MediaStream.stop()},!window.attachMediaStream)throw new Error("Required dependency adapterjs not found");if(fn.isEmpty(stream)){var audioSettings=StreamParser.parseAudioConfig(config.audio),videoSettings=StreamParser.parseVideoConfig(config.video),statusSettings=StreamParser.parseMutedConfig(config);com.constraints={audio:audioSettings.userMedia,video:videoSettings.userMedia},com.config={audio:audioSettings.settings,video:audioSettings.settings,status:statusSettings},com.start()}else fn.runSync(function(){com.config={audio:fn.isSafe(function(){return stream.getAudioTracks().length>0}),video:fn.isSafe(function(){return stream.getVideoTracks().length>0})},com.bind(stream)})}function User(config,listener){"use strict";var com=this;com.id=config.mid,com.type="user",com.data=config.userInfo.userData||{},com.agent=config.agent||{},com.peers={},com.streamingConfigs={},com.handler=function(event,data){UserHandler(com,event,data,listener)},com.onupdate=function(){},com.ondisconnect=function(){},com.onaddconnection=function(){},com.onremoveconnection=function(){},com.ondatarequest=function(){},com.ondata=function(){},com.onmessage=function(){},com.addConnection=function(data,stream){var peerConfig={id:data.prid,constraints:data.iceServers,bandwidth:data.bandwidth,streamingConfig:data.settings},peer=new Peer(peerConfig,com.handler);peer.connect(stream),peer.SDPType=data.SDPType,com.peers[peer.id]=peer},com.removeConnection=function(peerId){var peer=com.peers[peerId];fn.isEmpty(peer)||peer.disconnect()},com.disconnect=function(){fn.forEach(com.peers,function(peer){peer.disconnect()})},com.update=function(data){com.data=data,com.handler("user:update",{data:com.data})},com.getInfo=function(){var data={};return data.userData=com.data,data.agent=com.agent,data.settings=com.streamingConfigs,data},com.streamingConfigs[config.prid]=config.settings,fn.runSync(function(){com.handler("user:start",config)})}var globals={apiKey:null,region:"us2",defaultRoom:null,roomServer:"//api.temasys.com.sg",enforceSSL:!1,socketTimeout:0,TURNServer:!0,STUNServer:!0,ICETrickle:!0,TURNTransport:"any",dataChannel:!0,audioFallback:!1,credentials:null},fn={isEmpty:function(data){var isUnDefined="undefined"==typeof data||null===data;return"object"!=typeof data||isUnDefined?isUnDefined:data.constructor===Array?0===data.length:0===Object.keys(data).length},isSafe:function(unsafeFn){try{return unsafeFn()}catch(error){return log.warn("Function",error),!1}},runSync:function(){var args=Array.prototype.slice.call(arguments),run=function(fn){setTimeout(fn,1),args.splice(0,1),0!==args.length&&run(args[0])};run(args[0])},clone:function(obj){if(this.isEmpty(obj)||"object"!=typeof obj)return obj;var copy=obj.constructor();for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=obj[attr]);return copy},constant:function(main,property,value){var obj={};obj[property]={value:value,enumerable:!0},Object.defineProperties(main,obj)},generateUID:function(){return(new Date).getTime().toString()},applyHandler:function(callee,params,args){var i,item=callee;for(i=0;i<params.length;i+=1)fn.isEmpty(item[params[i]])||(item=item[params[i]]);"function"==typeof item&&item.apply(this,args)},forEach:function(main,deferItem,deferFin){if("object"==typeof main&&!fn.isEmpty(main)){if(main.constructor===Array){var i;for(i=0;i<main.length;i+=1)deferItem(main[i],i)}else{var key;for(key in main)main.hasOwnProperty(key)&&deferItem(main[key],key)}"function"==typeof deferFin&&deferFin()}}},log={};window.console.newDebug="function"!=typeof window.console.debug?window.console.log:window.console.debug,window.console.newTrace="function"!=typeof window.console.trace?window.console.log:window.console.trace;var LogKey="Skylink - ",Debugger={level:2,trace:!1,store:!1,logs:[],console:{log:window.console.log.bind(window.console,LogKey+"<<%s>> %s"),error:window.console.error.bind(window.console,LogKey+"<<%s>> %s"),info:window.console.info.bind(window.console,("safari"===window.webrtcDetectedBrowser?"INFO: ":"")+LogKey+"<<%s>> %s"),warn:window.console.warn.bind(window.console,LogKey+"<<%s>> %s"),debug:window.console.newDebug.bind(window.console,("function"!=typeof window.console.debug?"DEBUG: ":"")+LogKey+"<<%s>> %s")},traceTemplate:{log:"==LOG== "+LogKey+"%s",error:"==ERROR== "+LogKey+"%s",info:"==INFO== "+LogKey+"%s",warn:"==WARN== "+LogKey+"%s",debug:"==DEBUG== "+LogKey+"%s"},applyConsole:function(type){var args=Array.prototype.slice.call(arguments);return args.shift(),this.store&&logs.push(type,args,new Date),this.trace?window.console.newTrace.bind(window.console,this.traceTemplate[type]):this.console[type]},setLevel:function(inputLevel){log.debug=inputLevel>3?this.applyConsole("debug"):function(){},log.log=inputLevel>2?this.applyConsole("log"):function(){},log.info=inputLevel>1?this.applyConsole("info"):function(){},log.warn=inputLevel>0?this.applyConsole("warn"):function(){},log.error=inputLevel>-1?this.applyConsole("error"):function(){},this.level=inputLevel},configure:function(options){options=options||{},Debugger.store=!!options.store,Debugger.trace=!!options.trace,Debugger.setLevel("number"==typeof options.level?options.level:2)}};Debugger.setLevel(4);var Skylink={},rooms=[],Config=function(options){globals.apiKey=options.apiKey};Skylink.init=function(apiKey,name,listener){return rooms[name]=new Room(name,listener),rooms[name]},Skylink.DATA_CHANNEL_STATE={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error"},Skylink.DATA_TRANSFER_DATA_TYPE={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob"},Skylink.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},Skylink.DATA_TRANSFER_STATE={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted"},Skylink.CANDIDATE_GENERATION_STATE={NEW:"new",GATHERING:"gathering",COMPLETED:"completed"},Skylink.ICE_CONNECTION_STATE={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},Skylink.TURN_TRANSPORT={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none"},Skylink.PEER_CONNECTION_STATE={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",CLOSED:"closed"},Skylink.HANDSHAKE_PROGRESS={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ERROR:"error"},Skylink.SYSTEM_ACTION={WARNING:"warning",REJECT:"reject"},Skylink.SYSTEM_ACTION_REASON={FAST_MESSAGE:"fastmsg",ROOM_LOCKED:"locked",ROOM_FULL:"roomfull",DUPLICATED_LOGIN:"duplicatedLogin",SERVER_ERROR:"serverError",VERIFICATION:"verification",EXPIRED:"expired",ROOM_CLOSED:"roomclose",ROOM_CLOSING:"toclose",OVER_SEAT_LIMIT:"seatquota"},Skylink.READY_STATE_CHANGE={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},Skylink.READY_STATE_CHANGE_ERROR={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NOT_ENOUGH_CREDIT:4007,API_NOT_ENOUGH_PREPAID_CREDIT:4008,API_FAILED_FINDING_PREPAID_CREDIT:4009,API_NO_MEETING_RECORD_FOUND:4010,ROOM_LOCKED:5001,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,INVALID_XMLHTTPREQUEST_STATUS:5,SCRIPT_ERROR:6},Skylink.REGIONAL_SERVER={APAC1:"sg",US1:"us2"},Skylink.LOG_LEVEL={DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0},Skylink.SOCKET_ERROR={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},Skylink.SOCKET_FALLBACK={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},Skylink.VIDEO_RESOLUTION={QQVGA:{width:160,height:120,aspectRatio:"4:3"},HQVGA:{width:240,height:160,aspectRatio:"3:2"},QVGA:{width:320,height:180,aspectRatio:"4:3"},WQVGA:{width:384,height:240,aspectRatio:"16:10"},HVGA:{width:480,height:320,aspectRatio:"3:2"},VGA:{width:640,height:360,aspectRatio:"4:3"},WVGA:{width:768,height:480,aspectRatio:"16:10"},FWVGA:{width:854,height:480,aspectRatio:"16:9"},SVGA:{width:800,height:600,aspectRatio:"4:3"},DVGA:{width:960,height:640,aspectRatio:"3:2"},WSVGA:{width:1024,height:576,aspectRatio:"16:9"},HD:{width:1280,height:720,aspectRatio:"16:9"},HDPLUS:{width:1600,height:900,aspectRatio:"16:9"},FHD:{width:1920,height:1080,aspectRatio:"16:9"},QHD:{width:2560,height:1440,aspectRatio:"16:9"},WQXGAPLUS:{width:3200,height:1800,aspectRatio:"16:9"},UHD:{width:3840,height:2160,aspectRatio:"16:9"},UHDPLUS:{width:5120,height:2880,aspectRatio:"16:9"},FUHD:{width:7680,height:4320,aspectRatio:"16:9"},QUHD:{width:15360,height:8640,aspectRatio:"16:9"}};var DataChannelEventResponseHandler={start:function(){},connect:function(){},error:function(){},message:function(){},disconnect:function(){}},DataChannelHandler=function(com,event,data,listener){var params=event.split(":");data.id=com.id,fn.applyHandler(DataChannelEventResponseHandler,params,[com,data,listener]),listener(event,data)},DataProcess={chunkSize:49152,mozChunkSize:16384,chunk:function(blob,blobByteSize){var chunksArray=[],startCount=0,endCount=0;if(blobByteSize>this.chunkSize){for(;blobByteSize-1>endCount;)endCount=startCount+this.chunkSize,chunksArray.push(blob.slice(startCount,endCount)),startCount+=this.chunkSize;blobByteSize-(startCount+1)>0&&chunksArray.push(blob.slice(startCount,blobByteSize-1))}else chunksArray.push(blob);return chunksArray},unchunk:function(dataURL){for(var byteString=atob(dataURL.replace(/\s\r\n/g,"")),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),j=0;j<byteString.length;j++)ia[j]=byteString.charCodeAt(j);return new Blob([ab])}};DataTransferEventResponseHandler={start:function(com,data,listener){var dt=new DataTransfer(data.dataChannel,com.id,listener);com.datatransfers[data.dataChannel.id]=dt}};var DataTransferHandler=function(com,event,data,listener){var params=event.split(":");data.id=com.id,fn.applyHandler(DataTransferEventResponseHandler,params,[com,data,listener]),listener(event,data)},_Event={listeners:{on:{},once:{}},timestamp:{now:Date.now()||function(){return+new Date}},on:function(event,listener){this.listeners.on[event]=this.listeners.on[event]||[],this.listeners.on[event].push(listener)},once:function(event,listener){this.listeners.once[event]=this.listeners.once[event]||[],this.listeners.once[event].push(listener)},off:function(event,listener){return fn.isEmpty(event)?(this.listeners.on={},void(this.listeners.once={})):void("function"==typeof listener?(this.remove(this.listeners.on[event]||{},listener),this.remove(this.listeners.once[event]||{},listener)):(this.listeners.on[event]=[],this.listeners.once[event]=[]))},respond:function(event){var args=Array.prototype.slice.call(arguments);args.shift();var on=this.listeners.on[event]||{},once=this.listeners.once[event]||{};this.trigger(on,args),this.trigger(once,args),this.listeners.once[event]=[]},trigger:function(listeners,args){var i;for(i=0;i<listeners.length;i+=1)try{listeners[i].apply(this,args)}catch(error){throw error}},remove:function(listeners,listener){var i=0;for(i=0;i<listeners.length;i+=1)if(listeners[i]===listener){listeners.splice(i,1);break}},throttle:function(defer,wait){return function(){fn.isEmpty(this.timeStamp.func)&&(this.timeStamp.func=this.timestamp.now-wait);var now=Date.now();now-this.timestamp.func<wait||(func.apply(this,arguments),this.timeStamp.func=now)}}};Skylink.Event=_Event;var EventList=["channelOpen","channelClose","channelMessage","channelError","channelRetry","socketError","readyStateChange","handshakeProgress","candidateGenerationState","peerConnectionState","peerConnectionHealth","iceConnectionState","mediaAccessError","mediaAccessSuccess","mediaAccessRequired","mediaAccessStopped","peerJoined","peerRestart","peerUpdated","peerLeft","presenceChanged","incomingStream","incomingMessage","roomLock","dataChannelState","dataTransferState","systemAction"],ICE={newIceConnectionStates:{starting:"starting",checking:"checking",connected:"connected",completed:"connected",done:"completed",disconnected:"disconnected",failed:"failed",closed:"closed"},queueCandidate:function(peer,candidate){peer.queueCandidate=peer.queueCandidate||[],peer.queueCandidate.push(candidate)},popCandidate:function(peer,defer){peer.queueCandidate=peer.queueCandidate||[];var i;for(peer.queueCandidate.forEach(function(candidate){var type=candidate.candidate.split(" ")[7];peer.addIceCandidate(candidate,function(){defer("candidate:success",{candidate:candidate,type:type})},function(error){defer("candidate:error",{candidate:candidate,type:type,error:error})})}),i=0;i<peer.queueCandidate.length;i+=1){var candidate=peer.queueCandidate[i];defer(candidate)}peer.queueCandidate=[]},addCandidate:function(peer,candidate,defer){if(fn.isEmpty(candidate.candidate))return defer("candidate:gathered",candidate);if(fn.isEmpty(peer.remoteDescription))this.queueCandidate(peer,candidate,defer);else{var type=candidate.candidate.split(" ")[7];peer.addIceCandidate(candidate,function(){defer("candidate:success",{candidate:candidate,type:type})},function(error){defer("candidate:error",{candidate:candidate,type:type,error:error})})}},parseIceConnectionState:function(peer){var state=peer.iceConnectionState,checkState=this.newIceConnectionStates[state];peer.iceConnectionFiredStates&&"disconnected"!==checkState&&"failed"!==checkState&&"closed"!==checkState||(peer.iceConnectionFiredStates=[]);var newState=this.newIceConnectionStates[state];peer.iceConnectionFiredStates.indexOf(newState)<0&&(peer.iceConnectionFiredStates.push(newState),"connected"===newState&&setTimeout(function(){peer.iceConnectionFiredStates.push("done"),peer.newIceConnectionState="completed",peer.oniceconnectionnewstatechange(peer)},1e3),peer.newIceConnectionState=newState,peer.oniceconnectionnewstatechange(peer))},parseICEServers:function(constraints){return constraints},parseSTUNServers:function(constraints){return constraints},parseTURNServers:function(constraints){return constraints}},PeerEventReceivedHandler={stream:{stop:function(com){"main"!==com.id&&com.disconnect()}}},PeerEventResponseHandler={connect:function(com){"function"==typeof com.onconnect&&com.onconnect(com.id)},reconnect:function(com){"function"==typeof com.onreconnect&&com.onreconnect()},disconnect:function(com){"function"==typeof com.ondisconnect&&com.ondisconnect()},stream:function(com,data){data.stream.sourceType=data.sourceType,"remote"===data.sourceType&&(com.stream=data.stream),"function"==typeof com.onaddstream&&com.onaddstream(data.stream)},iceconnectionstate:function(com,data){"function"==typeof com.oniceconnectionstatechange&&com.oniceconnectionstatechange(data.state)},icegatheringstate:function(com,data){"function"==typeof com.onicegatheringstatechange&&com.onicegatheringstatechange(data.state)},icecandidate:function(){},signalingstate:function(com,data){"function"==typeof com.onsignalingstatechange&&com.onsignalingstatechange(data.state)},datachannel:function(com,data){data.channel.sourceType=data.sourceType,com.datachannels[data.channel.id]=data.channel,"function"==typeof com.ondatachannel&&com.ondatachannel(data.channel)}},PeerEventMessageHandler={offer:function(com,data){com.remoteDescription=new window.RTCSessionDescription(data),com.handler("peer:offer",{sourceType:"remote",offer:com.remoteDescription}),com.setRemoteDescription()},answer:function(com,data){com.remoteDescription=new window.RTCSessionDescription(data),com.handler("peer:answer",{sourceType:"remote",answer:com.remoteDescription}),com.setLocalDescription()},candidate:function(com,data){var candidate=new window.RTCIceCandidate({sdpMLineIndex:data.label,candidate:data.candidate,sdpMid:data.id,label:data.label,id:data.id});ICE.addCandidate(com.RTCPeerConnection,candidate,com.handler),com.handler("peer:icecandidate",{sourceType:"remote",candidate:candidate})},restart:function(){},muteAudioEvent:function(com,data){data.muted?com.stream.muteAudio():com.stream.muteVideo()},muteVideoEvent:function(com,data){data.muted?com.stream.unmuteAudio():com.stream.unmuteVideo()}},PeerHandler=function(com,event,data,listener){var params=event.split(":");0===event.indexOf("message:")?fn.applyHandler(PeerEventMessageHandler,params,[com,data,listener]):(0===event.indexOf("peer:")?(data.id=com.id,fn.applyHandler(PeerEventResponseHandler,params,[com,data,listener])):(data.peerId=com.id,fn.applyHandler(PeerEventReceivedHandler,params,[com,data,listener])),listener(event,data))},Request={server:globals.roomServer||"//api.temasys.this.sg",isXDomainRequest:"IE"===window.webrtcDetectedBrowser&&(9===window.webrtcDetectedVersion||8===window.webrtcDetectedVersion)&&"function"==typeof window.XDomainRequest,protocol:globals.enforceSSL?"https:":window.location.protocol,load:function(path,deferSuccess,deferError){var xhr=null;this.isXDomainRequest?(xhr=new XDomainRequest,xhr.setContentType=function(contentType){xhr.contentType=contentType}):(xhr=new window.XMLHttpRequest,xhr.setContentType=function(contentType){xhr.setRequestHeader("Content-type",contentType)}),xhr.onload=function(){var response=xhr.responseText||xhr.response,status=xhr.status||200;log.info("Request","Received response from API server",response,status);try{response=JSON.parse(response||"{}")}catch(error){throw error}200===status?deferSuccess(status,response):deferError(status,response)},xhr.onerror=function(error){throw error},xhr.onprogress=function(){log.log("Request","Request load in progress")},xhr.open("GET",this.protocol+this.server+path,!0),xhr.send()}},RoomEventReceivedHandler={socket:{connect:function(com){com.socket.send({type:"joinRoom",uid:com.self.username,cid:com.key,rid:com.id,userCred:com.self.token,timeStamp:com.self.timeStamp,apiOwner:com.owner,roomCred:com.token,start:com.startDateTime,len:com.duration})},disconnect:function(com){com.handler("room:leave",{}),"function"==typeof com.onleave&&com.onleave()},error:function(com,data){com.handler("room:error",{error:data,state:-2})}},user:{start:function(com,data){var user=com.users[data.mid],connection=com.self.streams[data.prid];fn.isEmpty(connection)||(data.stream=connection.stream),data.iceServers=com.iceServers,user.handler("message:"+data.type,data)}},peer:{connect:function(com,data){{var user=com.users[data.userId];user.getInfo()}"answer"===data.SDPType&&com.socket.send({type:"welcome",mid:com.self.id,rid:com.id,prid:data.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,webRTCType:window.webrtcDetectedType,userInfo:com.self.getInfo(data.id),target:data.userId,weight:data.weight})},offer:{success:function(com,data){com.socket.send({type:"offer",sdp:data.offer.sdp,prid:data.id,mid:com.self.id,target:data.userId,rid:com.id})}},answer:{success:function(com,data){com.socket.send({type:"answer",sdp:data.answer.sdp,prid:data.id,mid:com.self.id,target:data.userId,rid:com.id})}},icecandidate:function(com,data){"local"===data.sourceType&&com.socket.send({type:"candidate",label:data.candidate.sdpMLineIndex,id:data.candidate.sdpMid,candidate:data.candidate.candidate,mid:com.self.id,prid:data.id,target:data.userId,rid:com.id})}}},RoomEventResponseHandler={error:function(com,data){com.readyState=data.state,com.handler("room:error",{error:data.error,state:data.state}),"function"==typeof com.onerror&&com.onerror({error:data.error,state:data.state})}},RoomHandler=function(com,event,data,listener){var params=event.split(":");0===event.indexOf("room:")?(data.name=com.name,fn.applyHandler(RoomEventResponseHandler,params,[com,data,listener])):(data.roomName=com.name,fn.applyHandler(RoomEventReceivedHandler,params,[com,data,listener])),listener(event,data),log.debug("RoomHandler",event,data)},MessageHandlerEvent={inRoom:function(com,data){com.self.id=data.sid,com.iceServers=data.pc_config,com.socket.send({type:"enter",mid:com.self.id,rid:com.id,prid:"main",agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,webRTCType:window.webrtcDetectedType,userInfo:com.self.getInfo("main")}),com.handler("room:join",{userId:com.self.id,user:com.self,isSelf:!0}),"function"==typeof com.onjoin&&com.onjoin(data.mid)},enter:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)&&(user=new User(data,com.handler),com.users[data.mid]=user)},welcome:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)&&(user=new User(data,com.handler),com.users[data.mid]=user)},offer:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:offer",data)},answer:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:answer",data)},candidate:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:candidate",data)},updateUserEvent:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:updateUserEvent",data.userData)},muteAudioEvent:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:muteAudioEvent",data)},muteVideoEvent:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:muteVideoEvent",data)},roomLockEvent:function(com,data){com.locked=data.lock,com.locked?"function"==typeof com.onlock&&com.onlock(data.mid):"function"==typeof com.onunlock&&com.onunlock(data.mid)},restart:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:restart",data)},redirect:function(com,data){"reject"===data.action&&"function"==typeof com.onkick&&(com.onkick({message:data.info,reason:data.reason}),com.leave()),"warning"===data.action&&"function"==typeof com.onwarn&&com.onwarn({message:data.info,reason:data.reason})},bye:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.disconnect()}},MessageHandler=function(com,listener){fn.forEach(MessageHandlerEvent,function(response,event){com.socket.when(event,function(data){response(com,data,listener)})})},SDP={find:function(sdpLines,condition){var i,j;for(i=0;i<sdpLines.length;i+=1)for(j=0;j<condition.length;j+=1)if(sdpLines[i]=sdpLines[i]||"",0===sdpLines[i].indexOf(condition[j]))return[i,sdpLines[i]];return[]},addStereo:function(sdpLines){var opusLineFound=!1,opusPayload=0,rtpmapLine=this.find(sdpLines,["a=rtpmap:"]);if(rtpmapLine.length&&0===rtpmapLine[1].split(" ")[1].indexOf("opus/48000/")&&(opusLineFound=!0,opusPayload=rtpmapLine[1].split(" ")[0].split(":")[1]),opusLineFound){var fmtpLine=this.find(sdpLines,["a=fmtp:"+opusPayload]);fmtpLine.length&&(sdpLines[fmtpLine[0]]=fmtpLine[1]+"; stereo=1")}return sdpLines},setBitrate:function(sdpLines,bandwidth){var maLineFound=this.find(sdpLines,["m=","a="]).length,cLineFound=this.find(sdpLines,["c="]).length;if(maLineFound&&cLineFound){if(bandwidth.audio){var audioLine=this.find(sdpLines,["a=audio","m=audio"]);fn.isEmpty(audioLine)||sdpLines.splice(audioLine[0],1,audioLine[1],"b=AS:"+bandwidth.audio)}if(bandwidth.video){var videoLine=this.find(sdpLines,["a=video","m=video"]);fn.isEmpty(videoLine)||sdpLines.splice(videoLine[0],1,videoLine[1],"b=AS:"+bandwidth.video)}if(bandwidth.data&&this._enableDataChannel){var dataLine=this.find(sdpLines,["a=application","m=application"]);fn.isEmpty(dataLine)||sdpLines.splice(dataLine[0],1,dataLine[1],"b=AS:"+bandwidth.data)}}return sdpLines},setResolution:function(sdpLines){var video=this._streamSettings.video,frameRate=video.frameRate||50,resolution=video.resolution||{},fmtpLine=this.find(sdpLines,["a=fmtp:"]);return fmtpLine.length&&sdpLines.splice(fmtpLine[0],1,fmtpLine[1]+";max-fr="+frameRate+";max-recv-width="+(resolution.width?resolution.width:640)+";max-recv-height="+(resolution.height?resolution.height:480)),sdpLines},removeH264Support:function(sdpLines){var invalidLineIndex=sdpLines.indexOf("a=fmtp:0 profile-level-id=0x42e00c;packetization-mode=1");return invalidLineIndex>-1&&(log.debug("Firefox H264 invalid pref found:",invalidLineIndex),sdpLines.splice(invalidLineIndex,1)),sdpLines},configure:function(sdp,config){var sdpLines=sdp.split("\r\n");return sdpLines=this.removeH264Support(sdpLines),config.stereo&&(sdpLines=this.addStereo(sdpLines)),config.bandwidth&&(sdpLines=this.setBitrate(sdpLines,config.bandwidth)),sdpLines.join("\r\n")}},StreamParser={defaultConfig:{audio:{stereo:!1},video:{resolution:{width:640,height:480},frameRate:50},bandwidth:{audio:50,video:256,data:1638400}},parseAudioConfig:function(options){options="object"==typeof options?options:!!options;var userMedia=!1,tempOptions={};return options!==!1&&(options="boolean"==typeof options?{}:options,tempOptions.stereo=!!options.stereo,tempOptions.sourceId=options.sourceId,options=tempOptions),userMedia="object"==typeof options?!0:options,tempOptions.sourceId&&tempOptions.audio!==!1&&(userMedia={optional:[{sourceId:tempOptions.sourceId}]}),{settings:options,userMedia:userMedia}},parseVideoConfig:function(options){options="object"==typeof options?options:!!options;var userMedia=!1,tempOptions={};return options!==!1&&(options="boolean"==typeof options?{resolution:{}}:options,options.resolution=options.resolution||{},tempOptions.resolution=tempOptions.resolution||{},tempOptions.resolution.width=options.resolution.width||this.defaultConfig.video.resolution.width,tempOptions.resolution.height=options.resolution.height||this.defaultConfig.video.resolution.height,tempOptions.frameRate=options.frameRate||this.defaultConfig.video.frameRate,tempOptions.sourceId=options.sourceId,options=tempOptions,userMedia={mandatory:{maxWidth:tempOptions.resolution.width,maxHeight:tempOptions.resolution.height,maxFrameRate:tempOptions.frameRate},optional:[]},tempOptions.sourceId&&(userMedia.optional[0]={sourceId:tempOptions.sourceId}),"plugin"===window.webrtcDetectedType&&delete userMedia.mandatory.maxFrameRate),{settings:options,userMedia:userMedia}},parseBandwidthConfig:function(options){return options="object"==typeof options?options:{},options.audio="number"==typeof options.audio?options.audio:this.defaultConfig.bandwidth.audio,options.video="number"==typeof options.video?options.video:this.defaultConfig.bandwidth.video,options.data="number"==typeof options.data?options.data:this.defaultConfig.bandwidth.data,options},parseMutedConfig:function(options){options="object"==typeof options?options:{audio:!1,video:!1};var updateAudioMuted="object"==typeof options.audio?!!options.audio.mute:!options.audio,updateVideoMuted="object"==typeof options.video?!!options.video.mute:!options.video;return{audioMuted:updateAudioMuted,videoMuted:updateVideoMuted}},parseDefaultConfig:function(options){options=options||{},log.debug("Parsing stream settings. Default stream options:",options),options.maxWidth="number"==typeof options.maxWidth?options.maxWidth:640,options.maxHeight="number"==typeof options.maxHeight?options.maxHeight:480,this.defaultConfig.video.resolution.width=options.maxWidth,this.defaultConfig.video.resolution.height=options.maxHeight,log.debug("Parsed default media stream settings",this.defaultConfig)}},StreamTrackList={audio:[],video:[],get:function(defer){"firefox"===window.webrtcDetectedBrowser?StreamTrackList.readyState="done":MediaStreamTrack.getSources(function(trackList){fn.forEach(trackList,function(track,i){var data={};data.label=track.label||track.kind+"_"+(i+1),data.kind=track.kind,data.id=track.id,data.facing=track.facing,"audio"===track.kind?StreamTrackList.audio.push(data):StreamTrackList.video.push(data)},function(){defer({audio:StreamTrackList.audio,video:StreamTrackList.video})})})}},UserEventReceivedHandler={peer:{connect:function(com,data){var peer=com.peers[data.id];"function"==typeof com.onaddconnection&&com.onaddconnection(peer),"offer"===peer.SDPType&&peer.createOffer()},iceconnectionstate:function(com,data){"main"===data.id&&"connected"===data.state&&com.handler("user:connect",{})},disconnect:function(com,data){var peer=com.peers[data.id];delete com.peers[data.id],"function"==typeof com.onremoveconnection&&com.onremoveconnection(peer),0===Object.keys(com.peers).length&&com.handler("user:disconnect",{})}},transfer:{complete:function(com,data){com.handler("user:data",data)},request:function(com,data){com.handler("user:datarequest",data)}}},UserEventResponseHandler={connect:function(com){"function"==typeof com.onconnect&&com.onconnect()},data:function(com){"function"==typeof com.ondata&&com.ondata()},datarequest:function(com){"function"==typeof com.ondatarequest&&com.ondatarequest()},update:function(com,data){"function"==typeof com.onupdate&&com.onupdate(data.data)},message:function(com){"function"==typeof com.onmessage&&com.onmessage()},disconnect:function(com){"function"==typeof com.ondisconnect&&com.ondisconnect()}},UserEventMessageHandler={enter:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)&&(data.bandwidth=com.bandwidth,data.SDPType="answer",com.addConnection(data,data.stream))},welcome:function(com,data){var peer=com.peers[data.prid];if(fn.isEmpty(peer))data.bandwidth=com.bandwidth,com.addConnection(data,data.stream),peer=com.peers[data.prid],peer.SDPType="offer";else{if(peer.weight<data.weight)return;peer.SDPType="offer",data.type="start"}},offer:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:offer",data)},answer:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:answer",data)},candidate:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:candidate",data)},restart:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:restart",data)},updateUserEvent:function(com,data){com.data=data.data,com.handler("user:update",{data:data.userData})},muteAudioEvent:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:muteAudioEvent",data)},muteVideoEvent:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:muteVideoEvent",data)}},UserHandler=function(com,event,data,listener){var params=event.split(":");0===event.indexOf("message:")?fn.applyHandler(UserEventMessageHandler,params,[com,data,listener]):(0===event.indexOf("user:")?(data.id=com.id,fn.applyHandler(UserEventResponseHandler,params,[com,data,listener])):(data.userId=com.id,fn.applyHandler(UserEventReceivedHandler,params,[com,data,listener])),listener(event,data))};