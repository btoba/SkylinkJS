/*! skylinkjs - v0.5.7 - 2015-02-12 */
function DataChannel(channel,listener){"use strict";var com=this;if(com.id=channel.label||Date.UTC(),com.type="message",com.RTCDataChannel=null,com.onopen=function(){},com.onclose=function(){},com.onerror=function(){},com.handler=function(event,data){DataChannelHandler(com,event,data,listener)},com.bind=function(bindChannel){bindChannel.onopen=function(){com.handler("datachannel:connect",{})},bindChannel.onerror=function(error){com.handler("datachannel:error",{error:error}),"function"==typeof com.onerror&&com.onerror(error)},bindChannel.onclose=function(){com.handler("datachannel:disconnect",{}),"function"==typeof com.onclose&&com.onclose()},bindChannel.onmessage=function(event){com.handler("datachannel:message",{data:event.data})},com.RTCDataChannel=bindChannel,fn.runSync(function(){com.handler("datachannel:start",{})})},com.send=function(data){var sendingData=data;"object"==typeof data&&(sendingData=JSON.stringify(data)),fn.isSafe(function(){com.RTCDataChannel.send(sendingData)})},fn.isEmpty(channel))throw new Error("Provided parameter channel is invalid.");com.bind(channel)}function DataTransfer(channel,peerId,listener){"use strict";var com=this;com.peerId=peerId,com.channel=channel,com._DC_PROTOCOL_TYPE={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},com.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},com.DATA_TRANSFER_STATE={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted"},com.DATA_TRANSFER_DATA_TYPE={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob"},com._uploadDataTransfers=[],com._uploadDataSessions=[],com._downloadDataTransfers=[],com._downloadDataSessions=[],com._dataTransfersTimeout=[],com.bind=function(bindChannel){bindChannel.RTCDataChannel.onmessage=function(event){com.onMessage(bindChannel,event.data)}},com.onMessage=function(bindChannel,data){com._dataChannelProtocolHandler(data)},com.bind(com.channel),com._dataChannelProtocolHandler=function(dataString){if("string"==typeof dataString){var data={};try{data=JSON.parse(dataString)}catch(error){return void com._DATAProtocolHandler(dataString,com.DATA_TRANSFER_DATA_TYPE.BINARY_STRING)}switch(data.type){case com._DC_PROTOCOL_TYPE.WRQ:com.WRQProtocolHandler(data);break;case com._DC_PROTOCOL_TYPE.ACK:com.ACKProtocolHandler(data);break;case com._DC_PROTOCOL_TYPE.ERROR:com.ERRORProtocolHandler(data);break;case com._DC_PROTOCOL_TYPE.CANCEL:com.CANCELProtocolHandler(data);break;case com._DC_PROTOCOL_TYPE.MESSAGE:com.MESSAGEProtocolHandler(data)}}},com._setDataChannelTimeout=function(timeout,isSender){com._dataTransfersTimeout[com.peerId]||(com._dataTransfersTimeout[com.peerId]=[]);var type=isSender?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD;com._dataTransfersTimeout[com.peerId][type]=setTimeout(function(){var name;com._dataTransfersTimeout[com.peerId][type]&&(isSender?(name=com._uploadDataSessions[com.peerId].name,delete com._uploadDataTransfers[com.peerId],delete com._uploadDataSessions[com.peerId]):(name=com._downloadDataSessions[com.peerId].name,delete com._downloadDataTransfers[com.peerId],delete com._downloadDataSessions[com.peerId]),com.channel.send({type:com._DC_PROTOCOL_TYPE.ERROR,name:name,content:"Connection Timeout. Longer than "+timeout+" seconds. Connection is abolished.",isUploadError:isSender}),com._clearDataChannelTimeout(isSender))},1e3*timeout)},com._clearDataChannelTimeout=function(isSender){if(com._dataTransfersTimeout[com.peerId]){var type=isSender?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD;clearTimeout(com._dataTransfersTimeout[com.peerId][type]),delete com._dataTransfersTimeout[com.peerId][type]}},com.WRQProtocolHandler=function(data){var transferId=com.peerId+com.DATA_TRANSFER_TYPE.DOWNLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),name=data.name,binarySize=data.size,expectedSize=data.chunkSize,timeout=data.timeout;com._downloadDataSessions[com.peerId]={transferId:transferId,name:name,size:binarySize,ackN:0,receivedSize:0,chunkSize:expectedSize,timeout:timeout},listener("datatransfer:uploadrequest",{peerId:com.peerId,transferId:transferId,name:name,size:binarySize,expectedSize:expectedSize,timeout:timeout,dataTransfer:com})},com.ACKProtocolHandler=function(data){var ackN=data.ackN;com.peerId="MCU"===com.peerId?data.sender:com.peerId;var chunksLength=com._uploadDataTransfers[com.peerId].length,uploadedDetails=com._uploadDataSessions[com.peerId],transferId=uploadedDetails.transferId,timeout=uploadedDetails.timeout;if(com._clearDataChannelTimeout(!0),ackN>-1)if(chunksLength>ackN){var fileReader=new FileReader;fileReader.onload=function(){var base64BinaryString=fileReader.result.split(",")[1];com.channel.send(base64BinaryString),com._setDataChannelTimeout(timeout,!0),listener("datatransfer:uploading",{peerId:com.peerId,transferId:transferId,percentage:((ackN+1)/chunksLength*100).toFixed()})},fileReader.readAsDataURL(com._uploadDataTransfers[com.peerId][ackN])}else ackN===chunksLength&&(listener("datatransfer:uploadcompleted",{peerId:com.peerId,transferId:transferId,name:uploadedDetails.name}),delete com._uploadDataTransfers[com.peerId],delete com._uploadDataSessions[com.peerId]);else listener("datatransfer:rejected",{peerId:com.peerId,transferId:transferId,name:com._uploadDataSessions[com.peerId].name,size:com._uploadDataSessions[com.peerId].size}),delete com._uploadDataTransfers[com.peerId],delete com._uploadDataSessions[com.peerId]},com.MESSAGEProtocolHandler=function(data){listener("datatransfer:message",{peerId:com.peerId,data:data})},com.ERRORProtocolHandler=function(data){{var isUploader=data.isUploadError;isUploader?com._uploadDataSessions[com.peerId].transferId:com._downloadDataSessions[com.peerId].transferId}listener("datatransfer:error",{peerId:com.peerId,data:data,transferType:isUploader?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD})},com._CANCELProtocolHandler=function(data){var isUpload=!!com._uploadDataSessions[com.peerId],transferId=(!!com._downloadDataSessions[com.peerId],isUpload?com._uploadDataSessions[com.peerId].transferId:com._downloadDataSessions[com.peerId].transferId);com._clearDataChannelTimeout(isUploader),listener("datatransfer:cancel",{peerId:com.peerId,transferId:transferId,name:data.name,content:data.content,senderPeerId:data.sender,transferType:isUpload?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD});try{isUpload?(delete com._uploadDataSessions[com.peerId],delete com._uploadDataTransfers[com.peerId]):(delete com._downloadDataSessions[peerId],delete com._downloadDataTransfers[peerId]),listener("datatransfer:cancel",{peerId:com.peerId,transferId:transferId,name:data.name,content:data.content,senderPeerId:data.sender,transferType:isUpload?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD})}catch(error){listener("datatransfer:error",{message:"Failed cancelling data request from peer",transferType:isUpload?com.DATA_TRANSFER_TYPE.UPLOAD:com.DATA_TRANSFER_TYPE.DOWNLOAD})}},com._DATAProtocolHandler=function(dataString,dataType){var chunk,error="",transferStatus=com._downloadDataSessions[com.peerId],transferId=transferStatus.transferId;if(com._clearDataChannelTimeout(!1),dataType===com.DATA_TRANSFER_DATA_TYPE.BINARY_STRING)chunk=DataProcess.unchunk(dataString);else if(dataType===com.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER)chunk=new Blob(dataString);else{if(dataType!==com.DATA_TRANSFER_DATA_TYPE.BLOB)return error="Unhandled data exception: "+dataType,void listener("datatransfer:error",{peerId:com.peerId,transferId:transferId,message:error,transferType:com.DATA_TRANSFER_TYPE.DOWNLOAD});chunk=dataString}var receivedSize=chunk.size*(4/3);if(transferStatus.chunkSize>=receivedSize){com._downloadDataTransfers[com.peerId].push(chunk),transferStatus.ackN+=1,transferStatus.receivedSize+=receivedSize;var totalReceivedSize=transferStatus.receivedSize,percentage=(totalReceivedSize/transferStatus.size*100).toFixed();if(com.channel.send({type:com._DC_PROTOCOL_TYPE.ACK,sender:null,ackN:transferStatus.ackN}),transferStatus.chunkSize===receivedSize)listener("datatransfer:downloading",{peerId:com.peerId,transferId:transferId,percentage:percentage}),com._setDataChannelTimeout(transferStatus.timeout,!1),com._downloadDataTransfers[com.peerId].info=transferStatus;else{var blob=new Blob(com._downloadDataTransfers[com.peerId]);listener("datatransfer:downloadcompleted",{peerId:com.peerId,transferId:transferId,data:blob}),delete com._downloadDataTransfers[com.peerId],delete com._downloadDataSessions[com.peerId]}}else error="Packet not match - [Received]"+receivedSize+" / [Expected]"+transferStatus.chunkSize,listener("datatransfer:error",{peerId:com.peerId,transferId:transferId,message:error,transferType:com.DATA_TRANSFER_TYPE.DOWNLOAD})},com.sendBlobData=function(data,dataInfo){dataInfo.timeout=dataInfo.timeout||60,dataInfo.transferId=com.DATA_TRANSFER_TYPE.UPLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),com.sendBlobDataToPeer(data,dataInfo,!0),listener("datatransfer:uploadstarted",{peerId:com.peerId,transferId:dataInfo.transferId,name:dataInfo.name,size:dataInfo.size,timeout:dataInfo.timeout||60,data:data})},com.sendBlobDataToPeer=function(data,dataInfo,isPrivate){var ongoingTransfer=null,binarySize=parseInt((dataInfo.size*(4/3)).toFixed(),10),chunkSize=parseInt((DataProcess.chunkSize*(4/3)).toFixed(),10);return"firefox"===window.webrtcDetectedBrowser&&window.webrtcDetectedVersion<30&&(chunkSize=DataProcess.mozChunkSize),com._uploadDataSessions[com.peerId]?ongoingTransfer=com.DATA_TRANSFER_TYPE.UPLOAD:com._downloadDataSessions[com.peerId]&&(ongoingTransfer=com.DATA_TRANSFER_TYPE.DOWNLOAD),ongoingTransfer?void listener("datatransfer:error",{peerId:peerId,transferId:dataInfo.transferId,name:dataInfo.name,message:dataInfo.content,transferType:ongoingTransfer}):(com._uploadDataTransfers[com.peerId]=DataProcess.chunk(data,dataInfo.size),com._uploadDataSessions[com.peerId]={name:dataInfo.name,size:binarySize,transferId:dataInfo.transferId,timeout:dataInfo.timeout},com.channel.send({type:com._DC_PROTOCOL_TYPE.WRQ,agent:window.webrtcDetectedBrowser,name:dataInfo.name,size:binarySize,chunkSize:chunkSize,timeout:dataInfo.timeout,target:com.peerId,isPrivate:!!isPrivate}),void com._setDataChannelTimeout(dataInfo.timeout,!0))},com.respondBlobRequest=function(accept){if(accept){com._downloadDataTransfers[com.peerId]=[];var data=com._downloadDataSessions[com.peerId];com.channel.send({type:com._DC_PROTOCOL_TYPE.ACK,ackN:0,agent:window.webrtcDetectedBrowser}),listener("datatransfer:downloadstarted",{peerId:com.peerId,name:data.name,size:data.size,transferId:data.transferId})}else com.channel.send({type:this._DC_PROTOCOL_TYPE.ACK,ackN:-1}),delete com._downloadDataSessions[com.peerId]},com.cancelBlobTransfer=function(transferType){var data;if(transferType===com.DATA_TRANSFER_TYPE.UPLOAD&&!transferType)if(data=com._uploadDataSessions[com.peerId])delete com._uploadDataSessions[com.peerId],delete com._uploadDataTransfers[com.peerId],com.channel.send({type:com._DC_PROTOCOL_TYPE.CANCEL,name:data.name,content:"Peer cancelled upload transfer"});else if(listener("datatransfer:error",{peerId:com.peerId,transferId:dataInfo.transferId,name:dataInfo.name,message:"Unable to cancel upload transfer. There is not ongoing upload sessions with the peer",transferType:com.DATA_TRANSFER_TYPE.UPLOAD}),transferType)return;transferType===com.DATA_TRANSFER_TYPE.DOWNLOAD&&(data=com._downloadDataSessions[peerId],data?(delete com._downloadDataSessions[com.peerId],delete com._downloadDataTransfers[com.peerId],com.channel.send({type:com._DC_PROTOCOL_TYPE.CANCEL,name:data.name,content:"Peer cancelled download transfer"})):listener("datatransfer:error",{peerId:com.peerId,transferId:dataInfo.transferId,name:dataInfo.name,message:"Unable to cancel download transfer. There is not ongoing download sessions with the peer",transferType:com.DATA_TRANSFER_TYPE.DOWNLOAD}))}}function Peer(config,listener){"use strict";var com=this;if(com.id=config.id||fn.generateUID(),com.type="main"===config.id?"user":"stream",com.SDPType=null,com.constraints=null,com.localDescription=null,com.remoteDescription=null,com.datachannels={},com.iceTrickle=!0,com.healthTimer=null,com.stream=null,com.streamingConfig=config.streamingConfig||{bandwidth:{},audio:!1,video:!1,mediaStatus:{audioMuted:!0,videoMuted:!0}},com.sdpConstraints={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},com.sdpConfig=null,com.config={optional:[{DtlsSrtpKeyAgreement:!0}]},com.RTCPeerConnection=null,com.weight=parseInt(fn.generateUID(),10),com.handler=function(event,data){PeerHandler(com,event,data,listener)},com.datatransfers={},com.onconnect=function(){},com.oniceconnectionstatechange=function(){},com.onicegatheringstatechange=function(){},com.onaddstream=function(){},com.onsignalingstatechange=function(){},com.onreconnect=function(){},com.onreconnect=function(){},com.ondisconnect=function(){},com.connect=function(stream){var peer=new window.RTCPeerConnection(com.constraints,com.config);(fn.isEmpty(stream)?!1:stream instanceof Stream)&&(com.stereo=fn.isSafe(function(){return stream.audio.stereo}),peer.addStream(stream.MediaStream),window.data=stream.MediaStream,com.handler("peer:stream",{sourceType:"local",stream:stream})),com.bind(peer)},com.reconnect=function(stream){var hasStream=!!stream;stream=stream||fn.isSafe(function(){return com.RTCPeerConnection.getLocalStreams()[0]}),com.RTCPeerConnection.close(),com.RTCPeerConnection=null;var peer=new window.RTCPeerConnection(com.constraints,com.config);(fn.isEmpty(stream)?!1:stream instanceof Stream)&&(com.stereo=fn.isSafe(function(){return stream.audio.stereo}),peer.addStream(stream.MediaStream),hasStream&&com.handler("peer:stream",{stream:stream}),com.handler("peer:reconnect",{})),com.bind(peer)},com.disconnect=function(){"closed"!==com.RTCPeerConnection.newSignalingState&&com.RTCPeerConnection.close(),com.handler("peer:disconnect",{})},com.bind=function(bindPeer){bindPeer.iceConnectionFiredStates=[],bindPeer.queueCandidate=[],bindPeer.newSignalingState="new",bindPeer.newIceConnectionState="new",bindPeer.datachannels={},bindPeer.ondatachannel=function(event){var eventChannel=event.channel||event,channel=new DataChannel(eventChannel,function(event,data){com.handler(event,data),"datachannel:start"===event&&com.handler("peer:datachannel",{channel:channel,sourceType:"remote"})});com.datachannels[channel.id]=channel,"main"===channel.id&&DataTransferHandler(com,"datatransfer:start",{data:data,dataChannel:channel},listener)},bindPeer.onaddstream=function(event){var eventStream=event.stream||event,stream=new Stream(eventStream,config.streamingConfig,function(event,data){com.handler(event,data),"stream:start"===event&&com.handler("peer:stream",{sourceType:"remote",stream:stream})})},bindPeer.onicecandidate=function(event){var eventCandidate=event.candidate||event;return fn.isEmpty(eventCandidate.candidate)?void com.handler("candidate:gathered",{candidate:eventCandidate}):void com.handler("peer:icecandidate",{sourceType:"local",candidate:eventCandidate})},bindPeer.oniceconnectionstatechange=function(){ICE.parseIceConnectionState(bindPeer)},bindPeer.oniceconnectionnewstatechange=function(){"connected"===com.RTCPeerConnection.newIceConnectionState&&(fn.isEmpty(com.healthTimer)||(log.debug("Peer",com.id,"Stopping health timer as connection is established."),clearInterval(com.healthTimer))),com.handler("peer:iceconnectionstate",{state:com.RTCPeerConnection.newIceConnectionState})},bindPeer.onsignalingstatechange=function(){com.handler("peer:signalingstate",{state:com.RTCPeerConnection.newSignalingState})},bindPeer.onicegatheringstatechange=function(){com.handler("peer:icegatheringstate",{state:com.RTCPeerConnection.iceGatheringState})},com.RTCPeerConnection=bindPeer,fn.runSync(function(){com.handler("peer:connect",{weight:com.weight,SDPType:com.SDPType,streamingConfig:com.streamingConfig})})},com.sendMessage=function(message){com.datachannels.main&&com.datachannels.main.send(message)},com.transferData=function(data){DataTransferHandler(com,"datatransfer:start",{data:data,dataChannel:com.datachannels.main},listener),com.datatransfers.main.sendBlobData(data,{name:data.name,size:data.size})},com.createOffer=function(){if(globals.dataChannel&&"user"===com.type){var eventChannel=com.RTCPeerConnection.createDataChannel("main"),channel=new DataChannel(eventChannel,function(event,data){com.handler(event,data),com.handler("peer:datachannel",{sourceType:"local",channel:channel})});com.datachannels.main=channel}com.RTCPeerConnection.createOffer(function(offer){offer.sdp=SDP.configure(offer.sdp,com.sdpConfig),com.localDescription=offer,com.handler("peer:offer:success",{offer:offer})},function(error){com.handler("peer:offer:error",{error:error})},com.sdpConstraints)},com.createAnswer=function(){com.RTCPeerConnection.createAnswer(function(answer){answer.sdp=SDP.configure(answer.sdp,com.sdpConfig),com.localDescription=answer,com.handler("peer:answer:success",{answer:answer}),com.setLocalDescription()},function(error){com.handler("peer:answer:error",{error:error})},com.sdpConstraints)},com.setLocalDescription=function(){var localDescription=com.localDescription;com.RTCPeerConnection.setLocalDescription(localDescription,function(){com.handler("peer:localdescription:success",{localDescription:localDescription.sdp,type:localDescription.type}),"answer"===localDescription.type?(com.RTCPeerConnection.newSignalingState="have-local-answer",com.handler("peer:signalingstate",{state:com.RTCPeerConnection.newSignalingState})):com.setRemoteDescription()},function(error){com.handler("peer:localdescription:error",{localDescription:localDescription.sdp,type:localDescription.type,error:error})})},com.setRemoteDescription=function(){var remoteDescription=com.remoteDescription;com.RTCPeerConnection.setRemoteDescription(remoteDescription,function(){com.handler("peer:remotedescription:success",{remoteDescription:remoteDescription.sdp,type:remoteDescription.type}),"answer"===remoteDescription.type?(com.RTCPeerConnection.newSignalingState="have-remote-answer",com.handler("peer:signalingstate",{state:com.RTCPeerConnection.newSignalingState})):com.createAnswer(),ICE.popCandidate(com.RTCPeerConnection,com.handler)},function(error){com.handler("peer:remotedescription:error",{remoteDescription:remoteDescription.sdp,type:remoteDescription.type,error:error})})},!window.RTCPeerConnection)throw new Error("Required dependency adapterjs not found");com.streamingConfig.bandwidth=StreamParser.parseBandwidthConfig(com.streamingConfig.bandwidth),com.constraints=ICE.parseICEServers(config.constraints),com.sdpConfig={stereo:fn.isSafe(function(){return config.streamingConfig.audio.stereo}),bandwidth:com.bandwidth},fn.runSync(function(){com.handler("peer:start",{weight:com.weight,SDPType:com.SDPType,streamingConfig:com.streamingConfig})})}function Room(name,listener){"use strict";function Self(config){var subcom=this;subcom.id=null,subcom.data=config.data,subcom.username=config.username,subcom.timeStamp=config.timeStamp,subcom.token=config.token,subcom.streams={},subcom.agent={name:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,webRTCType:window.webrtcDetectedType},subcom.bandwidth={},subcom.handler=function(event,data){data.id=subcom.id,log.debug("SelfHandler:",event,data),RoomHandler(com,event,data,listener)},subcom.onupdate=function(){},subcom.onaddstreamconnection=function(){},subcom.onremovestreamconnection=function(){},subcom.ondisconnect=function(){},subcom.update=function(data){subcom.data=data,com.socket.send({type:"updateUserEvent",mid:subcom.id,rid:com.id,userData:subcom.data}),subcom.handler("self:update",{data:subcom.data})},subcom.addStreamConnection=function(stream,connectionId){stream.sourceType="local";var connection={id:connectionId,stream:stream};subcom.streams[connectionId]=connection,"function"==typeof subcom.onaddstreamconnection&&subcom.onaddstreamconnection(connection),subcom.handler("self:addstreamconnection",{stream:stream,connectionId:connectionId})},subcom.removeStreamConnection=function(connectionId){var stream=subcom.streams[connectionId];stream.stop(),"main"!==connectionId&&(fn.isEmpty(subcom.streams[connectionId].targetUsers)?fn.forEach(com.users,function(value){value.removeConnection(streamId)}):fn.forEach(subcom.streams[connectionId].targetUsers,function(value,key){fn.isEmpty(com.users[key])||com.users[key].removeConnection(streamId)})),"function"==typeof subcom.onremovestreamconnection&&subcom.onremovestreamconnection(stream,targetUsers),delete subcom.streams[streamId],delete subcom.streams[streamId],subcom.handler("self:removestreamconnection",{streamId:streamId})},subcom.getInfo=function(connectionId){var info={userData:subcom.data,agent:subcom.agent};if(!fn.isEmpty(connectionId)){var settings=subcom.streams[connectionId]||{},stream=settings.stream||{config:{audio:!1,video:!1,status:{audioMuted:!0,videoMuted:!0}}};return info.settings={audio:stream.config.audio,video:stream.config.video,bandwidth:subcom.bandwidth,mediaStatus:stream.config.status},info}var streaming={};fn.forEach(subcom.streams,function(connection,key){var settings=subcom.streams[connectionId]||{},stream=settings.stream||{config:{audio:!1,video:!1,status:{audioMuted:!0,videoMuted:!0}}};streaming[key]={audio:stream.config.audio,video:stream.config.video,bandwidth:subcom.bandwidth,mediaStatus:stream.config.status}},function(){return info.settings=streaming,info})},subcom.handler("self:start",config)}var com=this;com.name=name,com.id=null,com.token=null,com.key=null,com.startDateTime=null,com.duration=null,com.apiPath=null,com.owner=null,com.credentials=globals.credentials,com.self=null,com.selfData=null,com.streams={},com.users={},com.components={},com.socket=null,com.readyState=0,com.iceServers={},com.locked=!1,com.handler=function(event,data){RoomHandler(com,event,data,listener)},com.onreadystatechange=function(){},com.onjoin=function(){},com.onkick=function(){},com.onwarn=function(){},com.onlock=function(){},com.onunlock=function(){},com.onleave=function(){},com.join=function(stream,config){config=config||{},com.self.bandwidth=StreamParser.parseBandwidthConfig(config.bandwidth),com.self.data=config.userData,fn.isEmpty(stream)||com.self.addStreamConnection(stream,"main"),com.socket.connect()},com.leave=function(){com.socket.disconnect()},com.lock=function(){com.socket.send({type:"roomLockEvent",mid:com.self.id,rid:com.id,lock:!0}),com.handler("room:lock",{userId:com.self.id})},com.unlock=function(){com.socket.send({type:"roomLockEvent",mid:com.self.id,rid:com.id,lock:!1}),com.handler("room:unlock",{userId:com.self.id})},com.addStreamConnection=function(stream){var connectionId=fn.generateUID();com.self.addStreamConnection(stream,connectionId),stream.parentHandler=com.handler,fn.forEach(com.users,function(user){data.stream=stream,user.handler("message:enter",data)})};var path="/api/"+globals.apiKey+"/"+com.name;null!==com.credentials&&(path+=com.credentials.startDateTime+"/"+com.credentials.duration+"?&cred="+com.credentials.hash),globals.region&&(path+=(path.indexOf("?&")>-1?"&":"?&")+"rg="+globals.region),Request.load(path,function(status,content){com.apiPath=path,com.key=content.cid,com.id=content.room_key,com.token=content.roomCred,com.startDateTime=content.start,com.duration=content.len,com.owner=content.apiOwner,com.self=new Self({id:null,username:content.username,token:content.userCred,timeStamp:content.timeStamp,data:globals.userData}),com.socket=new Socket({server:content.ipSigserver,httpPortList:content.httpPortList,httpsPortList:content.httpsPortList},com.handler),MessageHandler(com,listener),listener("room:start",{id:com.id,name:com.name})},function(status,error){com.handler("trigger:error",{error:error,state:-1})})}function Socket(config,listener){"use strict";var com=this;if(com.server=config.server,com.protocol=globals.enforceSSL?"https:":window.location.protocol,com.port=null,com.timeout=globals.socketTimeout||0,com.messageInterval=1e3,com.messageQueue=[],com.readyState="new",com.ports={"https:":config.httpsPortList,"http:":config.httpPortList},com.config={},com.type=config.type||"WebSocket",com.Socket=null,com.responses={},com.handler=function(event,data){data.server=com.server,data.port=com.port,data.type=com.type,data.protocol=com.protocol,listener(event,data)},com.onconnect=function(){},com.ondisconnect=function(){},com.onconnecterror=function(){},com.onreconnect=function(){},com.onerror=function(){},com.connect=function(){com.port=com.ports[window.location.protocol][0],com.Socket="XHRPolling"===com.type?new com.XHRPolling:new com.WebSocket},com.disconnect=function(){com.Socket.disconnect(),com.Socket.responses={}},com.when=function(event,callback){com.responses[event]=com.responses[event]||[],com.responses[event].push(callback)},com.send=function(data){com.Socket.send(JSON.stringify(data)),com.handler("socket:send",{message:data})},com.bindOnConnect=function(){com.handler("socket:connect",{}),com.Socket.removeAllListeners(),com.Socket.on("disconnect",com.bindOnDisconnect),com.Socket.on("message",com.bindOnMessage),com.Socket.on("error",com.bindOnError),"function"==typeof com.onconnect&&com.onconnect()},com.bindOnDisonnect=function(){com.handler("socket:disconnect",{}),"function"==typeof com.onerror&&com.ondisconnect()},com.bindOnMessage=function(result){var data=JSON.parse(result);com.handler("socket:message",{message:data}),"group"===data.type?fn.forEach(function(message){com.respond(message.type,message)}):com.respond(data.type,data)},com.bindOnConnectError=function(error){com.handler("socket:connect_error",{error:error});for(var ports=com.ports[window.location.protocol],i=0;i<ports.length;i++)if(ports[i]===com.port){i+1<ports.length?(com.port=ports[i+1],com.reconnect()):"WebSocket"===com.type&&(com.type="XHRLongPolling",com.port=ports[0],com.reconnect());break}"function"==typeof com.onconnecterror&&com.onconnecterror(error)},com.bindOnError=function(error){com.handler("socket:error",{error:error}),"function"==typeof com.onerror&&com.onerror(error)},com.respond=function(type,data){com.responses[type]=com.responses[type]||[],fn.forEach(com.responses[type],function(response){response(data)})},com.reconnect=function(){switch(com.Socket.removeAllListeners(),com.type){case"WebSocket":com.Socket=com.WebSocket();break;default:com.Socket=com.XHRPolling()}"function"==typeof com.onreconnect&&com.onreconnect(com.type)},com.WebSocket=function(){var options={forceNew:!0,reconnection:!1,transports:["websocket"]};0!==com.timeout&&(options.timeout=com.timeout);var server=com.protocol+"//"+com.server+":"+com.port,socket=io.connect(server,options);return socket.on("connect",com.bindOnConnect),socket.on("connect_error",com.bindOnConnectError),socket},com.XHRPolling=function(){var ports=com.ports[window.location.protocol],options={forceNew:!0,reconnection:com.port===ports[ports.length-1],transports:["xhr-polling","jsonp-polling","polling"]};0!==com.timeout&&(options.timeout=com.timeout);var server=com.protocol+"//"+com.server+":"+com.port,socket=io.connect(server,options);return socket.on("connect",com.bindOnConnect),socket.on("reconnect",com.bindOnConnect),socket.on("connect_error",com.bindOnConnectError),socket.on("reconnect_failed",com.bindOnConnectError),socket},!window.io)throw new Error("Required dependency socket.io not found");fn.runSync(function(){com.handler("socket:start",config)})}function Stream(stream,config,listener){"use strict";var com=this;if(com.id=null,com.constraints=null,com.config=config,com.sourceType="local",com.MediaStream=null,com.parentHandler=function(){},com.handler=function(event,data){listener(event,data),"function"==typeof com.parentHandler&&com.parentHandler(event,data)},com.onstreamended=function(){},com.ontrackended=function(){},com.ontrackmute=function(){},com.ontrackunmute=function(){},com.start=function(){window.getUserMedia(com.constraints,com.bind,function(error){com.handler("stream:error",{id:com.id,error:error,sourceType:com.sourceType})})},com.bind=function(bindStream){com.id=bindStream.id||fn.generateUID(),bindStream.onended=com.bindOnStreamEnded(bindStream),bindStream.newId=com.id,com.bindTracks(bindStream.getAudioTracks()),com.bindTracks(bindStream.getVideoTracks()),com.MediaStream=bindStream,com.handler("stream:start",{id:com.id,label:bindStream.label,constraints:com.constraints,sourceType:com.sourceType})},com.bindTracks=function(bindTracks){fn.forEach(bindTracks,function(track){track.newId=track.id||fn.generateUID(),track.onended=function(){com.handler("stream:track:stop",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackended&&com.ontrackended(track)};var isEnabled=!0;isEnabled="audio"===track.kind?"object"==typeof com.config.audio?!com.config.status.audioMuted:!!com.config.audio:"object"==typeof com.config.video?!com.config.status.videoMuted:!!com.config.video,track.enabled=isEnabled,com.handler("stream:track:start",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType})})},com.attachElement=function(element){"firefox"===window.webrtcDetectedBrowser&&com.MediaStream instanceof LocalMediaStream==!1?window.reattachMediaStream(element,com.MediaStream.checkingVideo):window.attachMediaStream(element,com.MediaStream)},com.bindOnStreamEnded=function(bindStream){var fn=function(){com.handler("stream:stop",{id:com.id,label:stream.label,constraints:com.constraints,sourceType:com.sourceType}),"function"==typeof com.onended&&com.onended(bindStream)};return"firefox"===window.webrtcDetectedBrowser?bindStream.constructor===LocalMediaStream?setInterval(function(){bindStream.hasEnded&&(clearInterval(bindStream.onended),fn()),"undefined"==typeof bindStream.recordedTime&&(bindStream.recordedTime=0),bindStream.recordedTime===bindStream.currentTime?(clearInterval(bindStream.onended),fn()):bindStream.recordedTime=bindStream.currentTime},1e3):function(){var video=document.createElement("video");return video.onstreamended=setInterval(function(){bindStream.hasEnded&&(clearInterval(video.onstreamended),fn()),fn.isEmpty(video.mozSrcObject)||video.mozSrcObject.ended===!0&&(clearInterval(video.onstreamended),fn())},1e3),bindStream.checkingVideo=video,window.attachMediaStream(video,bindStream),video}():fn},com.muteAudio=function(){var tracks=com.MediaStream.getAudioTracks();fn.forEach(tracks,function(track){track.enabled=!1,com.handler("stream:track:mute",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackmute&&com.ontrackmute(track)})},com.unmuteAudio=function(){var tracks=com.MediaStream.getAudioTracks();fn.forEach(tracks,function(track){track.enabled=!0,com.handler("stream:track:unmute",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackunmute&&com.ontrackunmute(track)})},com.stopAudio=function(){var tracks=com.MediaStream.getAudioTracks();fn.forEach(tracks,function(track){track.stop(),"firefox"===window.webrtcDetectedBrowser&&track.hasEnded!==!0&&(track.onended(track),track.hasEnded=!0)},function(){"firefox"===window.webrtcDetectedBrowser&&(com.MediaStream.videoEnded===!0&&(com.MediaStream.hasEnded=!0),com.MediaStream.audioEnded=!0)})},com.muteVideo=function(){var tracks=com.MediaStream.getVideoTracks();fn.forEach(tracks,function(track){track.enabled=!1,com.handler("stream:track:mute",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackmute&&com.ontrackmute(track)})},com.unmuteVideo=function(){var tracks=com.MediaStream.getVideoTracks();fn.forEach(tracks,function(track){track.enabled=!0,com.handler("stream:track:unmute",{streamId:com.id,id:track.newId,kind:track.kind,label:track.label,enabled:track.enabled,sourceType:com.sourceType}),"function"==typeof com.ontrackunmute&&com.ontrackunmute(track)
})},com.stopVideo=function(){var tracks=com.MediaStream.getVideoTracks();fn.forEach(tracks,function(track,i){track.stop(),"firefox"===window.webrtcDetectedBrowser&&track.hasEnded!==!0&&(track.onended(tracks[i]),track.hasEnded=!0)},function(){"firefox"===window.webrtcDetectedBrowser&&(com.MediaStream.audioEnded===!0&&(com.MediaStream.hasEnded=!0),com.MediaStream.videoEnded=!0)})},com.stop=function(){com.stopVideo(),com.stopAudio(),com.MediaStream.stop()},!window.attachMediaStream)throw new Error("Required dependency adapterjs not found");if(fn.isEmpty(stream)){var audioSettings=StreamParser.parseAudioConfig(config.audio),videoSettings=StreamParser.parseVideoConfig(config.video),statusSettings=StreamParser.parseMutedConfig(config);com.constraints={audio:audioSettings.userMedia,video:videoSettings.userMedia},com.config={audio:audioSettings.settings,video:audioSettings.settings,status:statusSettings},com.start()}else fn.runSync(function(){com.config={audio:fn.isSafe(function(){return stream.getAudioTracks().length>0}),video:fn.isSafe(function(){return stream.getVideoTracks().length>0})},com.bind(stream)})}function User(config,listener){"use strict";var com=this;com.id=config.mid,com.type="user",com.data=config.userInfo.userData||{},com.agent=config.agent||{},com.peers={},com.streamingConfigs={},com.handler=function(event,data){UserHandler(com,event,data,listener)},com.onupdate=function(){},com.ondisconnect=function(){},com.onaddconnection=function(){},com.onremoveconnection=function(){},com.ondatarequest=function(){},com.ondata=function(){},com.onmessage=function(){},com.addConnection=function(data,stream){var peerConfig={id:data.prid,constraints:data.iceServers,bandwidth:data.bandwidth,streamingConfig:data.settings},peer=new Peer(peerConfig,com.handler);peer.connect(stream),peer.SDPType=data.SDPType,com.peers[peer.id]=peer},com.removeConnection=function(peerId){var peer=com.peers[peerId];fn.isEmpty(peer)||peer.disconnect()},com.disconnect=function(){fn.forEach(com.peers,function(peer){peer.disconnect()})},com.update=function(data){com.data=data,com.handler("user:update",{data:com.data})},com.getInfo=function(){var data={};return data.userData=com.data,data.agent=com.agent,data.settings=com.streamingConfigs,data},com.streamingConfigs[config.prid]=config.settings,fn.runSync(function(){com.handler("user:start",config)})}if(!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.io=e()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module){module.exports=_dereq_("./lib/")},{"./lib/":2}],2:[function(_dereq_,module,exports){function lookup(uri,opts){"object"==typeof uri&&(opts=uri,uri=void 0),opts=opts||{};var io,parsed=url(uri),source=parsed.source,id=parsed.id;return opts.forceNew||opts["force new connection"]||!1===opts.multiplex?(debug("ignoring socket cache for %s",source),io=Manager(source,opts)):(cache[id]||(debug("new io instance for %s",source),cache[id]=Manager(source,opts)),io=cache[id]),io.socket(parsed.path)}var url=_dereq_("./url"),parser=_dereq_("socket.io-parser"),Manager=_dereq_("./manager"),debug=_dereq_("debug")("socket.io-client");module.exports=exports=lookup;var cache=exports.managers={};exports.protocol=parser.protocol,exports.connect=lookup,exports.Manager=_dereq_("./manager"),exports.Socket=_dereq_("./socket")},{"./manager":3,"./socket":5,"./url":6,debug:9,"socket.io-parser":43}],3:[function(_dereq_,module){function Manager(uri,opts){return this instanceof Manager?(uri&&"object"==typeof uri&&(opts=uri,uri=void 0),opts=opts||{},opts.path=opts.path||"/socket.io",this.nsps={},this.subs=[],this.opts=opts,this.reconnection(opts.reconnection!==!1),this.reconnectionAttempts(opts.reconnectionAttempts||1/0),this.reconnectionDelay(opts.reconnectionDelay||1e3),this.reconnectionDelayMax(opts.reconnectionDelayMax||5e3),this.timeout(null==opts.timeout?2e4:opts.timeout),this.readyState="closed",this.uri=uri,this.connected=[],this.attempts=0,this.encoding=!1,this.packetBuffer=[],this.encoder=new parser.Encoder,this.decoder=new parser.Decoder,this.autoConnect=opts.autoConnect!==!1,void(this.autoConnect&&this.open())):new Manager(uri,opts)}var eio=(_dereq_("./url"),_dereq_("engine.io-client")),Socket=_dereq_("./socket"),Emitter=_dereq_("component-emitter"),parser=_dereq_("socket.io-parser"),on=_dereq_("./on"),bind=_dereq_("component-bind"),debug=(_dereq_("object-component"),_dereq_("debug")("socket.io-client:manager")),indexOf=_dereq_("indexof");module.exports=Manager,Manager.prototype.emitAll=function(){this.emit.apply(this,arguments);for(var nsp in this.nsps)this.nsps[nsp].emit.apply(this.nsps[nsp],arguments)},Emitter(Manager.prototype),Manager.prototype.reconnection=function(v){return arguments.length?(this._reconnection=!!v,this):this._reconnection},Manager.prototype.reconnectionAttempts=function(v){return arguments.length?(this._reconnectionAttempts=v,this):this._reconnectionAttempts},Manager.prototype.reconnectionDelay=function(v){return arguments.length?(this._reconnectionDelay=v,this):this._reconnectionDelay},Manager.prototype.reconnectionDelayMax=function(v){return arguments.length?(this._reconnectionDelayMax=v,this):this._reconnectionDelayMax},Manager.prototype.timeout=function(v){return arguments.length?(this._timeout=v,this):this._timeout},Manager.prototype.maybeReconnectOnOpen=function(){this.openReconnect||this.reconnecting||!this._reconnection||0!==this.attempts||(this.openReconnect=!0,this.reconnect())},Manager.prototype.open=Manager.prototype.connect=function(fn){if(debug("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;debug("opening %s",this.uri),this.engine=eio(this.uri,this.opts);var socket=this.engine,self=this;this.readyState="opening",this.skipReconnect=!1;var openSub=on(socket,"open",function(){self.onopen(),fn&&fn()}),errorSub=on(socket,"error",function(data){if(debug("connect_error"),self.cleanup(),self.readyState="closed",self.emitAll("connect_error",data),fn){var err=new Error("Connection error");err.data=data,fn(err)}self.maybeReconnectOnOpen()});if(!1!==this._timeout){var timeout=this._timeout;debug("connect attempt will timeout after %d",timeout);var timer=setTimeout(function(){debug("connect attempt timed out after %d",timeout),openSub.destroy(),socket.close(),socket.emit("error","timeout"),self.emitAll("connect_timeout",timeout)},timeout);this.subs.push({destroy:function(){clearTimeout(timer)}})}return this.subs.push(openSub),this.subs.push(errorSub),this},Manager.prototype.onopen=function(){debug("open"),this.cleanup(),this.readyState="open",this.emit("open");var socket=this.engine;this.subs.push(on(socket,"data",bind(this,"ondata"))),this.subs.push(on(this.decoder,"decoded",bind(this,"ondecoded"))),this.subs.push(on(socket,"error",bind(this,"onerror"))),this.subs.push(on(socket,"close",bind(this,"onclose")))},Manager.prototype.ondata=function(data){this.decoder.add(data)},Manager.prototype.ondecoded=function(packet){this.emit("packet",packet)},Manager.prototype.onerror=function(err){debug("error",err),this.emitAll("error",err)},Manager.prototype.socket=function(nsp){var socket=this.nsps[nsp];if(!socket){socket=new Socket(this,nsp),this.nsps[nsp]=socket;var self=this;socket.on("connect",function(){~indexOf(self.connected,socket)||self.connected.push(socket)})}return socket},Manager.prototype.destroy=function(socket){var index=indexOf(this.connected,socket);~index&&this.connected.splice(index,1),this.connected.length||this.close()},Manager.prototype.packet=function(packet){debug("writing packet %j",packet);var self=this;self.encoding?self.packetBuffer.push(packet):(self.encoding=!0,this.encoder.encode(packet,function(encodedPackets){for(var i=0;i<encodedPackets.length;i++)self.engine.write(encodedPackets[i]);self.encoding=!1,self.processPacketQueue()}))},Manager.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var pack=this.packetBuffer.shift();this.packet(pack)}},Manager.prototype.cleanup=function(){for(var sub;sub=this.subs.shift();)sub.destroy();this.packetBuffer=[],this.encoding=!1,this.decoder.destroy()},Manager.prototype.close=Manager.prototype.disconnect=function(){this.skipReconnect=!0,this.readyState="closed",this.engine&&this.engine.close()},Manager.prototype.onclose=function(reason){debug("close"),this.cleanup(),this.readyState="closed",this.emit("close",reason),this._reconnection&&!this.skipReconnect&&this.reconnect()},Manager.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var self=this;if(this.attempts++,this.attempts>this._reconnectionAttempts)debug("reconnect failed"),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var delay=this.attempts*this.reconnectionDelay();delay=Math.min(delay,this.reconnectionDelayMax()),debug("will wait %dms before reconnect attempt",delay),this.reconnecting=!0;var timer=setTimeout(function(){self.skipReconnect||(debug("attempting reconnect"),self.emitAll("reconnect_attempt",self.attempts),self.emitAll("reconnecting",self.attempts),self.skipReconnect||self.open(function(err){err?(debug("reconnect attempt error"),self.reconnecting=!1,self.reconnect(),self.emitAll("reconnect_error",err.data)):(debug("reconnect success"),self.onreconnect())}))},delay);this.subs.push({destroy:function(){clearTimeout(timer)}})}},Manager.prototype.onreconnect=function(){var attempt=this.attempts;this.attempts=0,this.reconnecting=!1,this.emitAll("reconnect",attempt)}},{"./on":4,"./socket":5,"./url":6,"component-bind":7,"component-emitter":8,debug:9,"engine.io-client":10,indexof:39,"object-component":40,"socket.io-parser":43}],4:[function(_dereq_,module){function on(obj,ev,fn){return obj.on(ev,fn),{destroy:function(){obj.removeListener(ev,fn)}}}module.exports=on},{}],5:[function(_dereq_,module,exports){function Socket(io,nsp){this.io=io,this.nsp=nsp,this.json=this,this.ids=0,this.acks={},this.io.autoConnect&&this.open(),this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0}var parser=_dereq_("socket.io-parser"),Emitter=_dereq_("component-emitter"),toArray=_dereq_("to-array"),on=_dereq_("./on"),bind=_dereq_("component-bind"),debug=_dereq_("debug")("socket.io-client:socket"),hasBin=_dereq_("has-binary");module.exports=exports=Socket;var events={connect:1,connect_error:1,connect_timeout:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1},emit=Emitter.prototype.emit;Emitter(Socket.prototype),Socket.prototype.subEvents=function(){if(!this.subs){var io=this.io;this.subs=[on(io,"open",bind(this,"onopen")),on(io,"packet",bind(this,"onpacket")),on(io,"close",bind(this,"onclose"))]}},Socket.prototype.open=Socket.prototype.connect=function(){return this.connected?this:(this.subEvents(),this.io.open(),"open"==this.io.readyState&&this.onopen(),this)},Socket.prototype.send=function(){var args=toArray(arguments);return args.unshift("message"),this.emit.apply(this,args),this},Socket.prototype.emit=function(ev){if(events.hasOwnProperty(ev))return emit.apply(this,arguments),this;var args=toArray(arguments),parserType=parser.EVENT;hasBin(args)&&(parserType=parser.BINARY_EVENT);var packet={type:parserType,data:args};return"function"==typeof args[args.length-1]&&(debug("emitting packet with ack id %d",this.ids),this.acks[this.ids]=args.pop(),packet.id=this.ids++),this.connected?this.packet(packet):this.sendBuffer.push(packet),this},Socket.prototype.packet=function(packet){packet.nsp=this.nsp,this.io.packet(packet)},Socket.prototype.onopen=function(){debug("transport is open - connecting"),"/"!=this.nsp&&this.packet({type:parser.CONNECT})},Socket.prototype.onclose=function(reason){debug("close (%s)",reason),this.connected=!1,this.disconnected=!0,this.emit("disconnect",reason)},Socket.prototype.onpacket=function(packet){if(packet.nsp==this.nsp)switch(packet.type){case parser.CONNECT:this.onconnect();break;case parser.EVENT:this.onevent(packet);break;case parser.BINARY_EVENT:this.onevent(packet);break;case parser.ACK:this.onack(packet);break;case parser.BINARY_ACK:this.onack(packet);break;case parser.DISCONNECT:this.ondisconnect();break;case parser.ERROR:this.emit("error",packet.data)}},Socket.prototype.onevent=function(packet){var args=packet.data||[];debug("emitting event %j",args),null!=packet.id&&(debug("attaching ack callback to event"),args.push(this.ack(packet.id))),this.connected?emit.apply(this,args):this.receiveBuffer.push(args)},Socket.prototype.ack=function(id){var self=this,sent=!1;return function(){if(!sent){sent=!0;var args=toArray(arguments);debug("sending ack %j",args);var type=hasBin(args)?parser.BINARY_ACK:parser.ACK;self.packet({type:type,id:id,data:args})}}},Socket.prototype.onack=function(packet){debug("calling ack %s with %j",packet.id,packet.data);var fn=this.acks[packet.id];fn.apply(this,packet.data),delete this.acks[packet.id]},Socket.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},Socket.prototype.emitBuffered=function(){var i;for(i=0;i<this.receiveBuffer.length;i++)emit.apply(this,this.receiveBuffer[i]);for(this.receiveBuffer=[],i=0;i<this.sendBuffer.length;i++)this.packet(this.sendBuffer[i]);this.sendBuffer=[]},Socket.prototype.ondisconnect=function(){debug("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},Socket.prototype.destroy=function(){if(this.subs){for(var i=0;i<this.subs.length;i++)this.subs[i].destroy();this.subs=null}this.io.destroy(this)},Socket.prototype.close=Socket.prototype.disconnect=function(){return this.connected&&(debug("performing disconnect (%s)",this.nsp),this.packet({type:parser.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}},{"./on":4,"component-bind":7,"component-emitter":8,debug:9,"has-binary":35,"socket.io-parser":43,"to-array":47}],6:[function(_dereq_,module){(function(global){function url(uri,loc){var obj=uri,loc=loc||global.location;return null==uri&&(uri=loc.protocol+"//"+loc.hostname),"string"==typeof uri&&("/"==uri.charAt(0)&&(uri="/"==uri.charAt(1)?loc.protocol+uri:loc.hostname+uri),/^(https?|wss?):\/\//.test(uri)||(debug("protocol-less url %s",uri),uri="undefined"!=typeof loc?loc.protocol+"//"+uri:"https://"+uri),debug("parse %s",uri),obj=parseuri(uri)),obj.port||(/^(http|ws)$/.test(obj.protocol)?obj.port="80":/^(http|ws)s$/.test(obj.protocol)&&(obj.port="443")),obj.path=obj.path||"/",obj.id=obj.protocol+"://"+obj.host+":"+obj.port,obj.href=obj.protocol+"://"+obj.host+(loc&&loc.port==obj.port?"":":"+obj.port),obj}var parseuri=_dereq_("parseuri"),debug=_dereq_("debug")("socket.io-client:url");module.exports=url}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{debug:9,parseuri:41}],7:[function(_dereq_,module){var slice=[].slice;module.exports=function(obj,fn){if("string"==typeof fn&&(fn=obj[fn]),"function"!=typeof fn)throw new Error("bind() requires a function");var args=slice.call(arguments,2);return function(){return fn.apply(obj,args.concat(slice.call(arguments)))}}},{}],8:[function(_dereq_,module){function Emitter(obj){return obj?mixin(obj):void 0}function mixin(obj){for(var key in Emitter.prototype)obj[key]=Emitter.prototype[key];return obj}module.exports=Emitter,Emitter.prototype.on=Emitter.prototype.addEventListener=function(event,fn){return this._callbacks=this._callbacks||{},(this._callbacks[event]=this._callbacks[event]||[]).push(fn),this},Emitter.prototype.once=function(event,fn){function on(){self.off(event,on),fn.apply(this,arguments)}var self=this;return this._callbacks=this._callbacks||{},on.fn=fn,this.on(event,on),this},Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(event,fn){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var callbacks=this._callbacks[event];if(!callbacks)return this;if(1==arguments.length)return delete this._callbacks[event],this;for(var cb,i=0;i<callbacks.length;i++)if(cb=callbacks[i],cb===fn||cb.fn===fn){callbacks.splice(i,1);break}return this},Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};var args=[].slice.call(arguments,1),callbacks=this._callbacks[event];if(callbacks){callbacks=callbacks.slice(0);for(var i=0,len=callbacks.length;len>i;++i)callbacks[i].apply(this,args)}return this},Emitter.prototype.listeners=function(event){return this._callbacks=this._callbacks||{},this._callbacks[event]||[]},Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length}},{}],9:[function(_dereq_,module){function debug(name){return debug.enabled(name)?function(fmt){fmt=coerce(fmt);var curr=new Date,ms=curr-(debug[name]||curr);debug[name]=curr,fmt=name+" "+fmt+" +"+debug.humanize(ms),window.console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}:function(){}}function coerce(val){return val instanceof Error?val.stack||val.message:val}module.exports=debug,debug.names=[],debug.skips=[],debug.enable=function(name){try{localStorage.debug=name}catch(e){}for(var split=(name||"").split(/[\s,]+/),len=split.length,i=0;len>i;i++)name=split[i].replace("*",".*?"),"-"===name[0]?debug.skips.push(new RegExp("^"+name.substr(1)+"$")):debug.names.push(new RegExp("^"+name+"$"))},debug.disable=function(){debug.enable("")},debug.humanize=function(ms){var sec=1e3,min=6e4,hour=60*min;return ms>=hour?(ms/hour).toFixed(1)+"h":ms>=min?(ms/min).toFixed(1)+"m":ms>=sec?(ms/sec|0)+"s":ms+"ms"},debug.enabled=function(name){for(var i=0,len=debug.skips.length;len>i;i++)if(debug.skips[i].test(name))return!1;for(var i=0,len=debug.names.length;len>i;i++)if(debug.names[i].test(name))return!0;return!1};try{window.localStorage&&debug.enable(localStorage.debug)}catch(e){}},{}],10:[function(_dereq_,module){module.exports=_dereq_("./lib/")},{"./lib/":11}],11:[function(_dereq_,module){module.exports=_dereq_("./socket"),module.exports.parser=_dereq_("engine.io-parser")},{"./socket":12,"engine.io-parser":24}],12:[function(_dereq_,module){(function(global){function Socket(uri,opts){if(!(this instanceof Socket))return new Socket(uri,opts);if(opts=opts||{},uri&&"object"==typeof uri&&(opts=uri,uri=null),uri&&(uri=parseuri(uri),opts.host=uri.host,opts.secure="https"==uri.protocol||"wss"==uri.protocol,opts.port=uri.port,uri.query&&(opts.query=uri.query)),this.secure=null!=opts.secure?opts.secure:global.location&&"https:"==location.protocol,opts.host){var pieces=opts.host.split(":");opts.hostname=pieces.shift(),pieces.length&&(opts.port=pieces.pop())}this.agent=opts.agent||!1,this.hostname=opts.hostname||(global.location?location.hostname:"localhost"),this.port=opts.port||(global.location&&location.port?location.port:this.secure?443:80),this.query=opts.query||{},"string"==typeof this.query&&(this.query=parseqs.decode(this.query)),this.upgrade=!1!==opts.upgrade,this.path=(opts.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!opts.forceJSONP,this.jsonp=!1!==opts.jsonp,this.forceBase64=!!opts.forceBase64,this.enablesXDR=!!opts.enablesXDR,this.timestampParam=opts.timestampParam||"t",this.timestampRequests=opts.timestampRequests,this.transports=opts.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.callbackBuffer=[],this.policyPort=opts.policyPort||843,this.rememberUpgrade=opts.rememberUpgrade||!1,this.open(),this.binaryType=null,this.onlyBinaryUpgrades=opts.onlyBinaryUpgrades}function clone(obj){var o={};for(var i in obj)obj.hasOwnProperty(i)&&(o[i]=obj[i]);return o}var transports=_dereq_("./transports"),Emitter=_dereq_("component-emitter"),debug=_dereq_("debug")("engine.io-client:socket"),index=_dereq_("indexof"),parser=_dereq_("engine.io-parser"),parseuri=_dereq_("parseuri"),parsejson=_dereq_("parsejson"),parseqs=_dereq_("parseqs");module.exports=Socket,Socket.priorWebsocketSuccess=!1,Emitter(Socket.prototype),Socket.protocol=parser.protocol,Socket.Socket=Socket,Socket.Transport=_dereq_("./transport"),Socket.transports=_dereq_("./transports"),Socket.parser=_dereq_("engine.io-parser"),Socket.prototype.createTransport=function(name){debug('creating transport "%s"',name);var query=clone(this.query);query.EIO=parser.protocol,query.transport=name,this.id&&(query.sid=this.id);var transport=new transports[name]({agent:this.agent,hostname:this.hostname,port:this.port,secure:this.secure,path:this.path,query:query,forceJSONP:this.forceJSONP,jsonp:this.jsonp,forceBase64:this.forceBase64,enablesXDR:this.enablesXDR,timestampRequests:this.timestampRequests,timestampParam:this.timestampParam,policyPort:this.policyPort,socket:this});return transport},Socket.prototype.open=function(){var transport;if(this.rememberUpgrade&&Socket.priorWebsocketSuccess&&-1!=this.transports.indexOf("websocket"))transport="websocket";else{if(0==this.transports.length){var self=this;return void setTimeout(function(){self.emit("error","No transports available")},0)}transport=this.transports[0]}this.readyState="opening";var transport;try{transport=this.createTransport(transport)}catch(e){return this.transports.shift(),void this.open()}transport.open(),this.setTransport(transport)},Socket.prototype.setTransport=function(transport){debug("setting transport %s",transport.name);var self=this;this.transport&&(debug("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=transport,transport.on("drain",function(){self.onDrain()}).on("packet",function(packet){self.onPacket(packet)}).on("error",function(e){self.onError(e)}).on("close",function(){self.onClose("transport close")})},Socket.prototype.probe=function(name){function onTransportOpen(){if(self.onlyBinaryUpgrades){var upgradeLosesBinary=!this.supportsBinary&&self.transport.supportsBinary;failed=failed||upgradeLosesBinary}failed||(debug('probe transport "%s" opened',name),transport.send([{type:"ping",data:"probe"}]),transport.once("packet",function(msg){if(!failed)if("pong"==msg.type&&"probe"==msg.data){if(debug('probe transport "%s" pong',name),self.upgrading=!0,self.emit("upgrading",transport),!transport)return;Socket.priorWebsocketSuccess="websocket"==transport.name,debug('pausing current transport "%s"',self.transport.name),self.transport.pause(function(){failed||"closed"!=self.readyState&&(debug("changing transport and sending upgrade packet"),cleanup(),self.setTransport(transport),transport.send([{type:"upgrade"}]),self.emit("upgrade",transport),transport=null,self.upgrading=!1,self.flush())})}else{debug('probe transport "%s" failed',name);var err=new Error("probe error");err.transport=transport.name,self.emit("upgradeError",err)}}))}function freezeTransport(){failed||(failed=!0,cleanup(),transport.close(),transport=null)}function onerror(err){var error=new Error("probe error: "+err);error.transport=transport.name,freezeTransport(),debug('probe transport "%s" failed because of error: %s',name,err),self.emit("upgradeError",error)}function onTransportClose(){onerror("transport closed")}function onclose(){onerror("socket closed")}function onupgrade(to){transport&&to.name!=transport.name&&(debug('"%s" works - aborting "%s"',to.name,transport.name),freezeTransport())}function cleanup(){transport.removeListener("open",onTransportOpen),transport.removeListener("error",onerror),transport.removeListener("close",onTransportClose),self.removeListener("close",onclose),self.removeListener("upgrading",onupgrade)}debug('probing transport "%s"',name);var transport=this.createTransport(name,{probe:1}),failed=!1,self=this;Socket.priorWebsocketSuccess=!1,transport.once("open",onTransportOpen),transport.once("error",onerror),transport.once("close",onTransportClose),this.once("close",onclose),this.once("upgrading",onupgrade),transport.open()},Socket.prototype.onOpen=function(){if(debug("socket open"),this.readyState="open",Socket.priorWebsocketSuccess="websocket"==this.transport.name,this.emit("open"),this.flush(),"open"==this.readyState&&this.upgrade&&this.transport.pause){debug("starting upgrade probes");for(var i=0,l=this.upgrades.length;l>i;i++)this.probe(this.upgrades[i])}},Socket.prototype.onPacket=function(packet){if("opening"==this.readyState||"open"==this.readyState)switch(debug('socket receive: type "%s", data "%s"',packet.type,packet.data),this.emit("packet",packet),this.emit("heartbeat"),packet.type){case"open":this.onHandshake(parsejson(packet.data));break;case"pong":this.setPing();break;case"error":var err=new Error("server error");err.code=packet.data,this.emit("error",err);break;case"message":this.emit("data",packet.data),this.emit("message",packet.data)}else debug('packet received with socket readyState "%s"',this.readyState)},Socket.prototype.onHandshake=function(data){this.emit("handshake",data),this.id=data.sid,this.transport.query.sid=data.sid,this.upgrades=this.filterUpgrades(data.upgrades),this.pingInterval=data.pingInterval,this.pingTimeout=data.pingTimeout,this.onOpen(),"closed"!=this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},Socket.prototype.onHeartbeat=function(timeout){clearTimeout(this.pingTimeoutTimer);var self=this;self.pingTimeoutTimer=setTimeout(function(){"closed"!=self.readyState&&self.onClose("ping timeout")},timeout||self.pingInterval+self.pingTimeout)},Socket.prototype.setPing=function(){var self=this;clearTimeout(self.pingIntervalTimer),self.pingIntervalTimer=setTimeout(function(){debug("writing ping packet - expecting pong within %sms",self.pingTimeout),self.ping(),self.onHeartbeat(self.pingTimeout)},self.pingInterval)},Socket.prototype.ping=function(){this.sendPacket("ping")},Socket.prototype.onDrain=function(){for(var i=0;i<this.prevBufferLen;i++)this.callbackBuffer[i]&&this.callbackBuffer[i]();this.writeBuffer.splice(0,this.prevBufferLen),this.callbackBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0==this.writeBuffer.length?this.emit("drain"):this.flush()},Socket.prototype.flush=function(){"closed"!=this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(debug("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},Socket.prototype.write=Socket.prototype.send=function(msg,fn){return this.sendPacket("message",msg,fn),this},Socket.prototype.sendPacket=function(type,data,fn){if("closing"!=this.readyState&&"closed"!=this.readyState){var packet={type:type,data:data};this.emit("packetCreate",packet),this.writeBuffer.push(packet),this.callbackBuffer.push(fn),this.flush()}},Socket.prototype.close=function(){function close(){self.onClose("forced close"),debug("socket closing - telling transport to close"),self.transport.close()}function cleanupAndClose(){self.removeListener("upgrade",cleanupAndClose),self.removeListener("upgradeError",cleanupAndClose),close()}function waitForUpgrade(){self.once("upgrade",cleanupAndClose),self.once("upgradeError",cleanupAndClose)}if("opening"==this.readyState||"open"==this.readyState){this.readyState="closing";var self=this;this.writeBuffer.length?this.once("drain",function(){this.upgrading?waitForUpgrade():close()}):this.upgrading?waitForUpgrade():close()}return this},Socket.prototype.onError=function(err){debug("socket error %j",err),Socket.priorWebsocketSuccess=!1,this.emit("error",err),this.onClose("transport error",err)},Socket.prototype.onClose=function(reason,desc){if("opening"==this.readyState||"open"==this.readyState||"closing"==this.readyState){debug('socket close with reason: "%s"',reason);var self=this;clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),setTimeout(function(){self.writeBuffer=[],self.callbackBuffer=[],self.prevBufferLen=0},0),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",reason,desc)}},Socket.prototype.filterUpgrades=function(upgrades){for(var filteredUpgrades=[],i=0,j=upgrades.length;j>i;i++)~index(this.transports,upgrades[i])&&filteredUpgrades.push(upgrades[i]);return filteredUpgrades}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./transport":13,"./transports":14,"component-emitter":8,debug:21,"engine.io-parser":24,indexof:39,parsejson:31,parseqs:32,parseuri:33}],13:[function(_dereq_,module){function Transport(opts){this.path=opts.path,this.hostname=opts.hostname,this.port=opts.port,this.secure=opts.secure,this.query=opts.query,this.timestampParam=opts.timestampParam,this.timestampRequests=opts.timestampRequests,this.readyState="",this.agent=opts.agent||!1,this.socket=opts.socket,this.enablesXDR=opts.enablesXDR}var parser=_dereq_("engine.io-parser"),Emitter=_dereq_("component-emitter");module.exports=Transport,Emitter(Transport.prototype),Transport.timestamps=0,Transport.prototype.onError=function(msg,desc){var err=new Error(msg);return err.type="TransportError",err.description=desc,this.emit("error",err),this},Transport.prototype.open=function(){return("closed"==this.readyState||""==this.readyState)&&(this.readyState="opening",this.doOpen()),this},Transport.prototype.close=function(){return("opening"==this.readyState||"open"==this.readyState)&&(this.doClose(),this.onClose()),this},Transport.prototype.send=function(packets){if("open"!=this.readyState)throw new Error("Transport not open");this.write(packets)},Transport.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},Transport.prototype.onData=function(data){var packet=parser.decodePacket(data,this.socket.binaryType);this.onPacket(packet)},Transport.prototype.onPacket=function(packet){this.emit("packet",packet)},Transport.prototype.onClose=function(){this.readyState="closed",this.emit("close")}},{"component-emitter":8,"engine.io-parser":24}],14:[function(_dereq_,module,exports){(function(global){function polling(opts){var xhr,xd=!1,xs=!1,jsonp=!1!==opts.jsonp;if(global.location){var isSSL="https:"==location.protocol,port=location.port;port||(port=isSSL?443:80),xd=opts.hostname!=location.hostname||port!=opts.port,xs=opts.secure!=isSSL}if(opts.xdomain=xd,opts.xscheme=xs,xhr=new XMLHttpRequest(opts),"open"in xhr&&!opts.forceJSONP)return new XHR(opts);if(!jsonp)throw new Error("JSONP disabled");return new JSONP(opts)}var XMLHttpRequest=_dereq_("xmlhttprequest"),XHR=_dereq_("./polling-xhr"),JSONP=_dereq_("./polling-jsonp"),websocket=_dereq_("./websocket");exports.polling=polling,exports.websocket=websocket}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./polling-jsonp":15,"./polling-xhr":16,"./websocket":18,xmlhttprequest:19}],15:[function(_dereq_,module){(function(global){function empty(){}function JSONPPolling(opts){Polling.call(this,opts),this.query=this.query||{},callbacks||(global.___eio||(global.___eio=[]),callbacks=global.___eio),this.index=callbacks.length;var self=this;callbacks.push(function(msg){self.onData(msg)}),this.query.j=this.index,global.document&&global.addEventListener&&global.addEventListener("beforeunload",function(){self.script&&(self.script.onerror=empty)},!1)}var Polling=_dereq_("./polling"),inherit=_dereq_("component-inherit");module.exports=JSONPPolling;var callbacks,rNewline=/\n/g,rEscapedNewline=/\\n/g;inherit(JSONPPolling,Polling),JSONPPolling.prototype.supportsBinary=!1,JSONPPolling.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),Polling.prototype.doClose.call(this)
},JSONPPolling.prototype.doPoll=function(){var self=this,script=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),script.async=!0,script.src=this.uri(),script.onerror=function(e){self.onError("jsonp poll error",e)};var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt),this.script=script;var isUAgecko="undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent);isUAgecko&&setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe),document.body.removeChild(iframe)},100)},JSONPPolling.prototype.doWrite=function(data,fn){function complete(){initIframe(),fn()}function initIframe(){if(self.iframe)try{self.form.removeChild(self.iframe)}catch(e){self.onError("jsonp polling iframe removal error",e)}try{var html='<iframe src="javascript:0" name="'+self.iframeId+'">';iframe=document.createElement(html)}catch(e){iframe=document.createElement("iframe"),iframe.name=self.iframeId,iframe.src="javascript:0"}iframe.id=self.iframeId,self.form.appendChild(iframe),self.iframe=iframe}var self=this;if(!this.form){var iframe,form=document.createElement("form"),area=document.createElement("textarea"),id=this.iframeId="eio_iframe_"+this.index;form.className="socketio",form.style.position="absolute",form.style.top="-1000px",form.style.left="-1000px",form.target=id,form.method="POST",form.setAttribute("accept-charset","utf-8"),area.name="d",form.appendChild(area),document.body.appendChild(form),this.form=form,this.area=area}this.form.action=this.uri(),initIframe(),data=data.replace(rEscapedNewline,"\\\n"),this.area.value=data.replace(rNewline,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"==self.iframe.readyState&&complete()}:this.iframe.onload=complete}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./polling":17,"component-inherit":20}],16:[function(_dereq_,module){(function(global){function empty(){}function XHR(opts){if(Polling.call(this,opts),global.location){var isSSL="https:"==location.protocol,port=location.port;port||(port=isSSL?443:80),this.xd=opts.hostname!=global.location.hostname||port!=opts.port,this.xs=opts.secure!=isSSL}}function Request(opts){this.method=opts.method||"GET",this.uri=opts.uri,this.xd=!!opts.xd,this.xs=!!opts.xs,this.async=!1!==opts.async,this.data=void 0!=opts.data?opts.data:null,this.agent=opts.agent,this.isBinary=opts.isBinary,this.supportsBinary=opts.supportsBinary,this.enablesXDR=opts.enablesXDR,this.create()}function unloadHandler(){for(var i in Request.requests)Request.requests.hasOwnProperty(i)&&Request.requests[i].abort()}var XMLHttpRequest=_dereq_("xmlhttprequest"),Polling=_dereq_("./polling"),Emitter=_dereq_("component-emitter"),inherit=_dereq_("component-inherit"),debug=_dereq_("debug")("engine.io-client:polling-xhr");module.exports=XHR,module.exports.Request=Request,inherit(XHR,Polling),XHR.prototype.supportsBinary=!0,XHR.prototype.request=function(opts){return opts=opts||{},opts.uri=this.uri(),opts.xd=this.xd,opts.xs=this.xs,opts.agent=this.agent||!1,opts.supportsBinary=this.supportsBinary,opts.enablesXDR=this.enablesXDR,new Request(opts)},XHR.prototype.doWrite=function(data,fn){var isBinary="string"!=typeof data&&void 0!==data,req=this.request({method:"POST",data:data,isBinary:isBinary}),self=this;req.on("success",fn),req.on("error",function(err){self.onError("xhr post error",err)}),this.sendXhr=req},XHR.prototype.doPoll=function(){debug("xhr poll");var req=this.request(),self=this;req.on("data",function(data){self.onData(data)}),req.on("error",function(err){self.onError("xhr poll error",err)}),this.pollXhr=req},Emitter(Request.prototype),Request.prototype.create=function(){var xhr=this.xhr=new XMLHttpRequest({agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR}),self=this;try{if(debug("xhr open %s: %s",this.method,this.uri),xhr.open(this.method,this.uri,this.async),this.supportsBinary&&(xhr.responseType="arraybuffer"),"POST"==this.method)try{this.isBinary?xhr.setRequestHeader("Content-type","application/octet-stream"):xhr.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}"withCredentials"in xhr&&(xhr.withCredentials=!0),this.hasXDR()?(xhr.onload=function(){self.onLoad()},xhr.onerror=function(){self.onError(xhr.responseText)}):xhr.onreadystatechange=function(){4==xhr.readyState&&(200==xhr.status||1223==xhr.status?self.onLoad():setTimeout(function(){self.onError(xhr.status)},0))},debug("xhr data %s",this.data),xhr.send(this.data)}catch(e){return void setTimeout(function(){self.onError(e)},0)}global.document&&(this.index=Request.requestsCount++,Request.requests[this.index]=this)},Request.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},Request.prototype.onData=function(data){this.emit("data",data),this.onSuccess()},Request.prototype.onError=function(err){this.emit("error",err),this.cleanup()},Request.prototype.cleanup=function(){if("undefined"!=typeof this.xhr&&null!==this.xhr){this.hasXDR()?this.xhr.onload=this.xhr.onerror=empty:this.xhr.onreadystatechange=empty;try{this.xhr.abort()}catch(e){}global.document&&delete Request.requests[this.index],this.xhr=null}},Request.prototype.onLoad=function(){var data;try{var contentType;try{contentType=this.xhr.getResponseHeader("Content-Type").split(";")[0]}catch(e){}data="application/octet-stream"===contentType?this.xhr.response:this.supportsBinary?"ok":this.xhr.responseText}catch(e){this.onError(e)}null!=data&&this.onData(data)},Request.prototype.hasXDR=function(){return"undefined"!=typeof global.XDomainRequest&&!this.xs&&this.enablesXDR},Request.prototype.abort=function(){this.cleanup()},global.document&&(Request.requestsCount=0,Request.requests={},global.attachEvent?global.attachEvent("onunload",unloadHandler):global.addEventListener&&global.addEventListener("beforeunload",unloadHandler,!1))}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./polling":17,"component-emitter":8,"component-inherit":20,debug:21,xmlhttprequest:19}],17:[function(_dereq_,module){function Polling(opts){var forceBase64=opts&&opts.forceBase64;(!hasXHR2||forceBase64)&&(this.supportsBinary=!1),Transport.call(this,opts)}var Transport=_dereq_("../transport"),parseqs=_dereq_("parseqs"),parser=_dereq_("engine.io-parser"),inherit=_dereq_("component-inherit"),debug=_dereq_("debug")("engine.io-client:polling");module.exports=Polling;var hasXHR2=function(){var XMLHttpRequest=_dereq_("xmlhttprequest"),xhr=new XMLHttpRequest({xdomain:!1});return null!=xhr.responseType}();inherit(Polling,Transport),Polling.prototype.name="polling",Polling.prototype.doOpen=function(){this.poll()},Polling.prototype.pause=function(onPause){function pause(){debug("paused"),self.readyState="paused",onPause()}var self=this;if(this.readyState="pausing",this.polling||!this.writable){var total=0;this.polling&&(debug("we are currently polling - waiting to pause"),total++,this.once("pollComplete",function(){debug("pre-pause polling complete"),--total||pause()})),this.writable||(debug("we are currently writing - waiting to pause"),total++,this.once("drain",function(){debug("pre-pause writing complete"),--total||pause()}))}else pause()},Polling.prototype.poll=function(){debug("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},Polling.prototype.onData=function(data){var self=this;debug("polling got data %s",data);var callback=function(packet){return"opening"==self.readyState&&self.onOpen(),"close"==packet.type?(self.onClose(),!1):void self.onPacket(packet)};parser.decodePayload(data,this.socket.binaryType,callback),"closed"!=this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"==this.readyState?this.poll():debug('ignoring poll - transport state "%s"',this.readyState))},Polling.prototype.doClose=function(){function close(){debug("writing close packet"),self.write([{type:"close"}])}var self=this;"open"==this.readyState?(debug("transport open - closing"),close()):(debug("transport not open - deferring close"),this.once("open",close))},Polling.prototype.write=function(packets){var self=this;this.writable=!1;var callbackfn=function(){self.writable=!0,self.emit("drain")},self=this;parser.encodePayload(packets,this.supportsBinary,function(data){self.doWrite(data,callbackfn)})},Polling.prototype.uri=function(){var query=this.query||{},schema=this.secure?"https":"http",port="";return!1!==this.timestampRequests&&(query[this.timestampParam]=+new Date+"-"+Transport.timestamps++),this.supportsBinary||query.sid||(query.b64=1),query=parseqs.encode(query),this.port&&("https"==schema&&443!=this.port||"http"==schema&&80!=this.port)&&(port=":"+this.port),query.length&&(query="?"+query),schema+"://"+this.hostname+port+this.path+query}},{"../transport":13,"component-inherit":20,debug:21,"engine.io-parser":24,parseqs:32,xmlhttprequest:19}],18:[function(_dereq_,module){function WS(opts){var forceBase64=opts&&opts.forceBase64;forceBase64&&(this.supportsBinary=!1),Transport.call(this,opts)}var Transport=_dereq_("../transport"),parser=_dereq_("engine.io-parser"),parseqs=_dereq_("parseqs"),inherit=_dereq_("component-inherit"),debug=_dereq_("debug")("engine.io-client:websocket"),WebSocket=_dereq_("ws");module.exports=WS,inherit(WS,Transport),WS.prototype.name="websocket",WS.prototype.supportsBinary=!0,WS.prototype.doOpen=function(){if(this.check()){var uri=this.uri(),protocols=void 0,opts={agent:this.agent};this.ws=new WebSocket(uri,protocols,opts),void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.binaryType="arraybuffer",this.addEventListeners()}},WS.prototype.addEventListeners=function(){var self=this;this.ws.onopen=function(){self.onOpen()},this.ws.onclose=function(){self.onClose()},this.ws.onmessage=function(ev){self.onData(ev.data)},this.ws.onerror=function(e){self.onError("websocket error",e)}},"undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)&&(WS.prototype.onData=function(data){var self=this;setTimeout(function(){Transport.prototype.onData.call(self,data)},0)}),WS.prototype.write=function(packets){function ondrain(){self.writable=!0,self.emit("drain")}var self=this;this.writable=!1;for(var i=0,l=packets.length;l>i;i++)parser.encodePacket(packets[i],this.supportsBinary,function(data){try{self.ws.send(data)}catch(e){debug("websocket closed before onclose event")}});setTimeout(ondrain,0)},WS.prototype.onClose=function(){Transport.prototype.onClose.call(this)},WS.prototype.doClose=function(){"undefined"!=typeof this.ws&&this.ws.close()},WS.prototype.uri=function(){var query=this.query||{},schema=this.secure?"wss":"ws",port="";return this.port&&("wss"==schema&&443!=this.port||"ws"==schema&&80!=this.port)&&(port=":"+this.port),this.timestampRequests&&(query[this.timestampParam]=+new Date),this.supportsBinary||(query.b64=1),query=parseqs.encode(query),query.length&&(query="?"+query),schema+"://"+this.hostname+port+this.path+query},WS.prototype.check=function(){return!(!WebSocket||"__initialize"in WebSocket&&this.name===WS.prototype.name)}},{"../transport":13,"component-inherit":20,debug:21,"engine.io-parser":24,parseqs:32,ws:34}],19:[function(_dereq_,module){var hasCORS=_dereq_("has-cors");module.exports=function(opts){var xdomain=opts.xdomain,xscheme=opts.xscheme,enablesXDR=opts.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!xdomain||hasCORS))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!xscheme&&enablesXDR)return new XDomainRequest}catch(e){}if(!xdomain)try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}},{"has-cors":37}],20:[function(_dereq_,module){module.exports=function(a,b){var fn=function(){};fn.prototype=b.prototype,a.prototype=new fn,a.prototype.constructor=a}},{}],21:[function(_dereq_,module,exports){function useColors(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31}function formatArgs(){var args=arguments,useColors=this.useColors;if(args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff),!useColors)return args;var c="color: "+this.color;args=[args[0],c,"color: inherit"].concat(Array.prototype.slice.call(args,1));var index=0,lastC=0;return args[0].replace(/%[a-z%]/g,function(match){"%"!==match&&(index++,"%c"===match&&(lastC=index))}),args.splice(lastC,0,c),args}function log(){return"object"==typeof console&&"function"==typeof console.log&&Function.prototype.apply.call(console.log,console,arguments)}function save(namespaces){try{null==namespaces?localStorage.removeItem("debug"):localStorage.debug=namespaces}catch(e){}}function load(){var r;try{r=localStorage.debug}catch(e){}return r}exports=module.exports=_dereq_("./debug"),exports.log=log,exports.formatArgs=formatArgs,exports.save=save,exports.load=load,exports.useColors=useColors,exports.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],exports.formatters.j=function(v){return JSON.stringify(v)},exports.enable(load())},{"./debug":22}],22:[function(_dereq_,module,exports){function selectColor(){return exports.colors[prevColor++%exports.colors.length]}function debug(namespace){function disabled(){}function enabled(){var self=enabled,curr=+new Date,ms=curr-(prevTime||curr);self.diff=ms,self.prev=prevTime,self.curr=curr,prevTime=curr,null==self.useColors&&(self.useColors=exports.useColors()),null==self.color&&self.useColors&&(self.color=selectColor());var args=Array.prototype.slice.call(arguments);args[0]=exports.coerce(args[0]),"string"!=typeof args[0]&&(args=["%o"].concat(args));var index=0;args[0]=args[0].replace(/%([a-z%])/g,function(match,format){if("%"===match)return match;index++;var formatter=exports.formatters[format];if("function"==typeof formatter){var val=args[index];match=formatter.call(self,val),args.splice(index,1),index--}return match}),"function"==typeof exports.formatArgs&&(args=exports.formatArgs.apply(self,args));var logFn=enabled.log||exports.log||console.log.bind(console);logFn.apply(self,args)}disabled.enabled=!1,enabled.enabled=!0;var fn=exports.enabled(namespace)?enabled:disabled;return fn.namespace=namespace,fn}function enable(namespaces){exports.save(namespaces);for(var split=(namespaces||"").split(/[\s,]+/),len=split.length,i=0;len>i;i++)split[i]&&(namespaces=split[i].replace(/\*/g,".*?"),"-"===namespaces[0]?exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$")):exports.names.push(new RegExp("^"+namespaces+"$")))}function disable(){exports.enable("")}function enabled(name){var i,len;for(i=0,len=exports.skips.length;len>i;i++)if(exports.skips[i].test(name))return!1;for(i=0,len=exports.names.length;len>i;i++)if(exports.names[i].test(name))return!0;return!1}function coerce(val){return val instanceof Error?val.stack||val.message:val}exports=module.exports=debug,exports.coerce=coerce,exports.disable=disable,exports.enable=enable,exports.enabled=enabled,exports.humanize=_dereq_("ms"),exports.names=[],exports.skips=[],exports.formatters={};var prevTime,prevColor=0},{ms:23}],23:[function(_dereq_,module){function parse(str){var match=/^((?:\d+)?\.?\d+) *(ms|seconds?|s|minutes?|m|hours?|h|days?|d|years?|y)?$/i.exec(str);if(match){var n=parseFloat(match[1]),type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"h":return n*h;case"minutes":case"minute":case"m":return n*m;case"seconds":case"second":case"s":return n*s;case"ms":return n}}}function short(ms){return ms>=d?Math.round(ms/d)+"d":ms>=h?Math.round(ms/h)+"h":ms>=m?Math.round(ms/m)+"m":ms>=s?Math.round(ms/s)+"s":ms+"ms"}function long(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){return n>ms?void 0:1.5*n>ms?Math.floor(ms/n)+" "+name:Math.ceil(ms/n)+" "+name+"s"}var s=1e3,m=60*s,h=60*m,d=24*h,y=365.25*d;module.exports=function(val,options){return options=options||{},"string"==typeof val?parse(val):options["long"]?long(val):short(val)}},{}],24:[function(_dereq_,module,exports){(function(global){function encodeArrayBuffer(packet,supportsBinary,callback){if(!supportsBinary)return exports.encodeBase64Packet(packet,callback);var data=packet.data,contentArray=new Uint8Array(data),resultBuffer=new Uint8Array(1+data.byteLength);resultBuffer[0]=packets[packet.type];for(var i=0;i<contentArray.length;i++)resultBuffer[i+1]=contentArray[i];return callback(resultBuffer.buffer)}function encodeBlobAsArrayBuffer(packet,supportsBinary,callback){if(!supportsBinary)return exports.encodeBase64Packet(packet,callback);var fr=new FileReader;return fr.onload=function(){packet.data=fr.result,exports.encodePacket(packet,supportsBinary,!0,callback)},fr.readAsArrayBuffer(packet.data)}function encodeBlob(packet,supportsBinary,callback){if(!supportsBinary)return exports.encodeBase64Packet(packet,callback);if(isAndroid)return encodeBlobAsArrayBuffer(packet,supportsBinary,callback);var length=new Uint8Array(1);length[0]=packets[packet.type];var blob=new Blob([length.buffer,packet.data]);return callback(blob)}function map(ary,each,done){for(var result=new Array(ary.length),next=after(ary.length,done),eachWithIndex=function(i,el,cb){each(el,function(error,msg){result[i]=msg,cb(error,result)})},i=0;i<ary.length;i++)eachWithIndex(i,ary[i],next)}var keys=_dereq_("./keys"),sliceBuffer=_dereq_("arraybuffer.slice"),base64encoder=_dereq_("base64-arraybuffer"),after=_dereq_("after"),utf8=_dereq_("utf8"),isAndroid=navigator.userAgent.match(/Android/i);exports.protocol=3;var packets=exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},packetslist=keys(packets),err={type:"error",data:"parser error"},Blob=_dereq_("blob");exports.encodePacket=function(packet,supportsBinary,utf8encode,callback){"function"==typeof supportsBinary&&(callback=supportsBinary,supportsBinary=!1),"function"==typeof utf8encode&&(callback=utf8encode,utf8encode=null);var data=void 0===packet.data?void 0:packet.data.buffer||packet.data;if(global.ArrayBuffer&&data instanceof ArrayBuffer)return encodeArrayBuffer(packet,supportsBinary,callback);if(Blob&&data instanceof global.Blob)return encodeBlob(packet,supportsBinary,callback);var encoded=packets[packet.type];return void 0!==packet.data&&(encoded+=utf8encode?utf8.encode(String(packet.data)):String(packet.data)),callback(""+encoded)},exports.encodeBase64Packet=function(packet,callback){var message="b"+exports.packets[packet.type];if(Blob&&packet.data instanceof Blob){var fr=new FileReader;return fr.onload=function(){var b64=fr.result.split(",")[1];callback(message+b64)},fr.readAsDataURL(packet.data)}var b64data;try{b64data=String.fromCharCode.apply(null,new Uint8Array(packet.data))}catch(e){for(var typed=new Uint8Array(packet.data),basic=new Array(typed.length),i=0;i<typed.length;i++)basic[i]=typed[i];b64data=String.fromCharCode.apply(null,basic)}return message+=global.btoa(b64data),callback(message)},exports.decodePacket=function(data,binaryType,utf8decode){if("string"==typeof data||void 0===data){if("b"==data.charAt(0))return exports.decodeBase64Packet(data.substr(1),binaryType);if(utf8decode)try{data=utf8.decode(data)}catch(e){return err}var type=data.charAt(0);return Number(type)==type&&packetslist[type]?data.length>1?{type:packetslist[type],data:data.substring(1)}:{type:packetslist[type]}:err}var asArray=new Uint8Array(data),type=asArray[0],rest=sliceBuffer(data,1);return Blob&&"blob"===binaryType&&(rest=new Blob([rest])),{type:packetslist[type],data:rest}},exports.decodeBase64Packet=function(msg,binaryType){var type=packetslist[msg.charAt(0)];if(!global.ArrayBuffer)return{type:type,data:{base64:!0,data:msg.substr(1)}};var data=base64encoder.decode(msg.substr(1));return"blob"===binaryType&&Blob&&(data=new Blob([data])),{type:type,data:data}},exports.encodePayload=function(packets,supportsBinary,callback){function setLengthHeader(message){return message.length+":"+message}function encodeOne(packet,doneCallback){exports.encodePacket(packet,supportsBinary,!0,function(message){doneCallback(null,setLengthHeader(message))})}return"function"==typeof supportsBinary&&(callback=supportsBinary,supportsBinary=null),supportsBinary?Blob&&!isAndroid?exports.encodePayloadAsBlob(packets,callback):exports.encodePayloadAsArrayBuffer(packets,callback):packets.length?void map(packets,encodeOne,function(err,results){return callback(results.join(""))}):callback("0:")},exports.decodePayload=function(data,binaryType,callback){if("string"!=typeof data)return exports.decodePayloadAsBinary(data,binaryType,callback);"function"==typeof binaryType&&(callback=binaryType,binaryType=null);var packet;if(""==data)return callback(err,0,1);for(var n,msg,length="",i=0,l=data.length;l>i;i++){var chr=data.charAt(i);if(":"!=chr)length+=chr;else{if(""==length||length!=(n=Number(length)))return callback(err,0,1);if(msg=data.substr(i+1,n),length!=msg.length)return callback(err,0,1);if(msg.length){if(packet=exports.decodePacket(msg,binaryType,!0),err.type==packet.type&&err.data==packet.data)return callback(err,0,1);var ret=callback(packet,i+n,l);if(!1===ret)return}i+=n,length=""}}return""!=length?callback(err,0,1):void 0},exports.encodePayloadAsArrayBuffer=function(packets,callback){function encodeOne(packet,doneCallback){exports.encodePacket(packet,!0,!0,function(data){return doneCallback(null,data)})}return packets.length?void map(packets,encodeOne,function(err,encodedPackets){var totalLength=encodedPackets.reduce(function(acc,p){var len;return len="string"==typeof p?p.length:p.byteLength,acc+len.toString().length+len+2},0),resultArray=new Uint8Array(totalLength),bufferIndex=0;return encodedPackets.forEach(function(p){var isString="string"==typeof p,ab=p;if(isString){for(var view=new Uint8Array(p.length),i=0;i<p.length;i++)view[i]=p.charCodeAt(i);ab=view.buffer}resultArray[bufferIndex++]=isString?0:1;for(var lenStr=ab.byteLength.toString(),i=0;i<lenStr.length;i++)resultArray[bufferIndex++]=parseInt(lenStr[i]);resultArray[bufferIndex++]=255;for(var view=new Uint8Array(ab),i=0;i<view.length;i++)resultArray[bufferIndex++]=view[i]}),callback(resultArray.buffer)}):callback(new ArrayBuffer(0))},exports.encodePayloadAsBlob=function(packets,callback){function encodeOne(packet,doneCallback){exports.encodePacket(packet,!0,!0,function(encoded){var binaryIdentifier=new Uint8Array(1);if(binaryIdentifier[0]=1,"string"==typeof encoded){for(var view=new Uint8Array(encoded.length),i=0;i<encoded.length;i++)view[i]=encoded.charCodeAt(i);encoded=view.buffer,binaryIdentifier[0]=0}for(var len=encoded instanceof ArrayBuffer?encoded.byteLength:encoded.size,lenStr=len.toString(),lengthAry=new Uint8Array(lenStr.length+1),i=0;i<lenStr.length;i++)lengthAry[i]=parseInt(lenStr[i]);if(lengthAry[lenStr.length]=255,Blob){var blob=new Blob([binaryIdentifier.buffer,lengthAry.buffer,encoded]);doneCallback(null,blob)}})}map(packets,encodeOne,function(err,results){return callback(new Blob(results))})},exports.decodePayloadAsBinary=function(data,binaryType,callback){"function"==typeof binaryType&&(callback=binaryType,binaryType=null);for(var bufferTail=data,buffers=[],numberTooLong=!1;bufferTail.byteLength>0;){for(var tailArray=new Uint8Array(bufferTail),isString=0===tailArray[0],msgLength="",i=1;255!=tailArray[i];i++){if(msgLength.length>310){numberTooLong=!0;break}msgLength+=tailArray[i]}if(numberTooLong)return callback(err,0,1);bufferTail=sliceBuffer(bufferTail,2+msgLength.length),msgLength=parseInt(msgLength);var msg=sliceBuffer(bufferTail,0,msgLength);if(isString)try{msg=String.fromCharCode.apply(null,new Uint8Array(msg))}catch(e){var typed=new Uint8Array(msg);msg="";for(var i=0;i<typed.length;i++)msg+=String.fromCharCode(typed[i])}buffers.push(msg),bufferTail=sliceBuffer(bufferTail,msgLength)}var total=buffers.length;buffers.forEach(function(buffer,i){callback(exports.decodePacket(buffer,binaryType,!0),i,total)})}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./keys":25,after:26,"arraybuffer.slice":27,"base64-arraybuffer":28,blob:29,utf8:30}],25:[function(_dereq_,module){module.exports=Object.keys||function(obj){var arr=[],has=Object.prototype.hasOwnProperty;for(var i in obj)has.call(obj,i)&&arr.push(i);return arr}},{}],26:[function(_dereq_,module){function after(count,callback,err_cb){function proxy(err,result){if(proxy.count<=0)throw new Error("after called too many times");--proxy.count,err?(bail=!0,callback(err),callback=err_cb):0!==proxy.count||bail||callback(null,result)}var bail=!1;return err_cb=err_cb||noop,proxy.count=count,0===count?callback():proxy}function noop(){}module.exports=after},{}],27:[function(_dereq_,module){module.exports=function(arraybuffer,start,end){var bytes=arraybuffer.byteLength;if(start=start||0,end=end||bytes,arraybuffer.slice)return arraybuffer.slice(start,end);if(0>start&&(start+=bytes),0>end&&(end+=bytes),end>bytes&&(end=bytes),start>=bytes||start>=end||0===bytes)return new ArrayBuffer(0);for(var abv=new Uint8Array(arraybuffer),result=new Uint8Array(end-start),i=start,ii=0;end>i;i++,ii++)result[ii]=abv[i];return result.buffer}},{}],28:[function(_dereq_,module,exports){!function(chars){"use strict";exports.encode=function(arraybuffer){var i,bytes=new Uint8Array(arraybuffer),len=bytes.length,base64="";for(i=0;len>i;i+=3)base64+=chars[bytes[i]>>2],base64+=chars[(3&bytes[i])<<4|bytes[i+1]>>4],base64+=chars[(15&bytes[i+1])<<2|bytes[i+2]>>6],base64+=chars[63&bytes[i+2]];return len%3===2?base64=base64.substring(0,base64.length-1)+"=":len%3===1&&(base64=base64.substring(0,base64.length-2)+"=="),base64},exports.decode=function(base64){var i,encoded1,encoded2,encoded3,encoded4,bufferLength=.75*base64.length,len=base64.length,p=0;"="===base64[base64.length-1]&&(bufferLength--,"="===base64[base64.length-2]&&bufferLength--);var arraybuffer=new ArrayBuffer(bufferLength),bytes=new Uint8Array(arraybuffer);for(i=0;len>i;i+=4)encoded1=chars.indexOf(base64[i]),encoded2=chars.indexOf(base64[i+1]),encoded3=chars.indexOf(base64[i+2]),encoded4=chars.indexOf(base64[i+3]),bytes[p++]=encoded1<<2|encoded2>>4,bytes[p++]=(15&encoded2)<<4|encoded3>>2,bytes[p++]=(3&encoded3)<<6|63&encoded4;return arraybuffer}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/")},{}],29:[function(_dereq_,module){(function(global){function BlobBuilderConstructor(ary,options){options=options||{};for(var bb=new BlobBuilder,i=0;i<ary.length;i++)bb.append(ary[i]);return options.type?bb.getBlob(options.type):bb.getBlob()}var BlobBuilder=global.BlobBuilder||global.WebKitBlobBuilder||global.MSBlobBuilder||global.MozBlobBuilder,blobSupported=function(){try{var b=new Blob(["hi"]);return 2==b.size}catch(e){return!1}}(),blobBuilderSupported=BlobBuilder&&BlobBuilder.prototype.append&&BlobBuilder.prototype.getBlob;module.exports=function(){return blobSupported?global.Blob:blobBuilderSupported?BlobBuilderConstructor:void 0}()}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],30:[function(_dereq_,module,exports){(function(global){!function(root){function ucs2decode(string){for(var value,extra,output=[],counter=0,length=string.length;length>counter;)value=string.charCodeAt(counter++),value>=55296&&56319>=value&&length>counter?(extra=string.charCodeAt(counter++),56320==(64512&extra)?output.push(((1023&value)<<10)+(1023&extra)+65536):(output.push(value),counter--)):output.push(value);return output}function ucs2encode(array){for(var value,length=array.length,index=-1,output="";++index<length;)value=array[index],value>65535&&(value-=65536,output+=stringFromCharCode(value>>>10&1023|55296),value=56320|1023&value),output+=stringFromCharCode(value);return output}function createByte(codePoint,shift){return stringFromCharCode(codePoint>>shift&63|128)}function encodeCodePoint(codePoint){if(0==(4294967168&codePoint))return stringFromCharCode(codePoint);var symbol="";return 0==(4294965248&codePoint)?symbol=stringFromCharCode(codePoint>>6&31|192):0==(4294901760&codePoint)?(symbol=stringFromCharCode(codePoint>>12&15|224),symbol+=createByte(codePoint,6)):0==(4292870144&codePoint)&&(symbol=stringFromCharCode(codePoint>>18&7|240),symbol+=createByte(codePoint,12),symbol+=createByte(codePoint,6)),symbol+=stringFromCharCode(63&codePoint|128)}function utf8encode(string){for(var codePoint,codePoints=ucs2decode(string),length=codePoints.length,index=-1,byteString="";++index<length;)codePoint=codePoints[index],byteString+=encodeCodePoint(codePoint);return byteString}function readContinuationByte(){if(byteIndex>=byteCount)throw Error("Invalid byte index");var continuationByte=255&byteArray[byteIndex];if(byteIndex++,128==(192&continuationByte))return 63&continuationByte;throw Error("Invalid continuation byte")}function decodeSymbol(){var byte1,byte2,byte3,byte4,codePoint;if(byteIndex>byteCount)throw Error("Invalid byte index");if(byteIndex==byteCount)return!1;if(byte1=255&byteArray[byteIndex],byteIndex++,0==(128&byte1))return byte1;if(192==(224&byte1)){var byte2=readContinuationByte();if(codePoint=(31&byte1)<<6|byte2,codePoint>=128)return codePoint;throw Error("Invalid continuation byte")}if(224==(240&byte1)){if(byte2=readContinuationByte(),byte3=readContinuationByte(),codePoint=(15&byte1)<<12|byte2<<6|byte3,codePoint>=2048)return codePoint;throw Error("Invalid continuation byte")}if(240==(248&byte1)&&(byte2=readContinuationByte(),byte3=readContinuationByte(),byte4=readContinuationByte(),codePoint=(15&byte1)<<18|byte2<<12|byte3<<6|byte4,codePoint>=65536&&1114111>=codePoint))return codePoint;throw Error("Invalid UTF-8 detected")}function utf8decode(byteString){byteArray=ucs2decode(byteString),byteCount=byteArray.length,byteIndex=0;for(var tmp,codePoints=[];(tmp=decodeSymbol())!==!1;)codePoints.push(tmp);return ucs2encode(codePoints)}var freeExports="object"==typeof exports&&exports,freeModule="object"==typeof module&&module&&module.exports==freeExports&&module,freeGlobal="object"==typeof global&&global;(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal)&&(root=freeGlobal);var byteArray,byteCount,byteIndex,stringFromCharCode=String.fromCharCode,utf8={version:"2.0.0",encode:utf8encode,decode:utf8decode};if("function"==typeof define&&"object"==typeof define.amd&&define.amd)define(function(){return utf8});else if(freeExports&&!freeExports.nodeType)if(freeModule)freeModule.exports=utf8;else{var object={},hasOwnProperty=object.hasOwnProperty;for(var key in utf8)hasOwnProperty.call(utf8,key)&&(freeExports[key]=utf8[key])}else root.utf8=utf8}(this)}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],31:[function(_dereq_,module){(function(global){var rvalidchars=/^[\],:{}\s]*$/,rvalidescape=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,rvalidtokens=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,rvalidbraces=/(?:^|:|,)(?:\s*\[)+/g,rtrimLeft=/^\s+/,rtrimRight=/\s+$/;module.exports=function(data){return"string"==typeof data&&data?(data=data.replace(rtrimLeft,"").replace(rtrimRight,""),global.JSON&&JSON.parse?JSON.parse(data):rvalidchars.test(data.replace(rvalidescape,"@").replace(rvalidtokens,"]").replace(rvalidbraces,""))?new Function("return "+data)():void 0):null}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],32:[function(_dereq_,module,exports){exports.encode=function(obj){var str="";for(var i in obj)obj.hasOwnProperty(i)&&(str.length&&(str+="&"),str+=encodeURIComponent(i)+"="+encodeURIComponent(obj[i]));return str},exports.decode=function(qs){for(var qry={},pairs=qs.split("&"),i=0,l=pairs.length;l>i;i++){var pair=pairs[i].split("=");qry[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1])}return qry}},{}],33:[function(_dereq_,module){var re=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];
module.exports=function(str){var src=str,b=str.indexOf("["),e=str.indexOf("]");-1!=b&&-1!=e&&(str=str.substring(0,b)+str.substring(b,e).replace(/:/g,";")+str.substring(e,str.length));for(var m=re.exec(str||""),uri={},i=14;i--;)uri[parts[i]]=m[i]||"";return-1!=b&&-1!=e&&(uri.source=src,uri.host=uri.host.substring(1,uri.host.length-1).replace(/;/g,":"),uri.authority=uri.authority.replace("[","").replace("]","").replace(/;/g,":"),uri.ipv6uri=!0),uri}},{}],34:[function(_dereq_,module){function ws(uri,protocols){var instance;return instance=protocols?new WebSocket(uri,protocols):new WebSocket(uri)}var global=function(){return this}(),WebSocket=global.WebSocket||global.MozWebSocket;module.exports=WebSocket?ws:null,WebSocket&&(ws.prototype=WebSocket.prototype)},{}],35:[function(_dereq_,module){(function(global){function hasBinary(data){function _hasBinary(obj){if(!obj)return!1;if(global.Buffer&&global.Buffer.isBuffer(obj)||global.ArrayBuffer&&obj instanceof ArrayBuffer||global.Blob&&obj instanceof Blob||global.File&&obj instanceof File)return!0;if(isArray(obj)){for(var i=0;i<obj.length;i++)if(_hasBinary(obj[i]))return!0}else if(obj&&"object"==typeof obj){obj.toJSON&&(obj=obj.toJSON());for(var key in obj)if(obj.hasOwnProperty(key)&&_hasBinary(obj[key]))return!0}return!1}return _hasBinary(data)}var isArray=_dereq_("isarray");module.exports=hasBinary}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{isarray:36}],36:[function(_dereq_,module){module.exports=Array.isArray||function(arr){return"[object Array]"==Object.prototype.toString.call(arr)}},{}],37:[function(_dereq_,module){var global=_dereq_("global");try{module.exports="XMLHttpRequest"in global&&"withCredentials"in new global.XMLHttpRequest}catch(err){module.exports=!1}},{global:38}],38:[function(_dereq_,module){module.exports=function(){return this}()},{}],39:[function(_dereq_,module){var indexOf=[].indexOf;module.exports=function(arr,obj){if(indexOf)return arr.indexOf(obj);for(var i=0;i<arr.length;++i)if(arr[i]===obj)return i;return-1}},{}],40:[function(_dereq_,module,exports){var has=Object.prototype.hasOwnProperty;exports.keys=Object.keys||function(obj){var keys=[];for(var key in obj)has.call(obj,key)&&keys.push(key);return keys},exports.values=function(obj){var vals=[];for(var key in obj)has.call(obj,key)&&vals.push(obj[key]);return vals},exports.merge=function(a,b){for(var key in b)has.call(b,key)&&(a[key]=b[key]);return a},exports.length=function(obj){return exports.keys(obj).length},exports.isEmpty=function(obj){return 0==exports.length(obj)}},{}],41:[function(_dereq_,module){var re=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];module.exports=function(str){for(var m=re.exec(str||""),uri={},i=14;i--;)uri[parts[i]]=m[i]||"";return uri}},{}],42:[function(_dereq_,module,exports){(function(global){var isArray=_dereq_("isarray"),isBuf=_dereq_("./is-buffer");exports.deconstructPacket=function(packet){function _deconstructPacket(data){if(!data)return data;if(isBuf(data)){var placeholder={_placeholder:!0,num:buffers.length};return buffers.push(data),placeholder}if(isArray(data)){for(var newData=new Array(data.length),i=0;i<data.length;i++)newData[i]=_deconstructPacket(data[i]);return newData}if("object"==typeof data&&!(data instanceof Date)){var newData={};for(var key in data)newData[key]=_deconstructPacket(data[key]);return newData}return data}var buffers=[],packetData=packet.data,pack=packet;return pack.data=_deconstructPacket(packetData),pack.attachments=buffers.length,{packet:pack,buffers:buffers}},exports.reconstructPacket=function(packet,buffers){function _reconstructPacket(data){if(data&&data._placeholder){var buf=buffers[data.num];return buf}if(isArray(data)){for(var i=0;i<data.length;i++)data[i]=_reconstructPacket(data[i]);return data}if(data&&"object"==typeof data){for(var key in data)data[key]=_reconstructPacket(data[key]);return data}return data}return packet.data=_reconstructPacket(packet.data),packet.attachments=void 0,packet},exports.removeBlobs=function(data,callback){function _removeBlobs(obj,curKey,containingObject){if(!obj)return obj;if(global.Blob&&obj instanceof Blob||global.File&&obj instanceof File){pendingBlobs++;var fileReader=new FileReader;fileReader.onload=function(){containingObject?containingObject[curKey]=this.result:bloblessData=this.result,--pendingBlobs||callback(bloblessData)},fileReader.readAsArrayBuffer(obj)}else if(isArray(obj))for(var i=0;i<obj.length;i++)_removeBlobs(obj[i],i,obj);else if(obj&&"object"==typeof obj&&!isBuf(obj))for(var key in obj)_removeBlobs(obj[key],key,obj)}var pendingBlobs=0,bloblessData=data;_removeBlobs(bloblessData),pendingBlobs||callback(bloblessData)}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./is-buffer":44,isarray:45}],43:[function(_dereq_,module,exports){function Encoder(){}function encodeAsString(obj){var str="",nsp=!1;return str+=obj.type,(exports.BINARY_EVENT==obj.type||exports.BINARY_ACK==obj.type)&&(str+=obj.attachments,str+="-"),obj.nsp&&"/"!=obj.nsp&&(nsp=!0,str+=obj.nsp),null!=obj.id&&(nsp&&(str+=",",nsp=!1),str+=obj.id),null!=obj.data&&(nsp&&(str+=","),str+=json.stringify(obj.data)),debug("encoded %j as %s",obj,str),str}function encodeAsBinary(obj,callback){function writeEncoding(bloblessData){var deconstruction=binary.deconstructPacket(bloblessData),pack=encodeAsString(deconstruction.packet),buffers=deconstruction.buffers;buffers.unshift(pack),callback(buffers)}binary.removeBlobs(obj,writeEncoding)}function Decoder(){this.reconstructor=null}function decodeString(str){var p={},i=0;if(p.type=Number(str.charAt(0)),null==exports.types[p.type])return error();if(exports.BINARY_EVENT==p.type||exports.BINARY_ACK==p.type){for(p.attachments="";"-"!=str.charAt(++i);)p.attachments+=str.charAt(i);p.attachments=Number(p.attachments)}if("/"==str.charAt(i+1))for(p.nsp="";++i;){var c=str.charAt(i);if(","==c)break;if(p.nsp+=c,i+1==str.length)break}else p.nsp="/";var next=str.charAt(i+1);if(""!=next&&Number(next)==next){for(p.id="";++i;){var c=str.charAt(i);if(null==c||Number(c)!=c){--i;break}if(p.id+=str.charAt(i),i+1==str.length)break}p.id=Number(p.id)}if(str.charAt(++i))try{p.data=json.parse(str.substr(i))}catch(e){return error()}return debug("decoded %s as %j",str,p),p}function BinaryReconstructor(packet){this.reconPack=packet,this.buffers=[]}function error(){return{type:exports.ERROR,data:"parser error"}}var debug=_dereq_("debug")("socket.io-parser"),json=_dereq_("json3"),Emitter=(_dereq_("isarray"),_dereq_("component-emitter")),binary=_dereq_("./binary"),isBuf=_dereq_("./is-buffer");exports.protocol=4,exports.types=["CONNECT","DISCONNECT","EVENT","BINARY_EVENT","ACK","BINARY_ACK","ERROR"],exports.CONNECT=0,exports.DISCONNECT=1,exports.EVENT=2,exports.ACK=3,exports.ERROR=4,exports.BINARY_EVENT=5,exports.BINARY_ACK=6,exports.Encoder=Encoder,exports.Decoder=Decoder,Encoder.prototype.encode=function(obj,callback){if(debug("encoding packet %j",obj),exports.BINARY_EVENT==obj.type||exports.BINARY_ACK==obj.type)encodeAsBinary(obj,callback);else{var encoding=encodeAsString(obj);callback([encoding])}},Emitter(Decoder.prototype),Decoder.prototype.add=function(obj){var packet;if("string"==typeof obj)packet=decodeString(obj),exports.BINARY_EVENT==packet.type||exports.BINARY_ACK==packet.type?(this.reconstructor=new BinaryReconstructor(packet),0==this.reconstructor.reconPack.attachments&&this.emit("decoded",packet)):this.emit("decoded",packet);else{if(!isBuf(obj)&&!obj.base64)throw new Error("Unknown type: "+obj);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");packet=this.reconstructor.takeBinaryData(obj),packet&&(this.reconstructor=null,this.emit("decoded",packet))}},Decoder.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},BinaryReconstructor.prototype.takeBinaryData=function(binData){if(this.buffers.push(binData),this.buffers.length==this.reconPack.attachments){var packet=binary.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),packet}return null},BinaryReconstructor.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}},{"./binary":42,"./is-buffer":44,"component-emitter":8,debug:9,isarray:45,json3:46}],44:[function(_dereq_,module){(function(global){function isBuf(obj){return global.Buffer&&global.Buffer.isBuffer(obj)||global.ArrayBuffer&&obj instanceof ArrayBuffer}module.exports=isBuf}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],45:[function(_dereq_,module){module.exports=_dereq_(36)},{}],46:[function(_dereq_,module,exports){!function(window){function has(name){if(has[name]!==undef)return has[name];var isSupported;if("bug-string-char-index"==name)isSupported="a"!="a"[0];else if("json"==name)isSupported=has("json-stringify")&&has("json-parse");else{var value,serialized='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if("json-stringify"==name){var stringify=JSON3.stringify,stringifySupported="function"==typeof stringify&&isExtended;if(stringifySupported){(value=function(){return 1}).toJSON=value;try{stringifySupported="0"===stringify(0)&&"0"===stringify(new Number)&&'""'==stringify(new String)&&stringify(getClass)===undef&&stringify(undef)===undef&&stringify()===undef&&"1"===stringify(value)&&"[1]"==stringify([value])&&"[null]"==stringify([undef])&&"null"==stringify(null)&&"[null,null,null]"==stringify([undef,getClass,null])&&stringify({a:[value,!0,!1,null,"\x00\b\n\f\r	"]})==serialized&&"1"===stringify(null,value)&&"[\n 1,\n 2\n]"==stringify([1,2],null,1)&&'"-271821-04-20T00:00:00.000Z"'==stringify(new Date(-864e13))&&'"+275760-09-13T00:00:00.000Z"'==stringify(new Date(864e13))&&'"-000001-01-01T00:00:00.000Z"'==stringify(new Date(-621987552e5))&&'"1969-12-31T23:59:59.999Z"'==stringify(new Date(-1))}catch(exception){stringifySupported=!1}}isSupported=stringifySupported}if("json-parse"==name){var parse=JSON3.parse;if("function"==typeof parse)try{if(0===parse("0")&&!parse(!1)){value=parse(serialized);var parseSupported=5==value.a.length&&1===value.a[0];if(parseSupported){try{parseSupported=!parse('"	"')}catch(exception){}if(parseSupported)try{parseSupported=1!==parse("01")}catch(exception){}if(parseSupported)try{parseSupported=1!==parse("1.")}catch(exception){}}}}catch(exception){parseSupported=!1}isSupported=parseSupported}}return has[name]=!!isSupported}var isProperty,forEach,undef,getClass={}.toString,isLoader="function"==typeof define&&define.amd,nativeJSON="object"==typeof JSON&&JSON,JSON3="object"==typeof exports&&exports&&!exports.nodeType&&exports;JSON3&&nativeJSON?(JSON3.stringify=nativeJSON.stringify,JSON3.parse=nativeJSON.parse):JSON3=window.JSON=nativeJSON||{};var isExtended=new Date(-0xc782b5b800cec);try{isExtended=-109252==isExtended.getUTCFullYear()&&0===isExtended.getUTCMonth()&&1===isExtended.getUTCDate()&&10==isExtended.getUTCHours()&&37==isExtended.getUTCMinutes()&&6==isExtended.getUTCSeconds()&&708==isExtended.getUTCMilliseconds()}catch(exception){}if(!has("json")){var functionClass="[object Function]",dateClass="[object Date]",numberClass="[object Number]",stringClass="[object String]",arrayClass="[object Array]",booleanClass="[object Boolean]",charIndexBuggy=has("bug-string-char-index");if(!isExtended)var floor=Math.floor,Months=[0,31,59,90,120,151,181,212,243,273,304,334],getDay=function(year,month){return Months[month]+365*(year-1970)+floor((year-1969+(month=+(month>1)))/4)-floor((year-1901+month)/100)+floor((year-1601+month)/400)};(isProperty={}.hasOwnProperty)||(isProperty=function(property){var constructor,members={};return(members.__proto__=null,members.__proto__={toString:1},members).toString!=getClass?isProperty=function(property){var original=this.__proto__,result=property in(this.__proto__=null,this);return this.__proto__=original,result}:(constructor=members.constructor,isProperty=function(property){var parent=(this.constructor||constructor).prototype;return property in this&&!(property in parent&&this[property]===parent[property])}),members=null,isProperty.call(this,property)});var PrimitiveTypes={"boolean":1,number:1,string:1,undefined:1},isHostType=function(object,property){var type=typeof object[property];return"object"==type?!!object[property]:!PrimitiveTypes[type]};if(forEach=function(object,callback){var Properties,members,property,size=0;(Properties=function(){this.valueOf=0}).prototype.valueOf=0,members=new Properties;for(property in members)isProperty.call(members,property)&&size++;return Properties=members=null,size?forEach=2==size?function(object,callback){var property,members={},isFunction=getClass.call(object)==functionClass;for(property in object)isFunction&&"prototype"==property||isProperty.call(members,property)||!(members[property]=1)||!isProperty.call(object,property)||callback(property)}:function(object,callback){var property,isConstructor,isFunction=getClass.call(object)==functionClass;for(property in object)isFunction&&"prototype"==property||!isProperty.call(object,property)||(isConstructor="constructor"===property)||callback(property);(isConstructor||isProperty.call(object,property="constructor"))&&callback(property)}:(members=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"],forEach=function(object,callback){var property,length,isFunction=getClass.call(object)==functionClass,hasProperty=!isFunction&&"function"!=typeof object.constructor&&isHostType(object,"hasOwnProperty")?object.hasOwnProperty:isProperty;for(property in object)isFunction&&"prototype"==property||!hasProperty.call(object,property)||callback(property);for(length=members.length;property=members[--length];hasProperty.call(object,property)&&callback(property));}),forEach(object,callback)},!has("json-stringify")){var Escapes={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"},leadingZeroes="000000",toPaddedString=function(width,value){return(leadingZeroes+(value||0)).slice(-width)},unicodePrefix="\\u00",quote=function(value){var symbols,result='"',index=0,length=value.length,isLarge=length>10&&charIndexBuggy;for(isLarge&&(symbols=value.split(""));length>index;index++){var charCode=value.charCodeAt(index);switch(charCode){case 8:case 9:case 10:case 12:case 13:case 34:case 92:result+=Escapes[charCode];break;default:if(32>charCode){result+=unicodePrefix+toPaddedString(2,charCode.toString(16));break}result+=isLarge?symbols[index]:charIndexBuggy?value.charAt(index):value[index]}}return result+'"'},serialize=function(property,object,callback,properties,whitespace,indentation,stack){var value,className,year,month,date,time,hours,minutes,seconds,milliseconds,results,element,index,length,prefix,result;try{value=object[property]}catch(exception){}if("object"==typeof value&&value)if(className=getClass.call(value),className!=dateClass||isProperty.call(value,"toJSON"))"function"==typeof value.toJSON&&(className!=numberClass&&className!=stringClass&&className!=arrayClass||isProperty.call(value,"toJSON"))&&(value=value.toJSON(property));else if(value>-1/0&&1/0>value){if(getDay){for(date=floor(value/864e5),year=floor(date/365.2425)+1970-1;getDay(year+1,0)<=date;year++);for(month=floor((date-getDay(year,0))/30.42);getDay(year,month+1)<=date;month++);date=1+date-getDay(year,month),time=(value%864e5+864e5)%864e5,hours=floor(time/36e5)%24,minutes=floor(time/6e4)%60,seconds=floor(time/1e3)%60,milliseconds=time%1e3}else year=value.getUTCFullYear(),month=value.getUTCMonth(),date=value.getUTCDate(),hours=value.getUTCHours(),minutes=value.getUTCMinutes(),seconds=value.getUTCSeconds(),milliseconds=value.getUTCMilliseconds();value=(0>=year||year>=1e4?(0>year?"-":"+")+toPaddedString(6,0>year?-year:year):toPaddedString(4,year))+"-"+toPaddedString(2,month+1)+"-"+toPaddedString(2,date)+"T"+toPaddedString(2,hours)+":"+toPaddedString(2,minutes)+":"+toPaddedString(2,seconds)+"."+toPaddedString(3,milliseconds)+"Z"}else value=null;if(callback&&(value=callback.call(object,property,value)),null===value)return"null";if(className=getClass.call(value),className==booleanClass)return""+value;if(className==numberClass)return value>-1/0&&1/0>value?""+value:"null";if(className==stringClass)return quote(""+value);if("object"==typeof value){for(length=stack.length;length--;)if(stack[length]===value)throw TypeError();if(stack.push(value),results=[],prefix=indentation,indentation+=whitespace,className==arrayClass){for(index=0,length=value.length;length>index;index++)element=serialize(index,value,callback,properties,whitespace,indentation,stack),results.push(element===undef?"null":element);result=results.length?whitespace?"[\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"]":"["+results.join(",")+"]":"[]"}else forEach(properties||value,function(property){var element=serialize(property,value,callback,properties,whitespace,indentation,stack);element!==undef&&results.push(quote(property)+":"+(whitespace?" ":"")+element)}),result=results.length?whitespace?"{\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"}":"{"+results.join(",")+"}":"{}";return stack.pop(),result}};JSON3.stringify=function(source,filter,width){var whitespace,callback,properties,className;if("function"==typeof filter||"object"==typeof filter&&filter)if((className=getClass.call(filter))==functionClass)callback=filter;else if(className==arrayClass){properties={};for(var value,index=0,length=filter.length;length>index;value=filter[index++],className=getClass.call(value),(className==stringClass||className==numberClass)&&(properties[value]=1));}if(width)if((className=getClass.call(width))==numberClass){if((width-=width%1)>0)for(whitespace="",width>10&&(width=10);whitespace.length<width;whitespace+=" ");}else className==stringClass&&(whitespace=width.length<=10?width:width.slice(0,10));return serialize("",(value={},value[""]=source,value),callback,properties,whitespace,"",[])}}if(!has("json-parse")){var Index,Source,fromCharCode=String.fromCharCode,Unescapes={92:"\\",34:'"',47:"/",98:"\b",116:"	",110:"\n",102:"\f",114:"\r"},abort=function(){throw Index=Source=null,SyntaxError()},lex=function(){for(var value,begin,position,isSigned,charCode,source=Source,length=source.length;length>Index;)switch(charCode=source.charCodeAt(Index)){case 9:case 10:case 13:case 32:Index++;break;case 123:case 125:case 91:case 93:case 58:case 44:return value=charIndexBuggy?source.charAt(Index):source[Index],Index++,value;case 34:for(value="@",Index++;length>Index;)if(charCode=source.charCodeAt(Index),32>charCode)abort();else if(92==charCode)switch(charCode=source.charCodeAt(++Index)){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:value+=Unescapes[charCode],Index++;break;case 117:for(begin=++Index,position=Index+4;position>Index;Index++)charCode=source.charCodeAt(Index),charCode>=48&&57>=charCode||charCode>=97&&102>=charCode||charCode>=65&&70>=charCode||abort();value+=fromCharCode("0x"+source.slice(begin,Index));break;default:abort()}else{if(34==charCode)break;for(charCode=source.charCodeAt(Index),begin=Index;charCode>=32&&92!=charCode&&34!=charCode;)charCode=source.charCodeAt(++Index);value+=source.slice(begin,Index)}if(34==source.charCodeAt(Index))return Index++,value;abort();default:if(begin=Index,45==charCode&&(isSigned=!0,charCode=source.charCodeAt(++Index)),charCode>=48&&57>=charCode){for(48==charCode&&(charCode=source.charCodeAt(Index+1),charCode>=48&&57>=charCode)&&abort(),isSigned=!1;length>Index&&(charCode=source.charCodeAt(Index),charCode>=48&&57>=charCode);Index++);if(46==source.charCodeAt(Index)){for(position=++Index;length>position&&(charCode=source.charCodeAt(position),charCode>=48&&57>=charCode);position++);position==Index&&abort(),Index=position}if(charCode=source.charCodeAt(Index),101==charCode||69==charCode){for(charCode=source.charCodeAt(++Index),(43==charCode||45==charCode)&&Index++,position=Index;length>position&&(charCode=source.charCodeAt(position),charCode>=48&&57>=charCode);position++);position==Index&&abort(),Index=position}return+source.slice(begin,Index)}if(isSigned&&abort(),"true"==source.slice(Index,Index+4))return Index+=4,!0;if("false"==source.slice(Index,Index+5))return Index+=5,!1;if("null"==source.slice(Index,Index+4))return Index+=4,null;abort()}return"$"},get=function(value){var results,hasMembers;if("$"==value&&abort(),"string"==typeof value){if("@"==(charIndexBuggy?value.charAt(0):value[0]))return value.slice(1);if("["==value){for(results=[];value=lex(),"]"!=value;hasMembers||(hasMembers=!0))hasMembers&&(","==value?(value=lex(),"]"==value&&abort()):abort()),","==value&&abort(),results.push(get(value));return results}if("{"==value){for(results={};value=lex(),"}"!=value;hasMembers||(hasMembers=!0))hasMembers&&(","==value?(value=lex(),"}"==value&&abort()):abort()),(","==value||"string"!=typeof value||"@"!=(charIndexBuggy?value.charAt(0):value[0])||":"!=lex())&&abort(),results[value.slice(1)]=get(lex());return results}abort()}return value},update=function(source,property,callback){var element=walk(source,property,callback);element===undef?delete source[property]:source[property]=element},walk=function(source,property,callback){var length,value=source[property];if("object"==typeof value&&value)if(getClass.call(value)==arrayClass)for(length=value.length;length--;)update(value,length,callback);else forEach(value,function(property){update(value,property,callback)});return callback.call(source,property,value)};JSON3.parse=function(source,callback){var result,value;return Index=0,Source=""+source,result=get(lex()),"$"!=lex()&&abort(),Index=Source=null,callback&&getClass.call(callback)==functionClass?walk((value={},value[""]=result,value),"",callback):result}}}isLoader&&define(function(){return JSON3})}(this)},{}],47:[function(_dereq_,module){function toArray(list,index){var array=[];index=index||0;for(var i=index||0;i<list.length;i++)array[i-index]=list[i];return array}module.exports=toArray},{}]},{},[1])(1)}),AdapterJS={options:{}},AdapterJS.VERSION="0.10.3",AdapterJS.WebRTCPlugin=AdapterJS.WebRTCPlugin||{},AdapterJS.WebRTCPlugin.pluginInfo={prefix:"Tem",plugName:"TemWebRTCPlugin",pluginId:"plugin0",type:"application/x-temwebrtcplugin",onload:"__TemWebRTCReady0",portalLink:"http://temasys.atlassian.net/wiki/display/TWPP/WebRTC+Plugins",downloadLink:null,companyName:"Temasys"},navigator.platform.match(/^Mac/i)?AdapterJS.WebRTCPlugin.pluginInfo.downloadLink="http://bit.ly/1n77hco":navigator.platform.match(/^Win/i)&&(AdapterJS.WebRTCPlugin.pluginInfo.downloadLink="http://bit.ly/1kkS4FN"),AdapterJS.WebRTCPlugin.pageId=Math.random().toString(36).slice(2),AdapterJS.WebRTCPlugin.plugin=null,AdapterJS.WebRTCPlugin.setLogLevel=null,AdapterJS.WebRTCPlugin.defineWebRTCInterface=null,AdapterJS.WebRTCPlugin.isPluginInstalled=null,AdapterJS.WebRTCPlugin.pluginInjectionInterval=null,AdapterJS.WebRTCPlugin.injectPlugin=null,AdapterJS.WebRTCPlugin.PLUGIN_STATES={NONE:0,INITIALIZING:1,INJECTING:2,INJECTED:3,READY:4},AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.NONE,AdapterJS.WebRTCPlugin.PLUGIN_LOG_LEVELS={NONE:"NONE",ERROR:"ERROR",WARNING:"WARNING",INFO:"INFO",VERBOSE:"VERBOSE",SENSITIVE:"SENSITIVE"},AdapterJS.WebRTCPlugin.WaitForPluginReady=null,AdapterJS.WebRTCPlugin.callWhenPluginReady=null,AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb=null,__TemWebRTCReady0=function(){"complete"===document.readyState?AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY:AdapterJS.WebRTCPlugin.documentReadyInterval=setInterval(function(){"complete"===document.readyState&&(clearInterval(AdapterJS.WebRTCPlugin.documentReadyInterval),AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY)},100)},AdapterJS._iceConnectionStates={starting:"starting",checking:"checking",connected:"connected",completed:"connected",done:"completed",disconnected:"disconnected",failed:"failed",closed:"closed"},AdapterJS._iceConnectionFiredStates=[],AdapterJS.isDefined=null,AdapterJS.parseWebrtcDetectedBrowser=function(){var hasMatch,checkMatch=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(checkMatch[1])?(hasMatch=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],webrtcDetectedBrowser="IE",webrtcDetectedVersion=parseInt(hasMatch[1]||"0",10)):"Chrome"===checkMatch[1]&&(hasMatch=navigator.userAgent.match(/\bOPR\/(\d+)/),null!==hasMatch&&(webrtcDetectedBrowser="opera",webrtcDetectedVersion=parseInt(hasMatch[1],10))),navigator.userAgent.indexOf("Safari")&&("undefined"!=typeof InstallTrigger?webrtcDetectedBrowser="firefox":document.documentMode?webrtcDetectedBrowser="IE":Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0?webrtcDetectedBrowser="safari":window.opera||navigator.userAgent.indexOf(" OPR/")>=0?webrtcDetectedBrowser="opera":window.chrome&&(webrtcDetectedBrowser="chrome")),webrtcDetectedBrowser||(webrtcDetectedVersion=checkMatch[1]),!webrtcDetectedVersion)try{checkMatch=checkMatch[2]?[checkMatch[1],checkMatch[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(hasMatch=navigator.userAgent.match(/version\/(\d+)/i))&&checkMatch.splice(1,1,hasMatch[1]),webrtcDetectedVersion=parseInt(checkMatch[1],10)}catch(error){}},AdapterJS.maybeFixConfiguration=function(pcConfig){if(null!==pcConfig)for(var i=0;i<pcConfig.iceServers.length;i++)pcConfig.iceServers[i].hasOwnProperty("urls")&&(pcConfig.iceServers[i].url=pcConfig.iceServers[i].urls,delete pcConfig.iceServers[i].urls)},AdapterJS.addEvent=function(elem,evnt,func){elem.addEventListener?elem.addEventListener(evnt,func,!1):elem.attachEvent?elem.attachEvent("on"+evnt,func):elem[evnt]=func},webrtcDetectedType=null,webrtcDetectedDCSupport=null,checkMediaDataChannelSettings=function(peerBrowserAgent,peerBrowserVersion,callback,constraints){if("function"==typeof callback){var beOfferer=!0,isLocalFirefox="firefox"===webrtcDetectedBrowser,isLocalFirefoxInterop="moz"===webrtcDetectedType&&webrtcDetectedVersion>30,isPeerFirefox="firefox"===peerBrowserAgent;if(isLocalFirefox&&isPeerFirefox||isLocalFirefoxInterop)try{delete constraints.mandatory.MozDontOfferDataChannel}catch(error){}else isLocalFirefox&&!isPeerFirefox&&(constraints.mandatory.MozDontOfferDataChannel=!0);if(!isLocalFirefox)for(var prop in constraints.mandatory)constraints.mandatory.hasOwnProperty(prop)&&-1!==prop.indexOf("Moz")&&delete constraints.mandatory[prop];!isLocalFirefox||isPeerFirefox||isLocalFirefoxInterop||(beOfferer=!1),callback(beOfferer,constraints)}},checkIceConnectionState=function(peerId,iceConnectionState,callback){"function"==typeof callback&&(peerId=peerId?peerId:"peer",AdapterJS._iceConnectionFiredStates[peerId]&&iceConnectionState!==AdapterJS._iceConnectionStates.disconnected&&iceConnectionState!==AdapterJS._iceConnectionStates.failed&&iceConnectionState!==AdapterJS._iceConnectionStates.closed||(AdapterJS._iceConnectionFiredStates[peerId]=[]),iceConnectionState=AdapterJS._iceConnectionStates[iceConnectionState],AdapterJS._iceConnectionFiredStates[peerId].indexOf(iceConnectionState)<0&&(AdapterJS._iceConnectionFiredStates[peerId].push(iceConnectionState),iceConnectionState===AdapterJS._iceConnectionStates.connected&&setTimeout(function(){AdapterJS._iceConnectionFiredStates[peerId].push(AdapterJS._iceConnectionStates.done),callback(AdapterJS._iceConnectionStates.done)},1e3),callback(iceConnectionState)))},createIceServer=null,createIceServers=null,RTCPeerConnection=null,RTCSessionDescription="function"==typeof RTCSessionDescription?RTCSessionDescription:null,RTCIceCandidate="function"==typeof RTCIceCandidate?RTCIceCandidate:null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null,navigator.mozGetUserMedia)webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),webrtcDetectedType="moz",webrtcDetectedDCSupport="SCTP",RTCPeerConnection=function(pcConfig,pcConstraints){return AdapterJS.maybeFixConfiguration(pcConfig),new mozRTCPeerConnection(pcConfig,pcConstraints)},RTCSessionDescription=mozRTCSessionDescription,window.RTCSessionDescription=RTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,window.RTCIceCandidate=RTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,MediaStreamTrack.getSources=function(successCb){setTimeout(function(){var infos=[{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}];successCb(infos)},0)},createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");if(0===url_parts[0].indexOf("stun"))iceServer={url:url};else if(0===url_parts[0].indexOf("turn"))if(webrtcDetectedVersion<27){var turn_url_parts=url.split("?");(1===turn_url_parts.length||0===turn_url_parts[1].indexOf("transport=udp"))&&(iceServer={url:turn_url_parts[0],credential:password,username:username})}else iceServer={url:url,credential:password,username:username};return iceServer},createIceServers=function(urls,username,password){var iceServers=[];for(i=0;i<urls.length;i++){var iceServer=createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers},attachMediaStream=function(element,stream){return element.mozSrcObject=stream,element.play(),element},reattachMediaStream=function(to,from){return to.mozSrcObject=from.mozSrcObject,to.play(),to},MediaStreamTrack.getSources=MediaStreamTrack.getSources||function(callback){if(!callback)throw new TypeError("Failed to execute 'getSources' on 'MediaStreamTrack': 1 argument required, but only 0 present.");return callback([])},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]});else if(navigator.webkitGetUserMedia){webrtcDetectedBrowser="chrome",webrtcDetectedType="webkit",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10);var checkIfOpera=navigator.userAgent.match(/\bOPR\/(\d+)/);null!==checkIfOpera&&(webrtcDetectedBrowser="opera",webrtcDetectedVersion=parseInt(checkIfOpera[1],10)),webrtcDetectedDCSupport="chrome"===webrtcDetectedBrowser&&webrtcDetectedVersion>=31||"opera"===webrtcDetectedBrowser&&webrtcDetectedVersion>=20?"SCTP":"chrome"===webrtcDetectedBrowser&&webrtcDetectedVersion<30&&webrtcDetectedVersion>24?"RTP":"",createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");return 0===url_parts[0].indexOf("stun")?iceServer={url:url}:0===url_parts[0].indexOf("turn")&&(iceServer={url:url,credential:password,username:username}),iceServer},createIceServers=function(urls,username,password){var iceServers=[];if(webrtcDetectedVersion>=34)iceServers={urls:urls,credential:password,username:username};else for(i=0;i<urls.length;i++){var iceServer=createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers},RTCPeerConnection=function(pcConfig,pcConstraints){return webrtcDetectedVersion<34&&AdapterJS.maybeFixConfiguration(pcConfig),new webkitRTCPeerConnection(pcConfig,pcConstraints)},getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(element,stream){return"undefined"!=typeof element.srcObject?element.srcObject=stream:"undefined"!=typeof element.mozSrcObject?element.mozSrcObject=stream:"undefined"!=typeof element.src&&(element.src=URL.createObjectURL(stream)),element},reattachMediaStream=function(to,from){return to.src=from.src,to}}else("object"!=typeof console||"function"!=typeof console.log)&&(console={}||console,console.log=function(){},console.info=function(){},console.error=function(){},console.dir=function(){},console.exception=function(){},console.trace=function(){},console.warn=function(){},console.count=function(){},console.debug=function(){},console.count=function(){},console.time=function(){},console.timeEnd=function(){},console.group=function(){},console.groupCollapsed=function(){},console.groupEnd=function(){}),webrtcDetectedType="plugin",webrtcDetectedDCSupport="plugin",AdapterJS.parseWebrtcDetectedBrowser(),isIE="IE"===webrtcDetectedBrowser,AdapterJS.WebRTCPlugin.WaitForPluginReady=function(){for(;AdapterJS.WebRTCPlugin.pluginState!==AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY;);},AdapterJS.WebRTCPlugin.callWhenPluginReady=function(callback){if(AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY)callback();
else var checkPluginReadyState=setInterval(function(){AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY&&(clearInterval(checkPluginReadyState),callback())},100)},AdapterJS.WebRTCPlugin.setLogLevel=function(logLevel){AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.setLogLevel(logLevel)})},AdapterJS.WebRTCPlugin.injectPlugin=function(){if("complete"===document.readyState&&AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.INITIALIZING){if(AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INJECTING,"IE"===webrtcDetectedBrowser&&webrtcDetectedVersion<=10){var frag=document.createDocumentFragment();for(AdapterJS.WebRTCPlugin.plugin=document.createElement("div"),AdapterJS.WebRTCPlugin.plugin.innerHTML='<object id="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'" type="'+AdapterJS.WebRTCPlugin.pluginInfo.type+'" width="1" height="1"><param name="pluginId" value="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'" /> <param name="windowless" value="false" /> <param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'" /> <param name="onload" value="'+AdapterJS.WebRTCPlugin.pluginInfo.onload+'" />'+(AdapterJS.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+"</object>";AdapterJS.WebRTCPlugin.plugin.firstChild;)frag.appendChild(AdapterJS.WebRTCPlugin.plugin.firstChild);document.body.appendChild(frag),AdapterJS.WebRTCPlugin.plugin=document.getElementById(AdapterJS.WebRTCPlugin.pluginInfo.pluginId)}else AdapterJS.WebRTCPlugin.plugin=document.createElement("object"),AdapterJS.WebRTCPlugin.plugin.id=AdapterJS.WebRTCPlugin.pluginInfo.pluginId,isIE&&(AdapterJS.WebRTCPlugin.plugin.width="1px",AdapterJS.WebRTCPlugin.plugin.height="1px"),AdapterJS.WebRTCPlugin.plugin.type=AdapterJS.WebRTCPlugin.pluginInfo.type,AdapterJS.WebRTCPlugin.plugin.innerHTML='<param name="onload" value="'+AdapterJS.WebRTCPlugin.pluginInfo.onload+'"><param name="pluginId" value="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'"><param name="windowless" value="false" /> '+(AdapterJS.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+'<param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'">',document.body.appendChild(AdapterJS.WebRTCPlugin.plugin);AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INJECTED}},AdapterJS.WebRTCPlugin.isPluginInstalled=function(comName,plugName,installedCb,notInstalledCb){if(isIE){try{{new ActiveXObject(comName+"."+plugName)}}catch(e){return void notInstalledCb()}installedCb()}else{for(var pluginArray=navigator.plugins,i=0;i<pluginArray.length;i++)if(pluginArray[i].name.indexOf(plugName)>=0)return void installedCb();notInstalledCb()}},AdapterJS.WebRTCPlugin.defineWebRTCInterface=function(){AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INITIALIZING,AdapterJS.isDefined=function(variable){return null!==variable&&void 0!==variable},createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");return 0===url_parts[0].indexOf("stun")?iceServer={url:url,hasCredentials:!1}:0===url_parts[0].indexOf("turn")&&(iceServer={url:url,hasCredentials:!0,credential:password,username:username}),iceServer},createIceServers=function(urls,username,password){for(var iceServers=[],i=0;i<urls.length;++i)iceServers.push(createIceServer(urls[i],username,password));return iceServers},RTCSessionDescription=function(info){return AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.ConstructSessionDescription(info.type,info.sdp)},RTCPeerConnection=function(servers,constraints){var iceServers=null;if(servers){iceServers=servers.iceServers;for(var i=0;i<iceServers.length;i++)iceServers[i].urls&&!iceServers[i].url&&(iceServers[i].url=iceServers[i].urls),iceServers[i].hasCredentials=AdapterJS.isDefined(iceServers[i].username)&&AdapterJS.isDefined(iceServers[i].credential)}var mandatory=constraints&&constraints.mandatory?constraints.mandatory:null,optional=constraints&&constraints.optional?constraints.optional:null;return AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.PeerConnection(AdapterJS.WebRTCPlugin.pageId,iceServers,mandatory,optional)},MediaStreamTrack={},MediaStreamTrack.getSources=function(callback){AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.GetSources(callback)})},getUserMedia=function(constraints,successCallback,failureCallback){constraints.audio||(constraints.audio=!1),AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.getUserMedia(constraints,successCallback,failureCallback)})},navigator.getUserMedia=getUserMedia,attachMediaStream=function(element,stream){if(stream.enableSoundTracks(!0),"audio"!==element.nodeName.toLowerCase()){var elementId=0===element.id.length?Math.random().toString(36).slice(2):element.id;if(element.isWebRTCPlugin&&element.isWebRTCPlugin()){for(var children=element.children,i=0;i!==children.length;++i)if("streamId"===children[i].name){children[i].value=stream.id;break}element.setStreamId(stream.id)}else{var frag=document.createDocumentFragment(),temp=document.createElement("div"),classHTML=element.className?'class="'+element.className+'" ':"";for(temp.innerHTML='<object id="'+elementId+'" '+classHTML+'type="'+AdapterJS.WebRTCPlugin.pluginInfo.type+'"><param name="pluginId" value="'+elementId+'" /> <param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'" /> <param name="windowless" value="true" /> <param name="streamId" value="'+stream.id+'" /> </object>';temp.firstChild;)frag.appendChild(temp.firstChild);var rectObject=element.getBoundingClientRect();element.parentNode.insertBefore(frag,element),frag=document.getElementById(elementId),frag.width=rectObject.width+"px",frag.height=rectObject.height+"px",element.parentNode.removeChild(element)}var newElement=document.getElementById(elementId);return newElement.onplaying=element.onplaying?element.onplaying:function(){},isIE&&(newElement.attachEvent("onplaying",newElement.onplaying),newElement.onclick=element.onclick?element.onclick:function(){},newElement._TemOnClick=function(id){var arg={srcElement:document.getElementById(id)};newElement.onclick(arg)}),newElement}return element},reattachMediaStream=function(to,from){for(var stream=null,children=from.children,i=0;i!==children.length;++i)if("streamId"===children[i].name){AdapterJS.WebRTCPlugin.WaitForPluginReady(),stream=AdapterJS.WebRTCPlugin.plugin.getStreamWithId(AdapterJS.WebRTCPlugin.pageId,children[i].value);break}return null!==stream?attachMediaStream(to,stream):void 0},RTCIceCandidate=function(candidate){return candidate.sdpMid||(candidate.sdpMid=""),AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.ConstructIceCandidate(candidate.sdpMid,candidate.sdpMLineIndex,candidate.candidate)},AdapterJS.addEvent(document,"readystatechange",AdapterJS.WebRTCPlugin.injectPlugin),AdapterJS.WebRTCPlugin.injectPlugin()},AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb=function(){AdapterJS.addEvent(document,"readystatechange",AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv),AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv()},AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv=function(){if(!AdapterJS.options.hidePluginInstallPrompt){var downloadLink=AdapterJS.WebRTCPlugin.pluginInfo.downloadLink;if(downloadLink){var popupString;popupString=AdapterJS.WebRTCPlugin.pluginInfo.portalLink?'This website requires you to install the  <a href="'+AdapterJS.WebRTCPlugin.pluginInfo.portalLink+'" target="_blank">'+AdapterJS.WebRTCPlugin.pluginInfo.companyName+" WebRTC Plugin</a> to work on this browser.":"This website requires you to install a WebRTC-enabling plugin to work on this browser.",AdapterJS.WebRTCPlugin.renderNotificationBar(popupString,"Install Now",downloadLink)}else AdapterJS.WebRTCPlugin.renderNotificationBar("Your browser does not support WebRTC.")}},AdapterJS.WebRTCPlugin.renderNotificationBar=function(text,buttonText,buttonLink){if("complete"===document.readyState){var w=window,i=document.createElement("iframe");i.style.position="fixed",i.style.top="-41px",i.style.left=0,i.style.right=0,i.style.width="100%",i.style.height="40px",i.style.backgroundColor="#ffffe1",i.style.border="none",i.style.borderBottom="1px solid #888888",i.style.zIndex="9999999","string"==typeof i.style.webkitTransition?i.style.webkitTransition="all .5s ease-out":"string"==typeof i.style.transition&&(i.style.transition="all .5s ease-out"),document.body.appendChild(i),c=i.contentWindow?i.contentWindow:i.contentDocument.document?i.contentDocument.document:i.contentDocument,c.document.open(),c.document.write('<span style="font-family: Helvetica, Arial,sans-serif; font-size: .9rem; padding: 7px; vertical-align: middle; cursor: default;">'+text+"</span>"),buttonText&&buttonLink?(c.document.write('<button id="okay">'+buttonText+"</button><button>Cancel</button>"),c.document.close(),AdapterJS.addEvent(c.document.getElementById("okay"),"click",function(e){window.open(buttonLink,"_top"),e.preventDefault();try{event.cancelBubble=!0}catch(error){}})):c.document.close(),AdapterJS.addEvent(c.document,"click",function(){w.document.body.removeChild(i)}),setTimeout(function(){"string"==typeof i.style.webkitTransform?i.style.webkitTransform="translateY(40px)":"string"==typeof i.style.transform?i.style.transform="translateY(40px)":i.style.top="0px"},300)}},AdapterJS.WebRTCPlugin.isPluginInstalled(AdapterJS.WebRTCPlugin.pluginInfo.prefix,AdapterJS.WebRTCPlugin.pluginInfo.plugName,AdapterJS.WebRTCPlugin.defineWebRTCInterface,AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb);var globals={apiKey:null,region:"us2",defaultRoom:null,roomServer:"//api.temasys.com.sg",enforceSSL:!1,socketTimeout:0,TURNServer:!0,STUNServer:!0,ICETrickle:!0,TURNTransport:"any",dataChannel:!0,audioFallback:!1,credentials:null},fn={isEmpty:function(data){var isUnDefined="undefined"==typeof data||null===data;return"object"!=typeof data||isUnDefined?isUnDefined:data.constructor===Array?0===data.length:0===Object.keys(data).length},isSafe:function(unsafeFn){try{return unsafeFn()}catch(error){return log.warn("Function",error),!1}},runSync:function(){var args=Array.prototype.slice.call(arguments),run=function(fn){setTimeout(fn,1),args.splice(0,1),0!==args.length&&run(args[0])};run(args[0])},clone:function(obj){if(this.isEmpty(obj)||"object"!=typeof obj)return obj;var copy=obj.constructor();for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=obj[attr]);return copy},constant:function(main,property,value){var obj={};obj[property]={value:value,enumerable:!0},Object.defineProperties(main,obj)},generateUID:function(){return(new Date).getTime().toString()},applyHandler:function(callee,params,args){var i,item=callee;for(i=0;i<params.length;i+=1)fn.isEmpty(item[params[i]])||(item=item[params[i]]);"function"==typeof item&&item.apply(this,args)},forEach:function(main,deferItem,deferFin){if("object"==typeof main&&!fn.isEmpty(main)){if(main.constructor===Array){var i;for(i=0;i<main.length;i+=1)deferItem(main[i],i)}else{var key;for(key in main)main.hasOwnProperty(key)&&deferItem(main[key],key)}"function"==typeof deferFin&&deferFin()}}},log={};window.console.newDebug="function"!=typeof window.console.debug?window.console.log:window.console.debug,window.console.newTrace="function"!=typeof window.console.trace?window.console.log:window.console.trace;var LogKey="Skylink - ",Debugger={level:2,trace:!1,store:!1,logs:[],console:{log:window.console.log.bind(window.console,LogKey+"<<%s>> %s"),error:window.console.error.bind(window.console,LogKey+"<<%s>> %s"),info:window.console.info.bind(window.console,("safari"===window.webrtcDetectedBrowser?"INFO: ":"")+LogKey+"<<%s>> %s"),warn:window.console.warn.bind(window.console,LogKey+"<<%s>> %s"),debug:window.console.newDebug.bind(window.console,("function"!=typeof window.console.debug?"DEBUG: ":"")+LogKey+"<<%s>> %s")},traceTemplate:{log:"==LOG== "+LogKey+"%s",error:"==ERROR== "+LogKey+"%s",info:"==INFO== "+LogKey+"%s",warn:"==WARN== "+LogKey+"%s",debug:"==DEBUG== "+LogKey+"%s"},applyConsole:function(type){var args=Array.prototype.slice.call(arguments);return args.shift(),this.store&&logs.push(type,args,new Date),this.trace?window.console.newTrace.bind(window.console,this.traceTemplate[type]):this.console[type]},setLevel:function(inputLevel){log.debug=inputLevel>3?this.applyConsole("debug"):function(){},log.log=inputLevel>2?this.applyConsole("log"):function(){},log.info=inputLevel>1?this.applyConsole("info"):function(){},log.warn=inputLevel>0?this.applyConsole("warn"):function(){},log.error=inputLevel>-1?this.applyConsole("error"):function(){},this.level=inputLevel},configure:function(options){options=options||{},Debugger.store=!!options.store,Debugger.trace=!!options.trace,Debugger.setLevel("number"==typeof options.level?options.level:2)}};Debugger.setLevel(4);var Skylink={},rooms=[],Config=function(options){globals.apiKey=options.apiKey};Skylink.init=function(apiKey,name,listener){return rooms[name]=new Room(name,listener),rooms[name]},Skylink.DATA_CHANNEL_STATE={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error"},Skylink.DATA_TRANSFER_DATA_TYPE={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob"},Skylink.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},Skylink.DATA_TRANSFER_STATE={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted"},Skylink.CANDIDATE_GENERATION_STATE={NEW:"new",GATHERING:"gathering",COMPLETED:"completed"},Skylink.ICE_CONNECTION_STATE={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},Skylink.TURN_TRANSPORT={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none"},Skylink.PEER_CONNECTION_STATE={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",CLOSED:"closed"},Skylink.HANDSHAKE_PROGRESS={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ERROR:"error"},Skylink.SYSTEM_ACTION={WARNING:"warning",REJECT:"reject"},Skylink.SYSTEM_ACTION_REASON={FAST_MESSAGE:"fastmsg",ROOM_LOCKED:"locked",ROOM_FULL:"roomfull",DUPLICATED_LOGIN:"duplicatedLogin",SERVER_ERROR:"serverError",VERIFICATION:"verification",EXPIRED:"expired",ROOM_CLOSED:"roomclose",ROOM_CLOSING:"toclose",OVER_SEAT_LIMIT:"seatquota"},Skylink.READY_STATE_CHANGE={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},Skylink.READY_STATE_CHANGE_ERROR={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NOT_ENOUGH_CREDIT:4007,API_NOT_ENOUGH_PREPAID_CREDIT:4008,API_FAILED_FINDING_PREPAID_CREDIT:4009,API_NO_MEETING_RECORD_FOUND:4010,ROOM_LOCKED:5001,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,INVALID_XMLHTTPREQUEST_STATUS:5,SCRIPT_ERROR:6},Skylink.REGIONAL_SERVER={APAC1:"sg",US1:"us2"},Skylink.LOG_LEVEL={DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0},Skylink.SOCKET_ERROR={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},Skylink.SOCKET_FALLBACK={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},Skylink.VIDEO_RESOLUTION={QQVGA:{width:160,height:120,aspectRatio:"4:3"},HQVGA:{width:240,height:160,aspectRatio:"3:2"},QVGA:{width:320,height:180,aspectRatio:"4:3"},WQVGA:{width:384,height:240,aspectRatio:"16:10"},HVGA:{width:480,height:320,aspectRatio:"3:2"},VGA:{width:640,height:360,aspectRatio:"4:3"},WVGA:{width:768,height:480,aspectRatio:"16:10"},FWVGA:{width:854,height:480,aspectRatio:"16:9"},SVGA:{width:800,height:600,aspectRatio:"4:3"},DVGA:{width:960,height:640,aspectRatio:"3:2"},WSVGA:{width:1024,height:576,aspectRatio:"16:9"},HD:{width:1280,height:720,aspectRatio:"16:9"},HDPLUS:{width:1600,height:900,aspectRatio:"16:9"},FHD:{width:1920,height:1080,aspectRatio:"16:9"},QHD:{width:2560,height:1440,aspectRatio:"16:9"},WQXGAPLUS:{width:3200,height:1800,aspectRatio:"16:9"},UHD:{width:3840,height:2160,aspectRatio:"16:9"},UHDPLUS:{width:5120,height:2880,aspectRatio:"16:9"},FUHD:{width:7680,height:4320,aspectRatio:"16:9"},QUHD:{width:15360,height:8640,aspectRatio:"16:9"}};var DataChannelEventResponseHandler={start:function(){},connect:function(){},error:function(){},message:function(){},disconnect:function(){}},DataChannelHandler=function(com,event,data,listener){var params=event.split(":");data.id=com.id,fn.applyHandler(DataChannelEventResponseHandler,params,[com,data,listener]),listener(event,data)},DataProcess={chunkSize:49152,mozChunkSize:16384,chunk:function(blob,blobByteSize){var chunksArray=[],startCount=0,endCount=0;if(blobByteSize>this.chunkSize){for(;blobByteSize-1>endCount;)endCount=startCount+this.chunkSize,chunksArray.push(blob.slice(startCount,endCount)),startCount+=this.chunkSize;blobByteSize-(startCount+1)>0&&chunksArray.push(blob.slice(startCount,blobByteSize-1))}else chunksArray.push(blob);return chunksArray},unchunk:function(dataURL){for(var byteString=atob(dataURL.replace(/\s\r\n/g,"")),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),j=0;j<byteString.length;j++)ia[j]=byteString.charCodeAt(j);return new Blob([ab])}};DataTransferEventResponseHandler={start:function(com,data,listener){var dt=new DataTransfer(com.datachannels.main,com.id,listener);com.datatransfers.main=dt}};var DataTransferHandler=function(com,event,data,listener){var params=event.split(":");data.id=com.id,fn.applyHandler(DataTransferEventResponseHandler,params,[com,data,listener]),listener(event,data)},_Event={listeners:{on:{},once:{}},timestamp:{now:Date.now()||function(){return+new Date}},on:function(event,listener){this.listeners.on[event]=this.listeners.on[event]||[],this.listeners.on[event].push(listener)},once:function(event,listener){this.listeners.once[event]=this.listeners.once[event]||[],this.listeners.once[event].push(listener)},off:function(event,listener){return fn.isEmpty(event)?(this.listeners.on={},void(this.listeners.once={})):void("function"==typeof listener?(this.remove(this.listeners.on[event]||{},listener),this.remove(this.listeners.once[event]||{},listener)):(this.listeners.on[event]=[],this.listeners.once[event]=[]))},respond:function(event){var args=Array.prototype.slice.call(arguments);args.shift();var on=this.listeners.on[event]||{},once=this.listeners.once[event]||{};this.trigger(on,args),this.trigger(once,args),this.listeners.once[event]=[]},trigger:function(listeners,args){var i;for(i=0;i<listeners.length;i+=1)try{listeners[i].apply(this,args)}catch(error){throw error}},remove:function(listeners,listener){var i=0;for(i=0;i<listeners.length;i+=1)if(listeners[i]===listener){listeners.splice(i,1);break}},throttle:function(defer,wait){return function(){fn.isEmpty(this.timeStamp.func)&&(this.timeStamp.func=this.timestamp.now-wait);var now=Date.now();now-this.timestamp.func<wait||(func.apply(this,arguments),this.timeStamp.func=now)}}};Skylink.Event=_Event;var EventList=["channelOpen","channelClose","channelMessage","channelError","channelRetry","socketError","readyStateChange","handshakeProgress","candidateGenerationState","peerConnectionState","peerConnectionHealth","iceConnectionState","mediaAccessError","mediaAccessSuccess","mediaAccessRequired","mediaAccessStopped","peerJoined","peerRestart","peerUpdated","peerLeft","presenceChanged","incomingStream","incomingMessage","roomLock","dataChannelState","dataTransferState","systemAction"],ICE={newIceConnectionStates:{starting:"starting",checking:"checking",connected:"connected",completed:"connected",done:"completed",disconnected:"disconnected",failed:"failed",closed:"closed"},queueCandidate:function(peer,candidate){peer.queueCandidate=peer.queueCandidate||[],peer.queueCandidate.push(candidate)},popCandidate:function(peer,defer){peer.queueCandidate=peer.queueCandidate||[];var i;for(peer.queueCandidate.forEach(function(candidate){var type=candidate.candidate.split(" ")[7];peer.addIceCandidate(candidate,function(){defer("candidate:success",{candidate:candidate,type:type})},function(error){defer("candidate:error",{candidate:candidate,type:type,error:error})})}),i=0;i<peer.queueCandidate.length;i+=1){var candidate=peer.queueCandidate[i];defer(candidate)}peer.queueCandidate=[]},addCandidate:function(peer,candidate,defer){if(fn.isEmpty(candidate.candidate))return defer("candidate:gathered",candidate);if(fn.isEmpty(peer.remoteDescription))this.queueCandidate(peer,candidate,defer);else{var type=candidate.candidate.split(" ")[7];peer.addIceCandidate(candidate,function(){defer("candidate:success",{candidate:candidate,type:type})},function(error){defer("candidate:error",{candidate:candidate,type:type,error:error})})}},parseIceConnectionState:function(peer){var state=peer.iceConnectionState,checkState=this.newIceConnectionStates[state];peer.iceConnectionFiredStates&&"disconnected"!==checkState&&"failed"!==checkState&&"closed"!==checkState||(peer.iceConnectionFiredStates=[]);var newState=this.newIceConnectionStates[state];peer.iceConnectionFiredStates.indexOf(newState)<0&&(peer.iceConnectionFiredStates.push(newState),"connected"===newState&&setTimeout(function(){peer.iceConnectionFiredStates.push("done"),peer.newIceConnectionState="completed",peer.oniceconnectionnewstatechange(peer)},1e3),peer.newIceConnectionState=newState,peer.oniceconnectionnewstatechange(peer))},parseICEServers:function(constraints){return constraints},parseSTUNServers:function(constraints){return constraints},parseTURNServers:function(constraints){return constraints}},PeerEventReceivedHandler={stream:{stop:function(com){"main"!==com.id&&com.disconnect()}}},PeerEventResponseHandler={connect:function(com){"function"==typeof com.onconnect&&com.onconnect(com.id)},reconnect:function(com){"function"==typeof com.onreconnect&&com.onreconnect()},disconnect:function(com){"function"==typeof com.ondisconnect&&com.ondisconnect()},stream:function(com,data){data.stream.sourceType=data.sourceType,"remote"===data.sourceType&&(com.stream=data.stream),"function"==typeof com.onaddstream&&com.onaddstream(data.stream)},iceconnectionstate:function(com,data){"function"==typeof com.oniceconnectionstatechange&&com.oniceconnectionstatechange(data.state)},icegatheringstate:function(com,data){"function"==typeof com.onicegatheringstatechange&&com.onicegatheringstatechange(data.state)},icecandidate:function(){},signalingstate:function(com,data){"function"==typeof com.onsignalingstatechange&&com.onsignalingstatechange(data.state)},datachannel:function(com,data){data.channel.sourceType=data.sourceType,com.datachannels[data.channel.id]=data.channel,"function"==typeof com.ondatachannel&&com.ondatachannel(data.channel)}},PeerEventMessageHandler={offer:function(com,data){com.remoteDescription=new window.RTCSessionDescription(data),com.handler("peer:offer",{sourceType:"remote",offer:com.remoteDescription}),com.setRemoteDescription()},answer:function(com,data){com.remoteDescription=new window.RTCSessionDescription(data),com.handler("peer:answer",{sourceType:"remote",answer:com.remoteDescription}),com.setLocalDescription()},candidate:function(com,data){var candidate=new window.RTCIceCandidate({sdpMLineIndex:data.label,candidate:data.candidate,sdpMid:data.id,label:data.label,id:data.id});ICE.addCandidate(com.RTCPeerConnection,candidate,com.handler),com.handler("peer:icecandidate",{sourceType:"remote",candidate:candidate})},restart:function(){},muteAudioEvent:function(com,data){data.muted?com.stream.muteAudio():com.stream.muteVideo()},muteVideoEvent:function(com,data){data.muted?com.stream.unmuteAudio():com.stream.unmuteVideo()}},PeerHandler=function(com,event,data,listener){var params=event.split(":");0===event.indexOf("message:")?fn.applyHandler(PeerEventMessageHandler,params,[com,data,listener]):(0===event.indexOf("peer:")?(data.id=com.id,fn.applyHandler(PeerEventResponseHandler,params,[com,data,listener])):(data.peerId=com.id,fn.applyHandler(PeerEventReceivedHandler,params,[com,data,listener])),listener(event,data))},Request={server:globals.roomServer||"//api.temasys.this.sg",isXDomainRequest:"IE"===window.webrtcDetectedBrowser&&(9===window.webrtcDetectedVersion||8===window.webrtcDetectedVersion)&&"function"==typeof window.XDomainRequest,protocol:globals.enforceSSL?"https:":window.location.protocol,load:function(path,deferSuccess,deferError){var xhr=null;this.isXDomainRequest?(xhr=new XDomainRequest,xhr.setContentType=function(contentType){xhr.contentType=contentType}):(xhr=new window.XMLHttpRequest,xhr.setContentType=function(contentType){xhr.setRequestHeader("Content-type",contentType)}),xhr.onload=function(){var response=xhr.responseText||xhr.response,status=xhr.status||200;log.info("Request","Received response from API server",response,status);try{response=JSON.parse(response||"{}")}catch(error){throw error}200===status?deferSuccess(status,response):deferError(status,response)},xhr.onerror=function(error){throw error},xhr.onprogress=function(){log.log("Request","Request load in progress")},xhr.open("GET",this.protocol+this.server+path,!0),xhr.send()}},RoomEventReceivedHandler={socket:{connect:function(com){com.socket.send({type:"joinRoom",uid:com.self.username,cid:com.key,rid:com.id,userCred:com.self.token,timeStamp:com.self.timeStamp,apiOwner:com.owner,roomCred:com.token,start:com.startDateTime,len:com.duration})},disconnect:function(com){com.handler("room:leave",{}),"function"==typeof com.onleave&&com.onleave()},error:function(com,data){com.handler("room:error",{error:data,state:-2})}},user:{start:function(com,data){var user=com.users[data.mid],connection=com.self.streams[data.prid];fn.isEmpty(connection)||(data.stream=connection.stream),data.iceServers=com.iceServers,user.handler("message:"+data.type,data)}},peer:{connect:function(com,data){{var user=com.users[data.userId];user.getInfo()}"answer"===data.SDPType&&com.socket.send({type:"welcome",mid:com.self.id,rid:com.id,prid:data.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,webRTCType:window.webrtcDetectedType,userInfo:com.self.getInfo(data.id),target:data.userId,weight:data.weight})},offer:{success:function(com,data){com.socket.send({type:"offer",sdp:data.offer.sdp,prid:data.id,mid:com.self.id,target:data.userId,rid:com.id})}},answer:{success:function(com,data){com.socket.send({type:"answer",sdp:data.answer.sdp,prid:data.id,mid:com.self.id,target:data.userId,rid:com.id})}},icecandidate:function(com,data){"local"===data.sourceType&&com.socket.send({type:"candidate",label:data.candidate.sdpMLineIndex,id:data.candidate.sdpMid,candidate:data.candidate.candidate,mid:com.self.id,prid:data.id,target:data.userId,rid:com.id})}}},RoomEventResponseHandler={error:function(com,data){com.readyState=data.state,com.handler("room:error",{error:data.error,state:data.state}),"function"==typeof com.onerror&&com.onerror({error:data.error,state:data.state})}},RoomHandler=function(com,event,data,listener){var params=event.split(":");0===event.indexOf("room:")?(data.name=com.name,fn.applyHandler(RoomEventResponseHandler,params,[com,data,listener])):(data.roomName=com.name,fn.applyHandler(RoomEventReceivedHandler,params,[com,data,listener])),listener(event,data),log.debug("RoomHandler",event,data)},MessageHandlerEvent={inRoom:function(com,data){com.self.id=data.sid,com.iceServers=data.pc_config,com.socket.send({type:"enter",mid:com.self.id,rid:com.id,prid:"main",agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,webRTCType:window.webrtcDetectedType,userInfo:com.self.getInfo("main")}),com.handler("room:join",{userId:com.self.id,user:com.self,isSelf:!0}),"function"==typeof com.onjoin&&com.onjoin(data.mid)},enter:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)&&(user=new User(data,com.handler),com.users[data.mid]=user)},welcome:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)&&(user=new User(data,com.handler),com.users[data.mid]=user)},offer:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:offer",data)},answer:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:answer",data)},candidate:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:candidate",data)},updateUserEvent:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:updateUserEvent",data.userData)},muteAudioEvent:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:muteAudioEvent",data)},muteVideoEvent:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:muteVideoEvent",data)},roomLockEvent:function(com,data){com.locked=data.lock,com.locked?"function"==typeof com.onlock&&com.onlock(data.mid):"function"==typeof com.onunlock&&com.onunlock(data.mid)},restart:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.handler("message:restart",data)},redirect:function(com,data){"reject"===data.action&&"function"==typeof com.onkick&&(com.onkick({message:data.info,reason:data.reason}),com.leave()),"warning"===data.action&&"function"==typeof com.onwarn&&com.onwarn({message:data.info,reason:data.reason})},bye:function(com,data){var user=com.users[data.mid];fn.isEmpty(user)||user.disconnect()}},MessageHandler=function(com,listener){fn.forEach(MessageHandlerEvent,function(response,event){com.socket.when(event,function(data){response(com,data,listener)})})},SDP={find:function(sdpLines,condition){var i,j;for(i=0;i<sdpLines.length;i+=1)for(j=0;j<condition.length;j+=1)if(sdpLines[i]=sdpLines[i]||"",0===sdpLines[i].indexOf(condition[j]))return[i,sdpLines[i]];return[]},addStereo:function(sdpLines){var opusLineFound=!1,opusPayload=0,rtpmapLine=this.find(sdpLines,["a=rtpmap:"]);if(rtpmapLine.length&&0===rtpmapLine[1].split(" ")[1].indexOf("opus/48000/")&&(opusLineFound=!0,opusPayload=rtpmapLine[1].split(" ")[0].split(":")[1]),opusLineFound){var fmtpLine=this.find(sdpLines,["a=fmtp:"+opusPayload]);fmtpLine.length&&(sdpLines[fmtpLine[0]]=fmtpLine[1]+"; stereo=1")}return sdpLines},setBitrate:function(sdpLines,bandwidth){var maLineFound=this.find(sdpLines,["m=","a="]).length,cLineFound=this.find(sdpLines,["c="]).length;if(maLineFound&&cLineFound){if(bandwidth.audio){var audioLine=this.find(sdpLines,["a=audio","m=audio"]);fn.isEmpty(audioLine)||sdpLines.splice(audioLine[0],1,audioLine[1],"b=AS:"+bandwidth.audio)}if(bandwidth.video){var videoLine=this.find(sdpLines,["a=video","m=video"]);fn.isEmpty(videoLine)||sdpLines.splice(videoLine[0],1,videoLine[1],"b=AS:"+bandwidth.video)}if(bandwidth.data&&this._enableDataChannel){var dataLine=this.find(sdpLines,["a=application","m=application"]);fn.isEmpty(dataLine)||sdpLines.splice(dataLine[0],1,dataLine[1],"b=AS:"+bandwidth.data)}}return sdpLines},setResolution:function(sdpLines){var video=this._streamSettings.video,frameRate=video.frameRate||50,resolution=video.resolution||{},fmtpLine=this.find(sdpLines,["a=fmtp:"]);return fmtpLine.length&&sdpLines.splice(fmtpLine[0],1,fmtpLine[1]+";max-fr="+frameRate+";max-recv-width="+(resolution.width?resolution.width:640)+";max-recv-height="+(resolution.height?resolution.height:480)),sdpLines},removeH264Support:function(sdpLines){var invalidLineIndex=sdpLines.indexOf("a=fmtp:0 profile-level-id=0x42e00c;packetization-mode=1");return invalidLineIndex>-1&&(log.debug("Firefox H264 invalid pref found:",invalidLineIndex),sdpLines.splice(invalidLineIndex,1)),sdpLines},configure:function(sdp,config){var sdpLines=sdp.split("\r\n");return sdpLines=this.removeH264Support(sdpLines),config.stereo&&(sdpLines=this.addStereo(sdpLines)),config.bandwidth&&(sdpLines=this.setBitrate(sdpLines,config.bandwidth)),sdpLines.join("\r\n")
}},StreamParser={defaultConfig:{audio:{stereo:!1},video:{resolution:{width:640,height:480},frameRate:50},bandwidth:{audio:50,video:256,data:1638400}},parseAudioConfig:function(options){options="object"==typeof options?options:!!options;var userMedia=!1,tempOptions={};return options!==!1&&(options="boolean"==typeof options?{}:options,tempOptions.stereo=!!options.stereo,tempOptions.sourceId=options.sourceId,options=tempOptions),userMedia="object"==typeof options?!0:options,tempOptions.sourceId&&tempOptions.audio!==!1&&(userMedia={optional:[{sourceId:tempOptions.sourceId}]}),{settings:options,userMedia:userMedia}},parseVideoConfig:function(options){options="object"==typeof options?options:!!options;var userMedia=!1,tempOptions={};return options!==!1&&(options="boolean"==typeof options?{resolution:{}}:options,options.resolution=options.resolution||{},tempOptions.resolution=tempOptions.resolution||{},tempOptions.resolution.width=options.resolution.width||this.defaultConfig.video.resolution.width,tempOptions.resolution.height=options.resolution.height||this.defaultConfig.video.resolution.height,tempOptions.frameRate=options.frameRate||this.defaultConfig.video.frameRate,tempOptions.sourceId=options.sourceId,options=tempOptions,userMedia={mandatory:{maxWidth:tempOptions.resolution.width,maxHeight:tempOptions.resolution.height,maxFrameRate:tempOptions.frameRate},optional:[]},tempOptions.sourceId&&(userMedia.optional[0]={sourceId:tempOptions.sourceId}),"plugin"===window.webrtcDetectedType&&delete userMedia.mandatory.maxFrameRate),{settings:options,userMedia:userMedia}},parseBandwidthConfig:function(options){return options="object"==typeof options?options:{},options.audio="number"==typeof options.audio?options.audio:this.defaultConfig.bandwidth.audio,options.video="number"==typeof options.video?options.video:this.defaultConfig.bandwidth.video,options.data="number"==typeof options.data?options.data:this.defaultConfig.bandwidth.data,options},parseMutedConfig:function(options){options="object"==typeof options?options:{audio:!1,video:!1};var updateAudioMuted="object"==typeof options.audio?!!options.audio.mute:!options.audio,updateVideoMuted="object"==typeof options.video?!!options.video.mute:!options.video;return{audioMuted:updateAudioMuted,videoMuted:updateVideoMuted}},parseDefaultConfig:function(options){options=options||{},log.debug("Parsing stream settings. Default stream options:",options),options.maxWidth="number"==typeof options.maxWidth?options.maxWidth:640,options.maxHeight="number"==typeof options.maxHeight?options.maxHeight:480,this.defaultConfig.video.resolution.width=options.maxWidth,this.defaultConfig.video.resolution.height=options.maxHeight,log.debug("Parsed default media stream settings",this.defaultConfig)}},StreamTrackList={audio:[],video:[],get:function(defer){"firefox"===window.webrtcDetectedBrowser?StreamTrackList.readyState="done":MediaStreamTrack.getSources(function(trackList){fn.forEach(trackList,function(track,i){var data={};data.label=track.label||track.kind+"_"+(i+1),data.kind=track.kind,data.id=track.id,data.facing=track.facing,"audio"===track.kind?StreamTrackList.audio.push(data):StreamTrackList.video.push(data)},function(){defer({audio:StreamTrackList.audio,video:StreamTrackList.video})})})}},UserEventReceivedHandler={peer:{connect:function(com,data){var peer=com.peers[data.id];"function"==typeof com.onaddconnection&&com.onaddconnection(peer),"offer"===peer.SDPType&&peer.createOffer()},iceconnectionstate:function(com,data){"main"===data.id&&"connected"===data.state&&com.handler("user:connect",{})},disconnect:function(com,data){var peer=com.peers[data.id];delete com.peers[data.id],"function"==typeof com.onremoveconnection&&com.onremoveconnection(peer),0===Object.keys(com.peers).length&&com.handler("user:disconnect",{})}},transfer:{complete:function(com,data){com.handler("user:data",data)},request:function(com,data){com.handler("user:datarequest",data)}}},UserEventResponseHandler={connect:function(com){"function"==typeof com.onconnect&&com.onconnect()},data:function(com){"function"==typeof com.ondata&&com.ondata()},datarequest:function(com){"function"==typeof com.ondatarequest&&com.ondatarequest()},update:function(com,data){"function"==typeof com.onupdate&&com.onupdate(data.data)},message:function(com){"function"==typeof com.onmessage&&com.onmessage()},disconnect:function(com){"function"==typeof com.ondisconnect&&com.ondisconnect()}},UserEventMessageHandler={enter:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)&&(data.bandwidth=com.bandwidth,data.SDPType="answer",com.addConnection(data,data.stream))},welcome:function(com,data){var peer=com.peers[data.prid];if(fn.isEmpty(peer))data.bandwidth=com.bandwidth,com.addConnection(data,data.stream),peer=com.peers[data.prid],peer.SDPType="offer";else{if(peer.weight<data.weight)return;peer.SDPType="offer",data.type="start"}},offer:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:offer",data)},answer:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:answer",data)},candidate:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:candidate",data)},restart:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:restart",data)},updateUserEvent:function(com,data){com.data=data.data,com.handler("user:update",{data:data.userData})},muteAudioEvent:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:muteAudioEvent",data)},muteVideoEvent:function(com,data){var peer=com.peers[data.prid];fn.isEmpty(peer)||peer.handler("message:muteVideoEvent",data)}},UserHandler=function(com,event,data,listener){var params=event.split(":");0===event.indexOf("message:")?fn.applyHandler(UserEventMessageHandler,params,[com,data,listener]):(0===event.indexOf("user:")?(data.id=com.id,fn.applyHandler(UserEventResponseHandler,params,[com,data,listener])):(data.userId=com.id,fn.applyHandler(UserEventReceivedHandler,params,[com,data,listener])),listener(event,data))};