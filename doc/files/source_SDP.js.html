<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="application-name" content="source/SDP.js - skylinkjs">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Skylink Javascript API documentation</title>
    <!-- font and icon -->
    <link rel="shortcut icon" type="image/ico" href="../assets/favicon.ico">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700|Source+Sans+Pro" type="text/css">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700|Source+Code+Pro" type="text/css">
    <!-- styling -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <!-- scripts -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="../assets/js/script.js"></script>
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>

<body>

<div id="wrapper">
  <!-- Sidebar -->
<a href="#menu-toggle" id="menu-toggle">
  <!-- Menu icon by Icons8 -->
  <img src="../assets/img/icons/menu.png">
  <!-- <a href="http://icons8.com">Icon pack by Icons8</a> -->
  </span>
</a>
<div id="sidebar-wrapper">
  <ul class="sidebar-nav">
    <li class="sidebar-brand">
      <a href="../" data="">
        <img src="../assets/img/logo.svg"><span>JS</span>
        <small>Version: 0.5.7</small>
      </a>
    </li>
    <hr>
    <li><a href="../" data="">Introduction</a></li>
    
      <li><a href="../classes/DataChannel.html"> DataChannel </a></li>
    
      <li><a href="../classes/Debugger.html"> Debugger </a></li>
    
      <li><a href="../classes/Peer.html"> Peer </a></li>
    
      <li><a href="../classes/Request.html"> Request </a></li>
    
      <li><a href="../classes/Room.html"> Room </a></li>
    
      <li><a href="../classes/Self.html"> Self </a></li>
    
      <li><a href="../classes/Skylink.html"> Skylink </a></li>
    
      <li><a href="../classes/Socket.html"> Socket </a></li>
    
      <li><a href="../classes/Stream.html"> Stream </a></li>
    
      <li><a href="../classes/User.html"> User </a></li>
    
  </ul>
</div>
<!-- /#sidebar-wrapper -->

<!--<form id="api-tabview" class="navbar-form navbar-right" role="form">
  <div id="api-tabview-filter" class="form-group">
    <input type="search" id="api-filter" placeholder="Type to filter APIs">
  </div>
</form>-->

  <!-- Page Content -->
  <div id="main-wrapper" class="container">
    
    <h1 class="file-heading">File: source/SDP.js</h1>
<p>You may view this code on github <a href="https://github.com/Temasys/SkylinkJS/blob/master/source/SDP.js">master branch</a> or on <a href="https://github.com/Temasys/SkylinkJS/blob/development/source/SDP.js">the current development branch</a>.</p>

<div class="file">
    <pre class="code prettyprint linenums">
var SDP = {
  /**
   * Finds a line in the sdp based on the condition provided
   * @property SDP.find
   * @type Function
   * @param {Array} sdpLines The sdp in array.
   * @param {Array} condition The beginning part of the sdp line. E.g. a=fmtp
   * @return {Array} [index, line] The sdp line.
   * @private
   * @for Skylink
   * @since 0.6.0
   */
  find: function(sdpLines, condition) {
    var i, j;
    
    for (i = 0; i &lt; sdpLines.length; i += 1) {
      for (j = 0; j &lt; condition.length; j += 1) {
        sdpLines[i] = sdpLines[i] || &#x27;&#x27;;

        if (sdpLines[i].indexOf(condition[j]) === 0) {
          return [i, sdpLines[i]];
        }
      }
    }
    
    return [];
  },
  
  /**
   * Enables the stereo feature if OPUS is enabled.
   * @property SDP.addStereo
   * @type Function
   * @param {Array} sdpLines Sdp received.
   * @return {Array} Updated version with Stereo feature
   * @private
   * @for Skylink
   * @since 0.6.0
   */
  addStereo: function(sdpLines) {
    var opusLineFound = false, opusPayload = 0;
    // Check if opus exists
    var rtpmapLine = this.find(sdpLines, [&#x27;a=rtpmap:&#x27;]);
    if (rtpmapLine.length) {
      if (rtpmapLine[1].split(&#x27; &#x27;)[1].indexOf(&#x27;opus/48000/&#x27;) === 0) {
        opusLineFound = true;
        opusPayload = (rtpmapLine[1].split(&#x27; &#x27;)[0]).split(&#x27;:&#x27;)[1];
      }
    }
    // Find the A=FMTP line with the same payload
    if (opusLineFound) {
      var fmtpLine = this.find(sdpLines, [&#x27;a=fmtp:&#x27; + opusPayload]);
      if (fmtpLine.length) {
        sdpLines[fmtpLine[0]] = fmtpLine[1] + &#x27;; stereo=1&#x27;;
      }
    }
    return sdpLines;
  },
  
  /**
   * Sets the audio, video and DataChannel data bitrate in the sdp.
   * - In low-environment cases, bandwidth is managed by the browsers
   *   and the quality of the resolution or audio may change to suit.
   * @property SDP.setBitrate
   * @type Function
   * @param {Array} sdpLines Sdp received.
   * @return {Array} Updated version with custom Bandwidth settings
   * @private
   * @for Skylink
   * @since 0.6.0
   */
  setBitrate: function (sdpLines, bandwidth) {
    // Find if user has audioStream
    var maLineFound = this.find(sdpLines, [&#x27;m=&#x27;, &#x27;a=&#x27;]).length;
    var cLineFound = this.find(sdpLines, [&#x27;c=&#x27;]).length;

    // Find the RTPMAP with Audio Codec
    if (maLineFound &amp;&amp; cLineFound) {
      if (bandwidth.audio) {
        var audioLine = this.find(sdpLines, [&#x27;a=audio&#x27;, &#x27;m=audio&#x27;]);
        
        if (!fn.isEmpty(audioLine)) {
          sdpLines.splice(audioLine[0], 1, audioLine[1], &#x27;b=AS:&#x27; + bandwidth.audio);
        }
      }
      
      if (bandwidth.video) {
        var videoLine = this.find(sdpLines, [&#x27;a=video&#x27;, &#x27;m=video&#x27;]);
        
        if (!fn.isEmpty(videoLine)) {
          sdpLines.splice(videoLine[0], 1, videoLine[1], &#x27;b=AS:&#x27; + bandwidth.video);
        }
      }
      
      if (bandwidth.data &amp;&amp; this._enableDataChannel) {
        var dataLine = this.find(sdpLines, [&#x27;a=application&#x27;, &#x27;m=application&#x27;]);
        
        if (!fn.isEmpty(dataLine)) {
          sdpLines.splice(dataLine[0], 1, dataLine[1], &#x27;b=AS:&#x27; + bandwidth.data);
        }
      }
    }
    return sdpLines;
  },
    
  /**
   * Set video stream resolution in the sdp.
   * - As noted, this is not working.
   * @property SDP.setResolution
   * @type Function
   * @param {Array} sdpLines Sdp received.
   * @return {Array} Updated version with custom Bandwidth settings
   * @private
   * @for Skylink
   * @since 0.6.0
   */
  setResolution: function (sdpLines) {
    var video = this._streamSettings.video;
    var frameRate = video.frameRate || 50;
    var resolution = video.resolution || {};
    var fmtpLine = this.find(sdpLines, [&#x27;a=fmtp:&#x27;]);
    if (fmtpLine.length){
        sdpLines.splice(fmtpLine[0], 1,fmtpLine[1] + &#x27;;max-fr=&#x27; + frameRate +
        &#x27;;max-recv-width=&#x27; + (resolution.width ? resolution.width : 640) +
        &#x27;;max-recv-height=&#x27; + (resolution.height ? resolution.height : 480));
    }
    return sdpLines;
  },
    
  /**
   * Removes the H264 preference in sdp because other browsers does not support it yet.
   * @property SDP.removeH264Support
   * @type Function
   * @param {Array} sdpLines Sdp received.
   * @return {Array} Updated version removing Firefox h264 pref support.
   * @private
   * @for Skylink
   * @since 0.6.0
   */
  removeH264Support: function (sdpLines) {
    var invalidLineIndex = sdpLines.indexOf(
      &#x27;a=fmtp:0 profile-level-id=0x42e00c;packetization-mode=1&#x27;);
    if (invalidLineIndex &gt; -1) {
      log.debug(&#x27;Firefox H264 invalid pref found:&#x27;, invalidLineIndex);
      sdpLines.splice(invalidLineIndex, 1);
    }
    return sdpLines;
  },
  
  /**
   * Modifies a local session description with the configuration provided
   * @property SDP.configure
   * @type Function
   * @param {Array} sdpLines Sdp received.
   * @return {String} Updated local session description.
   * @private
   * @for Skylink
   * @since 0.6.0
   */
  configure: function (sdp, config) {
    var sdpLines = sdp.split(&#x27;\r\n&#x27;);
    
    sdpLines = this.removeH264Support(sdpLines);

    if (config.stereo) {
      sdpLines = this.addStereo(sdpLines);
    }

    if (config.bandwidth) {
      sdpLines = this.setBitrate(sdpLines, config.bandwidth);
    }

    return sdpLines.join(&#x27;\r\n&#x27;);
  }
  
};
    </pre>
</div>

  </div>
  <!-- /#page-content-wrapper -->

</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
